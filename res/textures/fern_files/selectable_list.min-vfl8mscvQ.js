(function(){var e=[].slice;define(["jquery","external/underscore","external/react","external/immutable","external/keymaster","modules/clean/keycode","modules/clean/react/outside_event","modules/core/browser"],function(t,n,s,i,o,r,c,u){var d,l,a,h,p,f,m,I,g,_,S;return f=c.addOutsideEventHandling,a="",h=s.PropTypes,p=i.Record({selected:new i.OrderedSet,anchor:null}),g=function(e,t){return null==e&&(e=[]),null==t&&(t=null),new p({selected:new i.OrderedSet(e),anchor:t||e[0]})},l="up",d="down",S=function(e){return u.mac&&e.metaKey||!u.mac&&e.ctrlKey},m=function(){var t;return t=1<=arguments.length?e.call(arguments,0):[],function(){var e,s,i,o;for(o=[],s=0,i=t.length;i>s;s++)e=t[s],n.isFunction(e)&&o.push(e.apply(this,arguments));return o}},_=function(){var e;return"INPUT"===(e=document.activeElement.tagName)||"TEXTAREA"===e||"SELECT"===e||"BUTTON"===e},I=function(e){return e=f(e,"mouseup","onMouseUp","onOutsideMouseUp"),e=f(e,"mousedown","onMouseDown","onOutsideMouseDown"),s.createClass({displayName:"Selectable"+e.displayName,propTypes:{onSelectionChange:s.PropTypes.func,selection:s.PropTypes.instanceOf(p),defaultSelection:s.PropTypes.instanceOf(p),keyScope:s.PropTypes.string,linkedOutsideClasses:s.PropTypes.array},getDefaultProps:function(){return{onSelectionChange:n.noop,selection:null,defaultSelection:new p,keyScope:"SelectableList",linkedOutsideClasses:[]}},getInitialState:function(){return{isSelecting:!1,mostRecentMousedownTarget:null,selection:this.props.defaultSelection}},componentWillMount:function(){return this._focusedItem=null,this.isFocused=!1},componentDidMount:function(){return this._setupKeyboardShortcuts(),this._focusItem(this._selection().anchor),t(this.getDOMNode()).on("focusin.SelectableList",this.getFocusHandler(!0)).on("focusout.SelectableList",this.getFocusHandler(!1))},componentDidUpdate:function(e){var t,n;return(null!=(t=e.selection)?t.anchor:void 0)!==(null!=(n=this.props.selection)?n.anchor:void 0)&&this._selection().selected.size&&(this._focusedItem=this._selection().anchor),this._focusedItem?(this._focusItem(this._focusedItem),this._focusedItem=null):void 0},componentWillUnmount:function(){return a!==this.props.keyScope&&(key.clearScope(this.props.keyScope),key.setScope(a)),t(this.getDOMNode()).off(".SelectableList")},getFocusHandler:function(e){return function(t){return function(){return t.isFocused=e,!0}}(this)},_setupKeyboardShortcuts:function(){var e,t,n,s,i,o,r,c,h;return a=key.getScope(),a!==this.props.keyScope&&key.setScope(this.props.keyScope),o=function(e){return function(t){return e.isFocused&&"BUTTON"!==t.target.tagName}}(this),i=function(e){return function(){return document.activeElement===document.body||e.getDOMNode().contains(document.activeElement)}}(this),s=function(e,t){return function(n){return e(n)?(n.preventDefault(),t(n)):null}},h=function(e){return function(){return e._selectNeighboringItem({direction:l})}}(this),n=function(e){return function(){return e._extendSelectionRange({direction:l})}}(this),c=function(e){return function(){return e._selectNeighboringItem({direction:d})}}(this),t=function(e){return function(){return e._extendSelectionRange({direction:d})}}(this),r=function(e){return function(){return e._selectAllItems()}}(this),e=function(e){return function(){return e._deselectAllItems()}}(this),key("up",this.props.keyScope,s(i,h)),key("shift+up",this.props.keyScope,s(i,n)),key("down",this.props.keyScope,s(i,c)),key("shift+down",this.props.keyScope,s(i,t)),key("escape",this.props.keyScope,s(i,e)),u.mac?key("command+a",this.props.keyScope,s(o,r)):key("ctrl+a",this.props.keyScope,s(o,r))},_focusItem:function(e){var t;return t=this.refs[e],t?t.getDOMNode().focus():void 0},_itemIds:function(){var e;return e=[],s.Children.forEach(this.props.children,function(){return function(t){return(null!=t?t.key:void 0)?e.push(t.key):void 0}}(this)),i.List(e)},_selection:function(){return this.props.selection?this.props.selection:this.state.selection},_updateState:function(e){return i.is(this._selection(),e)?void 0:(this.props.selection||this.setState({selection:e}),this.props.onSelectionChange(e))},_selectAllItems:function(){return this.setSelectedItems({itemIds:this._itemIds().toArray()})},_deselectAllItems:function(){return this.setSelectedItems({itemIds:[]})},_toggleItemSelected:function(e){var t,n,s,i,o,r,c,u,d,l,a;if(s=e.itemId,a=this._selection(),a.selected.has(s)){for(a=a.update("selected",function(e){return e.delete(s)}),c=null,t=this._itemIds().indexOf(s),n=o=u=t+1,d=this._itemIds().count();d>=u?d>o:o>d;n=d>=u?++o:--o)if(i=this._itemIds().get(n),a.selected.has(i)){c=i;break}if(!c)for(n=r=l=t-1;0>=l?0>=r:r>=0;n=0>=l?++r:--r)if(i=this._itemIds().get(n),a.selected.has(i)){c=i;break}c||(c=this._itemIds().get(0)),a=a.set("anchor",c)}else a=a.update("selected",function(e){return e.add(s)}).set("anchor",s);return this._updateState(a)},_selectItemsInRangeTo:function(e){var t,n,s,i,o,r,c,u,d,l,a,h,p;return r=e.itemId,h=this._selection(),(t=null!=(l=h.anchor)?l:this._itemIds().get(0))?(n=this._itemIds().indexOf(t),d=this._itemIds().indexOf(r),a=this._rangeOfSelectedBlockSurrounding(t),p=a.startIndex,s=a.endIndex,c=function(){var e,t,n,r;for(n=this._itemIds().toArray(),r=[],o=e=0,t=n.length;t>e;o=++e)i=n[o],o>=p&&s>=o&&r.push(i);return r}.call(this),u=function(){var e,t,s,r;for(s=this._itemIds().toArray(),r=[],o=e=0,t=s.length;t>e;o=++e)i=s[o],(o>=d&&n>=o||o>=n&&d>=o)&&r.push(i);return r}.call(this),n>d&&u.reverse(),h=h.update("selected",function(e){return e.subtract(c).union(u)}),this._updateState(h)):void 0},_selectNeighboringItem:function(e){var t,n,s,i;return t=e.direction,s=this._itemIds().indexOf(this._selection().selected.last()),n=0,t===l?n=Math.max(0,s-1):t===d&&(n=Math.min(this._itemIds().count()-1,s+1)),i=this._itemIds().get(n),this._focusedItem=i,this.setSelectedItems({itemIds:[i]})},_extendSelectionRange:function(e){var t,n,s,i,o,r,c,u,a;return s=e.direction,u=o=this._selection(),(t=null!=(r=u.anchor)?r:this._itemIds().get(0))?(n=this._itemIds().indexOf(t),c=this._rangeOfSelectedBlockSurrounding(t),a=c.startIndex,i=c.endIndex,s===l?n===i?a-1>=0&&(u=u.update("selected",function(e){return function(t){return t.add(e._itemIds().get(a-1))}}(this))):u=u.update("selected",function(e){return function(t){return t.delete(e._itemIds().get(i))}}(this)):s===d&&(n===a||n!==i?i+1<this._itemIds().count()&&(u=u.update("selected",function(e){return function(t){return t.add(e._itemIds().get(i+1))}}(this))):u=u.update("selected",function(e){return function(t){return t.delete(e._itemIds().get(a))}}(this))),u!==o?(this._focusedItem=u.selected.last(),this._updateState(u)):void 0):void 0},_rangeOfSelectedBlockSurrounding:function(e){var t,n,s,i;for(n=this._itemIds().indexOf(e);;)if(i=n,n-=1,0>n||!this._selection().selected.has(this._itemIds().get(n)))break;for(n=i;;){if(s=this._itemIds().get(n),null==s||!this._selection().selected.has(s))break;t=n,n+=1}return{startIndex:i,endIndex:t}},setSelectedItems:function(e){var t,n,s;return n=e.itemIds,s=this._selection().set("selected",i.OrderedSet(n)),t=n.length>0?n[0]:this._itemIds().get(0),this._updateState(s.set("anchor",t))},handleMouseEnterRow:function(e){return this.state.isSelecting?this._selectItemsInRangeTo({itemId:e}):void 0},handleMouseDownInRow:function(e,t,n){return 2===n.button?void(this._selection().selected.has(e)||this.setSelectedItems({itemIds:[e]})):n.shiftKey?void this._selectItemsInRangeTo({itemId:e}):S(n)?void this._toggleItemSelected({itemId:e}):(this._selection().selected.has(e)||(this.setSelectedItems({itemIds:[e]}),this.setState({isSelecting:!0})),this.setState({mostRecentMousedownTarget:e}))},handleMouseUpInRow:function(e){return e===this.state.mostRecentMousedownTarget&&this.setSelectedItems({itemIds:[e]}),this.setState({isSelecting:!1})},handleClickInRow:function(){},handleOutsideMouseUp:function(e){return this.setState({isSelecting:!1}),this.getDOMNOde===e.target||this.getDOMNode().contains(e.target)||t(e.target).closest(this.props.linkedOutsideClasses.join()).length||this.state.mostRecentMousedownTarget?void 0:(this._deselectAllItems(),this.getDOMNode().contains(document.activeElement)?document.activeElement.blur():void 0)},handleOutsideMouseDown:function(){return this.setState({mostRecentMousedownTarget:null})},render:function(){var t,i,o;return t=s.Children.map(this.props.children,function(e){return function(t,n){var i;return(null!=t?t.key:void 0)?(i=t.key,s.addons.cloneWithProps(t,{ref:i,isDragAndDropEnabled:t.props.isDragAndDropEnabled&&!e.state.isSelecting,isSelected:e._selection().selected.has(i),onClick:m(t.props.onClick,e.handleClickInRow.bind(null,i,n)),onMouseEnter:m(t.props.onMouseEnter,e.handleMouseEnterRow.bind(e,i,n)),onMouseDown:m(t.props.onMouseDown,e.handleMouseDownInRow.bind(e,i,n)),onMouseUp:m(t.props.onMouseUp,e.handleMouseUpInRow.bind(e,i,n))})):t}}(this)),i=Object.keys(this.constructor.propTypes),o=n.extend({},n.omit(this.props,i),{selection:this._selection(),onOutsideMouseUp:this.handleOutsideMouseUp,onOutsideMouseDown:this.handleOutsideMouseDown}),s.createElement(e,o,t)}})},{createSelectableList:I,createSelection:g}})}).call(this);