(function(){define("modules/clean/activity/file_viewer_state",["modules/clean/activity/activity","modules/clean/comments/models/preview_types","modules/clean/comments/utils"],function(t,e,n){var o,i;return o=t.ActivityContext,i=function(){function t(t,e,n){null==n&&(n=null),this._file=null,this._url=e,this._fileActivity=null,this._latestRevision=null,this._currentRevision=null,t?(this.setFile(t),this._previewType=t.preview_type):n&&(this._previewType=n)}return t.prototype.setFile=function(t){return this._file=t},t.prototype.setFileActivity=function(t){return this._fileActivity=t,this._latestRevision=this._currentRevision=this._fileActivity.latestRevision},t.prototype.getPreviewType=function(t){return n.getPreviewType(t,this._previewType)},t.prototype.isAnnotationReadyFile=function(t){return null!=this.getPreviewType(t)},t.prototype.isImagePreviewFile=function(t){return this.getPreviewType(t)===e.IMAGE},t.prototype.isCurrentlyAtLatestRevision=function(){return null!=this._latestRevision&&null!=this._currentRevision?this._latestRevision.when===this._currentRevision.when:!1},t.prototype.isCurrentlyAtRevision=function(t){return null!=t&&null!=this._currentRevision?t.when===this._currentRevision.when:!1},t.prototype.isLatestRevision=function(t){return null!=t&&null!=this._latestRevision?t.when===this._latestRevision.when:!1},t.prototype.isOldRevision=function(t){return!this.isLatestRevision(t)},t.prototype.getLatestRevision=function(){return this._latestRevision},t.prototype.getCurrentRevision=function(){return this._currentRevision},t.prototype.setCurrentRevision=function(t){return this._currentRevision=t},t}(),{FileViewerState:i}})}).call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e=function(t,e){function o(){this.constructor=t}for(var i in e)n.call(e,i)&&(t[i]=e[i]);return o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype,t},n={}.hasOwnProperty;define("modules/clean/bolt",["jquery","external/underscore","modules/constants/env","modules/core/exception","modules/core/uri"],function(n,o,i,s){var r,a,l,c,u,d,p,h,m,f,_;return r=1e3,a=3e5,p="/2/notify/subscribe",h="/2/payloads/subscribe",u=function(){function t(t,e){this.app_id=t,this.unique_id=e}return t}(),f=function(){function t(t,e,n,o){this.app_id=t,this.unique_id=e,this.revision=n,this.token=o}return t}(),m=function(){function t(t,e){this.revision=t,this.payload=e}return t}(),d=function(){function t(t,e){this.channel_state=t,this.payloads=e}return t}(),l=function(){function e(e,n,o){this._update_callback=n,this._refresh_callback=o,this._handle_poll_error=t(this._handle_poll_error,this),this._handle_poll_success=t(this._handle_poll_success,this),this._must_find_state=t(this._must_find_state,this),this._long_poll=t(this._long_poll,this),this._find_state=t(this._find_state,this),this._signed_channel_states=[],this._started=!1,this._backoff_window=r,this._additional_headers={},this.update_states(e)}return e.prototype._encode_channel_state=function(t){return{channel_id:{app_id:t.app_id,unique_id:t.unique_id},revision:t.revision,token:t.token}},e.prototype._decode_channel_state=function(t){return new f(t.channel_id.app_id,t.channel_id.unique_id,t.revision,t.token)},e.prototype._decode_channel_id=function(t){return new u(t.app_id,t.unique_id)},e.prototype._compare_revisions=function(t,e){var n,o,i;return n=Math.max(t.length,e.length),o=Array(n-t.length+1).join("0")+t,i=Array(n-e.length+1).join("0")+e,i>o?-1:o>i?1:0},e.prototype._find_state=function(t){return o.find(this._signed_channel_states,function(e){return o.isEqual(t,e.channel_id)})},e.prototype.update_states=function(t){var e,n,o,i,s;for(s=[],e=0,n=t.length;n>e;e++)i=t[e],i=this._encode_channel_state(i),o=this._find_state(i.channel_id),null==o?s.push(this._signed_channel_states.push(i)):this._compare_revisions(i.revision,o.revision)>=0?(o.revision=i.revision,s.push(o.token=i.token)):s.push(void 0);return s},e.prototype.start=function(){return this._started?void 0:(this._started=!0,this._long_poll())},e.prototype.unsubscribe=function(){return this._started=!1,null!=this._long_poll_xhr?this._long_poll_xhr.abort():void 0},e.prototype._long_poll=function(){return this._long_poll_xhr=n.ajax({url:this._subscribe_url(),type:"POST",noDropboxDefaults:!0,data:JSON.stringify({channel_states:this._signed_channel_states}),contentType:"application/json; charset=utf-8",headers:this._additional_headers,dataType:"json",timeout:12e4,success:this._handle_poll_success,error:this._handle_poll_error,xhrFields:{withCredentials:!0}})},e.prototype._must_find_state=function(t){var e,n;return n=this._find_state(t),null==n&&(e="Bolt returned unknown channel id "+t,s.assert(!1,e,null,null,!1)),n},e.prototype._handle_poll_data=function(){var t;return t="Method must be implemented.",s.assert(!1,t,null,null,!1)},e.prototype._subscribe_url=function(){return"https://"+i.BOLT_SERVER+this._subscribe_endpoint()},e.prototype._subscribe_endpoint=function(){var t;return t="Method must be implemented.",s.assert(!1,t,null,null,!1)},e.prototype._handle_poll_success=function(t,e,n){var i,s,a;return this._long_poll_xhr=null,this._started?(a=this._handle_poll_data(t,e,n),a.length>0&&o.defer(this._update_callback,a),(null!=(s=t.invalid_channels)?s.length:void 0)>0?void o.defer(this._refresh_callback,function(){var e,n,o,s;for(o=t.invalid_channels,s=[],e=0,n=o.length;n>e;e++)i=o[e],s.push(this._decode_channel_id(i));return s}.call(this)):(this._backoff_window=r,o.defer(this._long_poll))):void 0},e.prototype._handle_poll_error=function(){var t;return this._long_poll_xhr=null,this._started?(t=Math.random()*this._backoff_window,this._backoff_window=Math.min(2*this._backoff_window,a),window.setTimeout(this._long_poll,t)):void 0},e}(),c=function(n){function o(e,n,i){this._handle_poll_data=t(this._handle_poll_data,this),o.__super__.constructor.call(this,e,n,i)}return e(o,n),o.prototype._subscribe_endpoint=function(){return p},o.prototype._handle_poll_data=function(t){var e,n,o,i,s,r;if(r=[],null!=t.channel_states)for(s=t.channel_states,e=0,n=s.length;n>e;e++)i=s[e],o=this._must_find_state(i.channel_id),this._compare_revisions(i.revision,o.revision)>0&&(o.revision=i.revision,o.token=i.token,r.push(this._decode_channel_state(i)));return r},o}(l),_=function(n){function o(e,n,i){this._handle_poll_data=t(this._handle_poll_data,this),o.__super__.constructor.call(this,e,n,i)}var i;return e(o,n),i="X-Bolt-Session",o.prototype.unsubscribe=function(){return this._additional_headers[i]=null,o.__super__.unsubscribe.call(this)},o.prototype._subscribe_endpoint=function(){return h},o.prototype._handle_poll_data=function(t,e,n){var o,s,r,a,l,c,u,p,h,f,_,v,y;if(y=[],this._additional_headers={},this._additional_headers[i]=n.getResponseHeader(i),null!=t.channel_payloads)for(_=t.channel_payloads,r=0,l=_.length;l>r;r++){for(o=_[r],p=o.channel_state,u=this._must_find_state(p.channel_id),s=this._decode_channel_state(o.channel_state),f=[],v=o.payloads,a=0,c=v.length;c>a;a++)h=v[a],this._compare_revisions(h.revision,u.revision)>0&&f.push(new m(h.revision,h.payload));f.length>0&&y.push(new d(s,f)),this._compare_revisions(p.revision,u.revision)>0&&(u.revision=p.revision,u.token=p.token)}return y},o}(l),{BoltClient:c,ThunderClient:_,ChannelId:u,SignedChannelState:f,Payload:m,ChannelPayloads:d}})}.call(this),function(){var t=[].slice;define("modules/clean/comments/action_creators",["external/underscore","external/react","modules/clean/account/email","modules/clean/account/email_verify_reasons","modules/clean/activity/activity","modules/clean/comments/actions","modules/clean/comments/events","modules/clean/comments/logged_out_utils","modules/clean/comments/models/immutable_file_activity","modules/clean/comments/models/pending_comment_activity","modules/clean/comments/store","modules/clean/comments/utils","modules/clean/file_activity/api","modules/clean/file_activity/clients/file_activity_data_source","modules/clean/promise","modules/clean/react/file_comments/onboarding","modules/clean/react/file_comments/shared_link_signup_modals","modules/clean/react/modal","modules/clean/storage","modules/constants/legacy","modules/core/exception","modules/core/i18n","modules/core/notify"],function(e,n,o,i,s,r,a,l,c,u,d,p,h,m,f,_,v,y,g,b,w,T,C){var S,A,I,x,P,N,k,E,R,O,D,M,L,U,F,B,H,K,V,q,G,W,j;return A=o.EmailVerification,S=s.Activity,P=f.Promise,x=y.Modal,I=g.LocalStorage,L=w.assert,N=T._,B=function(t,e,n){return null==n&&(n=!1),c.prototype.findActivityByKey.call(t,e,n)},K=function(t){var e,n,o,i,s,r,a,l,c;return c=t.targetActivityKey,s=t.pendingCommentActivity,n=d.state.activity.activity_key,o=c===n?null:c,l=s.comment,a=l.raw_comment_text,e=l.comment_metadata,r=h.addComment({actorId:d.state.actorId,context:d.state.viewing.context,contextData:d.state.viewing.contextData,commentActivityKey:o,text:a,metadata:null!=e?e.toMetadataDict():void 0,oref:d.state.oref}),i=s.activity_key,"PENDING"!==s.status&&m.getInstance().modify(function(t){return t.updateActivityStatus(i,"PENDING")}),r.then(function(t){return m.getInstance().modify(function(e){return e.purgeActivity(i).appendActivity(c,t)})}).catch(function(t){return m.getInstance().modify(function(t){return t.updateActivityStatus(i,"FAILED")}),P.reject(t)})},k=function(e){var n,o,s,r,c,h,f,_,y,g;return y=e.targetActivityKey,g=e.text,h=e.metadata,n=p.getActivityUser(d.state.actorId),s=d.state.activity,r=s.activity_key,c=y===r?null:y,n.is_signed_in?n.is_email_verified?(f=u.build({activityUser:n,text:g,metadata:h}),_=K({targetActivityKey:y,pendingCommentActivity:f}),m.getInstance().modify(function(t){return t.appendActivity(y,f)}),f):(o=A.get_for_user(n),A.set_should_use_simple_ui(!1),void o.show_verify_modal(null,i.ADD_COMMENT)):(l.saveActionCreator({name:"addComment",fileActivityKey:r,args:t.call(arguments)}),a.emit("show-sign-up-modal",{fileActivityKey:r,variant:v.POST_COMMENT_VARIANT}),l.logSignUpModal({fileActivityKey:r,commentActivityKey:c,originType:b.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.POST_BUTTON}),void I.set("tmp-file-comment",null))},D=function(t){var e,n,o,i;return o=t.targetActivityKey,i=t.text,e=null!=(n=t.metadata)?n:{},k({targetActivityKey:o,text:i,metadata:e})},O=function(t){var e,n,o,i,s;return s=t.text,e=null!=(o=d.state.createAnnotation)?o.annotation:void 0,i=d.state.activity,L(null!=e,"Cannot add comment with annotation because no annotation is in creation."),r.stopAnnotationCreation(),n=k({targetActivityKey:i.activity_key,text:s,metadata:{annotation:e.toMetadataDict(),revision:i.latestRevision}}),r.highlightComment({activityKey:n.activity_key})},M=function(t){var e,n;return n=t.targetActivityKey,e=t.stickerId,k({targetActivityKey:n,text:null,metadata:{stickers:{id:e}}})},U=function(t){var e,n;return e=t.commentActivityKey,L(null!=B(d.state.activity,e),"Comment activity to delete does not exist: "+e),n=h.deleteComment({actorId:d.state.actorId,context:d.state.viewing.context,contextData:d.state.viewing.contextData,commentActivityKey:e,oref:d.state.oref}),m.getInstance().modify(function(t){return t.updateDeleteActivity(e,!0)}),n.catch(function(t){return m.getInstance().modify(function(t){return t.updateDeleteActivity(e,!1)}),P.reject(t)})},q=function(t){var e,n,o,i,s;return n=t.commentActivityKey,s=t.resolved,e=B(d.state.activity,n),L(null!=e,"Comment activity to resolve/unresolve does not exist: "+n),i=h.updateResolveComment({actorId:d.state.actorId,context:d.state.viewing.context,contextData:d.state.viewing.contextData,commentActivityKey:n,resolved:s,oref:d.state.oref}),o=e.comment.resolved,m.getInstance().modify(function(t){return t.updateResolveActivity(n,s)}),i.catch(function(t){return m.getInstance().modify(function(t){return t.updateResolveActivity(n,o)}),P.reject(t)})},V=function(e){var n,o,i,s,r,c,u,f;return i=e.commentActivityKey,c=e.liked,n=p.getActivityUser(d.state.actorId),s=d.state.activity,r=s.activity_key,o=B(s,i),L(null!=o,"Comment activity to like/unlike does not exist: "+i),n.is_signed_in?(f=h.updateLikeComment({actorId:d.state.actorId,context:d.state.viewing.context,contextData:d.state.viewing.contextData,commentActivityKey:i,liked:c,oref:d.state.oref}),u=S.prototype.isLikedBy.call(o,d.state.actorId),m.getInstance().modify(function(t){return t.updateLikeActivity(i,c,n)}),f.catch(function(t){return m.getInstance().modify(function(t){return t.updateLikeActivity(i,u,n)}),P.reject(t)})):(l.saveActionCreator({name:"setCommentLiked",fileActivityKey:r,args:t.call(arguments)}),a.emit("show-sign-up-modal",{fileActivityKey:r,variant:v.LIKE_COMMENT_VARIANT}),void l.logSignUpModal({fileActivityKey:r,commentActivityKey:i,originType:b.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.LIKE_BUTTON}))},W=function(t){var e,n,o;return e=t.enabled,o=h.updateCommentSetting({actorId:d.state.actorId,context:d.state.viewing.context,contextData:d.state.viewing.contextData,enableComment:e,oref:d.state.oref}),n=d.state.activity.feedback_off,m.getInstance().modify(function(t){return t.updateEnableActivity(e)}),o.catch(function(t){return m.getInstance().modify(function(t){return t.updateEnableActivity(n)}),P.reject(t)})},G=function(e){var n,o,s,r,c;return c=e.subscribed,n=p.getActivityUser(d.state.actorId),s=d.state.activity.activity_key,n.is_signed_in?n.is_email_verified?(r=h.updateFileActivitySubscription({actorId:d.state.actorId,context:d.state.viewing.context,contextData:d.state.viewing.contextData,targetUserEmail:null,subscribed:c,oref:d.state.oref}),c?r.then(function(){return C.success(N("You have been subscribed."))}).catch(function(t){return C.error(N("We failed to unsubscribe you.")),P.reject(t)}):r.then(function(){return C.success(N("You have been unsubscribed."))}).catch(function(t){return C.error(N("We failed to unsubscribe you.")),P.reject(t)})):(o=A.get_for_user(n),A.set_should_use_simple_ui(!1),void o.show_verify_modal(null,i.SUBSCRIBE_TO_COMMENTS)):(l.saveActionCreator({name:"setCommentSubscribed",fileActivityKey:s,args:t.call(arguments)}),a.emit("show-sign-up-modal",{fileActivityKey:s,variant:v.SUBSCRIBE_VARIANT}),void l.logSignUpModal({fileActivityKey:s,originType:b.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.SUBSCRIBE_BUTTON}))},H=function(t){var e,n,o,i,s;return o=t.lastSeenActivityKey,e=d.state.activity,n=p.getActivityUser(d.state.actorId),n.is_signed_in&&null!=e&&!e.feedback_off&&o!==e.lastSeenActivityKey?(i=e.lastSeenActivityKey,m.getInstance().modify(function(t){try{return t.markCommentsSeen(o)}catch(e){return t}}),s=h.markCommentsSeen({isBackgroundRequest:!0,actorId:d.state.actorId,context:d.state.viewing.context,contextData:d.state.viewing.contextData,commentActivityKey:o}),s.catch(function(){return m.getInstance().modify(function(t){try{return t.markCommentsSeen(i)}catch(e){return t}})})):void 0},E=function(t){var e,n;return n=d.state.activity,e=p.getActivityUser(d.state.actorId),r.receiveFileActivity(t),e.is_signed_in&&null==n&&null!=t&&l.replayActionCreators({actionCreators:F,fileActivityKey:t.activity_key}),d.state.isPreviewReady&&null==n?a.emit("preview-and-comments-ready"):void 0},R=function(){var t,e;return t=d.state.actorId,e=n.createElement(_,{onOpen:function(){return r.setShouldShowOnboarding(!1),h.markCommentingOnboardingSeen({actorId:t}).catch(function(){})}}),x.showInstance(e)},j=function(){var t,e,n,o,i,s;if(t=d.state.actorId,s=d.state.shouldShowOnboarding,i=d.state.viewing,e=i.context,n=i.file,o=p.getPreviewType(e,null!=n?n.preview_type:void 0),null!=t&&null!=o){if(null==s)return h.shouldShowCommentingOnboarding({actorId:t}).then(function(t){return r.setShouldShowOnboarding(t),t?R():void 0}).catch(function(){});if(s===!0)return R()}},m.getInstance(),a.on("file-activity-updated",E),F=e.extend({},r,{addComment:D,addAnnotationComment:O,addStickerComment:M,postPendingComment:K,deleteComment:U,setCommentLiked:V,setCommentResolved:q,setCommentSubscribed:G,setCommentsEnabled:W,markCommentsSeen:H,showOnboardingIfNecessary:j})})}.call(this),function(){define("modules/clean/comments/actions",["external/underscore","external/reflux"],function(t,e){return e.createActions(t.object(t.map(["stopViewingComments","showResolvedComments","hideResolvedComments","showAnnotationConversation","hideAnnotationConversation","cancelHideAnnotationConversationDelayed","showAnnotationInput","hideAnnotationInput","updateAnnotationText","updateAnnotationReplyText","startAnnotationCreation","stopAnnotationCreation","notifyPreviewReady","switchRevision","startViewingComments","hideAnnotationConversationDelayed","revealAnnotation","receiveFileActivity","showComments","hideComments","highlightComment","switchTabs","setShouldShowOnboarding"],function(t){return[t,{sync:!0}]})))})}.call(this),function(){define("modules/clean/comments/annotation_utils",["modules/clean/annotations/annotation","modules/core/exception"],function(t,e){var n,o,i,s,r,a,l,c,u,d,p,h;return a=t.Annotation,u=e.assert,i=120,s=10,r=320,o=10,n=28,l=30,c=2,h=function(t,e){var n,o,i,s;return n=t.getBoundingBox(),o=window.getComputedStyle(e),s=o.width,i=o.height,n.top>=i||n.left>=s||n.right<0||n.bottom<0},d=function(t,e){var l,d,p,h,m,f,_,v,y,g,b,w,T,C,S,A,I,x,P,N,k,E;N=e.getBoundingClientRect(),E=N.width,k=N.height,g=function(t,e,n){return null==e&&(e=null),null==n&&(n=null),u(null!==e||null!==n,"doesBubbleFitOnScreen needs a top or bottom value"),n&&(e=-n-i),t>=0&&E-r>t&&e>=0&&k-i>e},b=function(t,e){return"down"===e?k-t-s:-t-s},C=0,T=0,t.isImageAnnotation()&&(C=N.top+document.body.scrollTop,T=N.left+document.body.scrollLeft),l=t.getClampedBoundingBox(E,k,T,C),d=a.getCenterPosition(l),p=l.bottom-l.top,y={up:l.top*c,down:k-l.bottom,left:l.left,right:E-l.right},w=0,S="up";for(v in y)A=y[v],A>w&&(S=v,w=A);return"up"===S&&(m=d.x-r/2,_=-l.bottom+p+o,h="bottom",g(m,null,_))?[h,{x:m,y:_},b(_,"up")]:"down"===S&&(m=d.x-r/2,f=l.bottom+o,h="top",g(m,f))?[h,{x:m,y:f},b(f,"down")]:(y.left>y.right?(h="right",m=l.left-r-o):(h="left",m=l.right+o),P="down",I=k-l.top,x=l.bottom,x>I&&(P="up"),"down"===P&&r>I&&x>I&&(P="up"),"down"===P&&(h+="-top",f=d.y-n,f=Math.max(0,f),g(m,f))?[h,{x:m,y:f},b(f,"down")]:(h+="-bottom",_=-d.y-n,_=Math.max(-k+1,_),g(m,null,_)?[h,{x:m,y:_},b(_,"up")]:(m=d.x-r/2,f=d.y+o,g(m,f)?["top",{x:m,y:f},b(f,"down")]:(f=o,g(m,f)?["top",{x:m,y:f},b(f,"down")]:(m=0,f=o,g(m,f)?["top",{x:m,y:f},b(f,"down")]:[null,{x:null,y:null},null])))))},p=function(t,e,n){var o,s,a;switch(o=0,s=0,a=t,t){case"top":o=(r-l)/2;break;case"left-top":a="left",s=i/8;break;case"right-top":o=r-l,s=i/8,a="right";break;case"left-bottom":a="left",s=i/8;break;case"right-bottom":o=r-l,s=i/8,a="right";break;case"bottom":o=(r-l)/2}return[a,{x:e+o,y:n+s}]},{isAnnotationOffscreen:h,getBubblePosition:d,getExpandBubblePosition:p}})}.call(this),function(){define("modules/clean/comments/components/file_comments_pane_container",["external/underscore","external/react","external/reflux","modules/core/exception","modules/clean/comments/action_creators","modules/clean/comments/components/file_preview_annotations","modules/clean/comments/components/file_preview_overlay","modules/clean/comments/events","modules/clean/comments/flux","modules/clean/comments/store","modules/clean/comments/utils","modules/clean/event_emitter","modules/clean/file_viewer_interface_controller","modules/clean/react/file_comments/file_comments_pane","modules/clean/react/file_comments/shared_link_signup_modals","modules/clean/react/file_comments/switch_revision_ui"],function(t,e,n,o,i,s,r,a,l,c,u,d,p,h,m,f){var _,v,y,g,b;return b=o.assert,v=h.FileCommentsPaneClass,_="annotation-overlay",g="switch-revision-container",y=e.createClass({displayName:"FileCommentsPaneContainer",mixins:[l.connect(c)],propTypes:{actorId:e.PropTypes.number,context:e.PropTypes.number,contextData:e.PropTypes.string,currentFile:e.PropTypes.object,oref:e.PropTypes.string,previewSelector:e.PropTypes.string.isRequired,shouldInitiallyFocusInput:e.PropTypes.bool,initialCommentsCount:e.PropTypes.number,isCollapsed:e.PropTypes.bool,shouldTrackCollapsedState:e.PropTypes.bool},getDefaultProps:function(){return{shouldTrackCollapsedState:!0}},componentWillMount:function(){return null!=this.props.context&&null!=this.props.contextData?this.onViewingFileWillChange(this.props):void 0},componentDidMount:function(){return this.initAnnotationReadyQueue(),this.initSignUpModalIfNecessary(),i.showOnboardingIfNecessary(),a.on("preview-and-comments-ready",this.onPreviewAndCommentsReady),a.on("revision-did-change",this.onViewingRevisionDidChange),a.on("reveal-annotation",this.onRevealAnnotation),a.on("show-sign-up-modal",this.onShowSignUpModal)},componentWillReceiveProps:function(t){return this.state.viewing.contextData!==t.contextData?this.onViewingFileWillChange(t):void 0},componentWillUnmount:function(){return a.off("preview-and-comments-ready",this.onPreviewAndCommentsReady),a.off("revision-did-change",this.onViewingRevisionDidChange),a.off("reveal-annotation",this.onRevealAnnotation),a.off("show-sign-up-modal",this.onShowSignUpModal),this.clearAnnotationReadyQueue(),this.onViewingFileWillClose()},onViewingFileWillChange:function(t){return this.isAnnotationReady=!1,this.unmountFilePreviewComponents(),i.startViewingComments({actorId:t.actorId,context:t.context,contextData:t.contextData,oref:t.oref,file:t.currentFile,previewSelector:t.previewSelector,shouldTrackCollapsedState:t.shouldTrackCollapsedState}),this.asyncMountFilePreviewComponents()},onViewingFileWillClose:function(){return this.isAnnotationReady=!1,this.unmountFilePreviewComponents(),this.unmountSwitchRevisionUI(),i.stopViewingComments()},onViewingRevisionDidChange:function(){return this.isAnnotationReady=!1,this.renderSwitchRevisionUI(),this.unmountFilePreviewComponents(),this.asyncMountFilePreviewComponents()},onPreviewAndCommentsReady:function(){return b(null!=this.fileViewerInterfaceController,"File viewer interface controller is not initialized"),this.unmountFilePreviewAnnotations(),this.unmountFilePreviewOverlay(),this.mountFilePreviewAnnotations(),this.mountFilePreviewOverlay(),this.isAnnotationReady=!0,this.processAnnotationReadyQueue()},renderSwitchRevisionUI:function(){return b(null!=this.state.activity,"Cannot render SwitchRevisionUI when file activity is not ready!"),e.render(e.createElement(f,{context:this.state.viewing.context,latestRevision:this.state.activity.latestRevision,showSwitchRevisionUI:!u.isRevisionEqual(this.state.viewing.revision,this.state.activity.latestRevision)}),this.getOrCreateSwitchRevisionUIContainer())},unmountSwitchRevisionUI:function(){var t;return t=this.getSwitchRevisionUIContainer(),null!=t?e.unmountComponentAtNode(t):void 0},getSwitchRevisionUIContainer:function(){return document.getElementById(g)},getOrCreateSwitchRevisionUIContainer:function(){var t;return t=this.getSwitchRevisionUIContainer(),null==t&&(t=document.createElement("div"),t.id=g,document.body.appendChild(t)),t},asyncMountFilePreviewComponents:function(){return this.createFileViewerInterfaceController()},unmountFilePreviewComponents:function(){var t;return this.unmountFilePreviewAnnotations(),this.unmountFilePreviewOverlay(),this.destroyFileViewerInterfaceController(),"function"==typeof(t=this.state).unsubscribePreviewAndCommentsReady?t.unsubscribePreviewAndCommentsReady():void 0},mountFilePreviewAnnotations:function(){return this.filePreviewAnnotations=s.create(),this.filePreviewAnnotations.mount(this.fileViewerInterfaceController,{shouldTrackCollapsedState:this.props.shouldTrackCollapsedState})},unmountFilePreviewAnnotations:function(){var t;return(null!=(t=this.filePreviewAnnotations)?t.isMounted():void 0)?this.filePreviewAnnotations.unmount():void 0},getOrCreateFilePreviewOverlayContainer:function(t){var e;return e=document.getElementById(_),e||(e=document.createElement("div"),e.id=_,t.appendChild(e)),e},mountFilePreviewOverlay:function(){var t,n;return(n=document.querySelector(this.props.previewSelector))?(this.overlayContainerNode=this.getOrCreateFilePreviewOverlayContainer(n),t=e.createElement(r,{previewContainer:n}),e.render(t,this.overlayContainerNode)):void console.error("Preview container does not exist!")},unmountFilePreviewOverlay:function(){return e.unmountComponentAtNode(this.overlayContainerNode)},createFileViewerInterfaceController:function(){var t,e,n;return n=c.state.viewing,t=n.context,e=n.file,this.fileViewerInterfaceController=new p(t,u.getPreviewType(t,e.preview_type),this.props.previewSelector),this.fileViewerInterfaceController.on("page-rendered",function(t){return function(e){var n;return n=null!=(null!=e?e.page:void 0),!n||n&&!t.state.isPreviewReady?i.notifyPreviewReady():void 0}}(this)),this.fileViewerInterfaceController.dispatchEvent("file-feedback-ui-ready")},destroyFileViewerInterfaceController:function(){var t;return null!=(t=this.fileViewerInterfaceController)?t.destroy():void 0},initAnnotationReadyQueue:function(){return this.annotationReadyQueue=new d},clearAnnotationReadyQueue:function(){return this.annotationReadyQueue.removeAllListeners()},processAnnotationReadyQueue:function(){return this.annotationReadyQueue.emit("reveal-annotation")},onRevealAnnotation:function(e){return this.isAnnotationReady?this.doRevealAnnotation(e):(this.annotationReadyQueue.removeAllListeners("reveal-annotation"),this.annotationReadyQueue.once("reveal-annotation",t.partial(this.doRevealAnnotation,e)))},doRevealAnnotation:function(t){return this.fileViewerInterfaceController.dispatchEvent("scroll-to-annotation",t)},onShowSignUpModal:function(t){var e,n;return e=t.fileActivityKey,n=t.variant,b(null!=this.signUpModal,"Sign-up modal not initialized!"),this.signUpModal.set_activity_key(e),this.signUpModal.show_sign_in_modal(n)},initSignUpModalIfNecessary:function(){return u.getActivityUser(this.state.actorId).is_signed_in?void 0:this.signUpModal=new m},getInitialCommentsCount:function(){var t,e;return null!=this.props.initialCommentsCount?this.props.initialCommentsCount:null!=(null!=(t=this.props.currentFile)?t.unresolved_comment_count:void 0)?null!=(e=this.props.currentFile)?e.unresolved_comment_count:void 0:null},render:function(){var t;return t=this.getInitialCommentsCount(),e.createElement(v,{ref:"fileCommentsPane",feedbackId:"file-comments",activity:this.state.activity,showLoadingSpinner:0!==t&&this.state.showLoadingSpinner,context:this.state.viewing.context,contextData:this.state.viewing.contextData,userId:this.state.actorId,file:this.props.currentFile,oref:this.state.oref,isPreviewReady:this.state.isPreviewReady,showResolvedComments:this.state.showResolvedComments,highlightedActivityKey:this.state.highlightedActivityKey,selectedTab:this.state.selectedTab,isCommentsHidden:this.props.shouldTrackCollapsedState?this.state.isCommentsHidden:this.props.isCollapsed,canCollapse:!0,enableImport:!1,previewSelector:this.props.previewSelector,shouldAutoLinkify:!0,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,shouldUseSimpleModals:!1,shouldTrackCollapsedState:this.props.shouldTrackCollapsedState,showButtonColor:"white",initialCommentsCount:t})}})})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define("modules/clean/comments/components/file_preview_annotations",["external/underscore","modules/constants/legacy","modules/core/exception","modules/clean/annotations/annotation","modules/clean/comments/action_creators","modules/clean/comments/events","modules/clean/comments/store","modules/clean/comments/utils","modules/clean/keycode","modules/clean/react/file_comments/logger","modules/clean/react/file_viewer/store","modules/clean/string","modules/clean/gandalf_util"],function(e,n,o,i,s,r,a,l,c,u,d,p,h){var m,f,_,v,y;return v=o.assert,f=i.Annotation,y=p.lispToPascalCase,m=["annotation-hidden","annotation-placed","annotation-start-drag","annotation-end-drag","page-rendered","annotation-ui-click","annotation-ui-enter","annotation-ui-leave","annotation-enter","annotation-leave","scale-change","scroll","on-keydown","reset-file-feedback-ui"],_=function(){function o(e){this.prevState=e.prevState,this.state=e.state,this.interfaceController=e.interfaceController,this.shouldTrackCollapsedState=e.shouldTrackCollapsedState,this.onScroll=t(this.onScroll,this),this.onAnnotationUiEnter=t(this.onAnnotationUiEnter,this),this.onAnnotationUiClick=t(this.onAnnotationUiClick,this),this.onAnnotationEndDrag=t(this.onAnnotationEndDrag,this),this.onAnnotationPlaced=t(this.onAnnotationPlaced,this),this.onStateChange=t(this.onStateChange,this)}return o.create=function(){return new o({prevState:{activityKeys:[],hasEphemeral:!1,isDisabled:!0,isAnnotationGhostEnabled:!1},state:{ephemeralAnnotation:null,isDisabled:!0,isAnnotationGhostEnabled:!1,commentActivityByKey:{},canAnnotate:!1},interfaceController:null,shouldTrackCollapsedState:!0})},o.prototype.setState=function(t){return e.extend(this.state,t),this.performUpdateIfNecessary()},o.prototype.reduceStoreState=function(t,n){var o,i,s,r,a,c,u;return v(null!=t.activity,"Cannot update FilePreviewAnnotations state when file activity is not ready!"),u=t.showResolvedComments,r=l.getActivityUser(t.actorId).is_signed_in,s=t.activity.feedback_off||t.isCommentsHidden,n.shouldTrackCollapsedState||(s=s||!n.areCommentsOpen),i=h.getGandalfRule("comments_annotation_ghost"),o=s?{}:t.activity.comment_activities.filter(function(t){var e;return t.isDeleted?!1:t.comment.resolved&&!u?!1:null==(null!=(e=t.comment.comment_metadata)?e.annotation:void 0)?!1:!0}),{activityKey:null!=(a=t.activity)?a.activity_key:void 0,actorId:t.actorId,activityContext:t.viewing.context,revision:t.viewing.revision,commentActivityByKey:e.indexBy(o,"activity_key"),ephemeralAnnotation:null!=(c=t.createAnnotation)?c.annotation:void 0,canAnnotate:r&&!s&&l.isRevisionEqual(t.viewing.revision,t.activity.latestRevision),showResolved:u,isAnnotationGhostEnabled:i}},o.prototype.onStateChange=function(){var t,e,n;return n=a.state,t=this.shouldTrackCollapsedState?{shouldTrackCollapsedState:!0}:{shouldTrackCollapsedState:!1,areCommentsOpen:d.areCommentsOpen()},e=this.reduceStoreState(n,t),this.setState(e)},o.prototype.mount=function(t,e){var n;return n=e.shouldTrackCollapsedState,v(null!=t,"Interface controller must not be null"),v(!this.isMounted(),"FilePreviewAnnotations instance is already mounted"),this.prevState={},this.interfaceController=t,this.onStateChange(a.state),this.unsubscribeStore=a.listen(this.onStateChange),n||(this.unsubscribeFileViewerStore=d.addListener(this.onStateChange)),this.shouldTrackCollapsedState=n,this.addAnnotationEventListeners(),this.performUpdateIfNecessary(),this.canAnnotate?this.enableAnnotationCreation():void 0},o.prototype.unmount=function(){return v(this.isMounted(),"FilePreviewAnnotations instance is not mounted"),this.unsubscribeStore(),"function"==typeof this.unsubscribeFileViewerStore&&this.unsubscribeFileViewerStore(),this.disableAnnotationCreation(),this.removeAnnotationEventListeners(),this.shouldTrackCollapsedState=null,this.interfaceController=null,window.clearTimeout(this.annotationBubbleTimer)},o.prototype.isMounted=function(){return null!=this.interfaceController},o.prototype.enableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("enable-annotation-creation")},o.prototype.disableAnnotationCreation=function(){return this.interfaceController.dispatchEvent("disable-annotation-creation")},o.prototype.addAnnotationEventListeners=function(){return m.forEach(function(t){return function(e){var n,o;return o="on"+y(e),n=t[o],null!=n?t.interfaceController.on(e,n):void 0}}(this))},o.prototype.removeAnnotationEventListeners=function(){return m.forEach(function(t){return function(e){var n,o;return o="on"+y(e),n=t[o],null!=n?t.interfaceController.off(e,n):void 0}}(this))},o.prototype.onAnnotationHidden=function(){return s.stopAnnotationCreation()},o.prototype.onAnnotationPlaced=function(t){var e;return e=f.createAnnotationFromDict(t.annotation),s.startAnnotationCreation({annotation:e}),u.log_annotation_event(n.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_PLACED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=t.annotation?t.annotation:void 0)},o.prototype.onAnnotationStartDrag=function(){
return s.hideAnnotationConversation(),s.hideAnnotationInput()},o.prototype.onAnnotationEndDrag=function(t){var e;return s.hideAnnotationConversation(),e=f.createAnnotationFromDict(t.annotation),s.startAnnotationCreation({annotation:e}),u.log_annotation_event(n.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_DRAGGED,this.state.activityKey,null,this.state.actorId,this.state.activityContext,null!=t.annotation?t.annotation:void 0)},o.prototype.onAnnotationUiClick=function(t){var e,o,i;return o=t.commentActivity.comment.comment_metadata,e=f.createAnnotationFromDict(o.annotation),s.switchRevision({revision:o.revision,commentActivity:t.commentActivity}),r.emit("reveal-annotation",{page:e.getFirstPdfPage(),commentActivity:t.commentActivity}),s.highlightComment({activityKey:t.commentActivity.activity_key}),u.log_annotation_event(n.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_CLICKED,this.state.activityKey,null!=(i=t.commentActivity)?i.activity_key:void 0,this.state.actorId,this.state.activityContext)},o.prototype.onAnnotationUiEnter=function(t){var e;return s.showAnnotationConversation({activityKey:t.commentActivity.activity_key,annotation:f.createAnnotationFromDict(t.annotation)}),u.log_annotation_event(n.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_UI_HOVER,this.state.activityKey,null!=(e=t.commentActivity)?e.activity_key:void 0,this.state.actorId,this.state.activityContext)},o.prototype.onAnnotationUiLeave=function(){return s.hideAnnotationConversationDelayed(200)},o.prototype.onScaleChange=function(){return s.stopAnnotationCreation(),s.hideAnnotationConversation()},o.prototype.onScroll=function(t){var e;return s.hideAnnotationInput(),s.hideAnnotationConversation(),window.clearTimeout(this.annotationBubbleTimer),e=function(t){var e;return null!=t.annotation?(e=f.createAnnotationFromDict(t.annotation),s.startAnnotationCreation({annotation:e})):s.showAnnotationInput()}(t),this.annotationBubbleTimer=window.setTimeout(e,150)},o.prototype.onOnKeydown=function(t){return l.normalizedKeyCode.apply(t)===c.ESC?s.stopAnnotationCreation():void 0},o.prototype.onResetFileFeedbackUi=function(){return s.stopAnnotationCreation(),s.hideAnnotationConversation()},o.prototype._savePrevState=function(){var t;return this.prevState={activityKeys:Object.keys(null!=(t=this.state.commentActivityByKey)?t:{}),hasEphemeral:null!=this.state.ephemeralAnnotation,canAnnotate:this.state.canAnnotate}},o.prototype._removeAnnotation=function(t){return this.interfaceController.dispatchEvent("remove-annotation",{commentActivity:{activity_key:t}})},o.prototype._updateAnnotations=function(t){var e,n,o,i,s,r,a,c,u;for(n=[],i=0,a=t.length;a>i;i++)o=t[i],o.comment.has_metadata()&&o.comment.comment_metadata.has_annotation_data()&&(this.state.showResolved||!o.comment.resolved)&&(c=o.comment.comment_metadata,e=c.annotation,u=c.revision,s=l.isRevisionEqual(this.state.revision,u),(this.state.isAnnotationGhostEnabled||null!=u&&s)&&(r=this.state.isAnnotationGhostEnabled&&null!=u&&!s,n.push({annotation:e,commentActivity:o,options:{isGhostAnnotation:r}})));return this.interfaceController.dispatchEvent("update-annotations",{annotations:n})},o.prototype.performUpdateIfNecessary=function(){var t,n;return this.isMounted()?(this.prevState.canAnnotate!==this.state.canAnnotate&&(this.state.canAnnotate?this.enableAnnotationCreation():this.disableAnnotationCreation()),e.isEmpty(this.state.commentActivityByKey)?this.interfaceController.dispatchEvent("remove-all-annotations"):(t=e.difference(null!=(n=this.prevState.activityKeys)?n:[],Object.keys(this.state.commentActivityByKey)),t.forEach(this._removeAnnotation,this),this._updateAnnotations(e.values(this.state.commentActivityByKey))),this.prevState.hasEphemeral&&null==this.state.ephemeralAnnotation&&this.interfaceController.dispatchEvent("hide-annotation"),this._savePrevState()):void 0},o}()})}.call(this),function(){define("modules/clean/comments/components/file_preview_overlay",["external/underscore","external/react","external/reflux","modules/core/exception","modules/clean/activity/file_viewer_state","modules/clean/comments/action_creators","modules/clean/comments/annotation_utils","modules/clean/comments/flux","modules/clean/comments/store","modules/clean/comments/utils","modules/clean/react/file_comments/annotation_bubble","modules/clean/react/file_comments/annotation_comments_list_ui_bubble","modules/constants/comments_panel"],function(t,e,n,o,i,s,r,a,l,c,u,d,p){var h,m,f,_;return m=o.assert,h=i.FileViewerState,f=e.DOM,_=function(){return p.ALLOW_ANNOTATION_CREATION_EXPAND},e.createClass({displayName:"FilePreviewOverlay",mixins:[a.connect(l)],propTypes:{previewContainer:e.PropTypes.instanceOf(HTMLElement).isRequired},getViewingCommentActivity:function(){var t;return m(this.state.viewAnnotation,"No currently viewing inline comment!"),t=this.state.viewAnnotation.activityKey,this.state.activity.findActivityByKey(t)},maybeRenderAnnotationInputBubble:function(){var n,o,i,s,a,l,d,p,h;return null!=this.state.createAnnotation&&c.canAnnotate()?(a={context:this.state.viewing.context,activity:this.state.activity,user:c.getActivityUser(this.state.actorId),shouldShowExpandBubble:_(),commentText:this.state.annotationText,position:"top",x:0,y:0},this.state.createAnnotation.showBubble&&(n=this.state.createAnnotation.annotation,i=!r.isAnnotationOffscreen(n,this.props.previewContainer),i&&(l=r.getBubblePosition(n,this.props.previewContainer),o=l[0],d=l[1],p=d.x,h=d.y,s=l[2],null!=o&&null!=p&&null!=h))?(t.extend(a,{showBubble:!0,position:o,x:p,y:h,maxHeight:s}),e.createElement(u,a)):(a.showBubble=!1,e.createElement(u,a))):void 0},maybeRenderAnnotationConversationBubble:function(){var n,o,i,s,a,l,u,p,h,f,_,v;return null==this.state.viewAnnotation||(f=this.getViewingCommentActivity(),f.comment.resolved&&!this.state.showResolvedComments||(u=this.state.viewAnnotation,i=u.annotation,o=u.activityKey,r.isAnnotationOffscreen(i,this.props.previewContainer)||(p=r.getBubblePosition(i,this.props.previewContainer),a=p[0],h=p[1],_=h.x,v=h.y,l=p[2],null==a||null==_||null==v||null==l)))?void 0:(n=this.state.activity,s=t.findWhere(n.comment_activities,{activity_key:o}),m(null!=s,"Invalid activity key for currently viewing annotation: "+o),e.createElement(d,{context:this.state.viewing.context,activity:n,commentActivity:s,user:c.getActivityUser(this.state.actorId),showBubble:!0,isThreadingEnabled:!0,position:a,replyText:this.state.annotationReplyTextByKey[s.activity_key],x:_,y:v,maxHeight:l}))},render:function(){return f.div({},this.maybeRenderAnnotationInputBubble(),this.maybeRenderAnnotationConversationBubble())}})})}.call(this),function(){define("modules/clean/comments/events",["modules/clean/event_emitter"],function(t){return new t})}.call(this),function(){define("modules/clean/comments/flux",["external/underscore","external/reflux"],function(t,e){var n,o,i;return n=e.ListenerMethods,o=e.ListenerMixin,i=function(e){return{getInitialState:function(){return e.state},componentWillMount:function(){return t.extend(this,n),this.replaceState(e.state),this.listenTo(e,this.replaceState)},componentWillUnmount:o.componentWillUnmount}},{connect:i}})}.call(this),function(){define("modules/clean/comments/logged_out_utils",["modules/clean/react/file_comments/logger","modules/clean/storage","modules/constants/legacy"],function(t,e,n){var o,i,s,r,a,l,c,u;return a=e.SessionStorage,o=n.FILE_ACTIVITY_LOG_EVENT_TYPE,i="commenting_actions",r="v1",s=i+":"+r,l=function(e){var n,i,s,r;return i=e.fileActivityKey,n=null!=(r=e.commentActivityKey)?r:null,s=e.originType,t.log_event(o.CLIENT_SIGN_UP_MODAL,i,n,s)},u=function(t){var e,n,o,i,r,l,c,u;l=t.name,r=t.fileActivityKey,n=t.args;try{return u=s+":"+r,e=null!=(c=a.get(u))?c:[],e.push({name:l,args:n}),a.set(u,e)}catch(t){o=t,console.error(o)}},c=function(t){var e,n,o,i,r,l,c;e=t.actionCreators,r=t.fileActivityKey;try{return c=s+":"+r,n=null!=(l=a.get(c))?l:[],a.set(c,null),n.forEach(function(t){var n,o;return o=t.name,n=t.args,e[o].apply(e,n)})}catch(t){o=t,console.error(o)}},{logSignUpModal:l,saveActionCreator:u,replayActionCreators:c}})}.call(this),function(){var t=function(t,n){function o(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return o.prototype=n.prototype,t.prototype=new o,t.__super__=n.prototype,t},e={}.hasOwnProperty;define("modules/clean/comments/models/immutable_comment_activity",["external/underscore","modules/clean/activity/activity","modules/clean/activity/comment"],function(e,n,o){var i,s,r;return i=n.CommentActivity,s=function(n){function o(){}return t(o,n),o.fromMutable=function(t){return e.create(o.prototype,t)},o}(o),r=function(n){function o(){}return t(o,n),o.fromMutable=function(t){var n;return n=e.create(o.prototype,t),n.comment=s.fromMutable(n.comment),n.comment_activities=n.comment_activities.map(o.fromMutable),n},o}(i)})}.call(this),function(){var t=function(t,n){function o(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return o.prototype=n.prototype,t.prototype=new o,t.__super__=n.prototype,t},e={}.hasOwnProperty;define("modules/clean/comments/models/immutable_file_activity",["external/underscore","modules/core/exception","modules/clean/activity/activity","modules/clean/activity/like","modules/clean/comments/models/immutable_comment_activity","modules/clean/immutability_helper"],function(e,n,o,i,s,r){var a,l,c,u,d,p,h,m,f,_,v,y,g,b;return c=n.assert,a=o.FileActivity,y=r.updateIn,p=r.getIn,v=r.splice,_=r.push,m=r.merge,g=function(t){return e.matcher({activity_key:t})},b=e.compose(e.negate,g),h=function(t){return function(e){var n;return n=e.liker,n.id===t}},f=e.compose(e.negate,h),u=function(t,e,n){var o,i,s,r,a,l,c,u,d,p,h;if(null==n&&(n=!1),(a=g(e))(t))return[];for(d=t.comment_activities,s=i=0,c=d.length;c>i;s=++i){if(o=d[s],a(o))return["comment_activities",s];if(!n)for(p=o.comment_activities,r=l=0,u=p.length;u>l;r=++l)if(h=p[r],a(h))return["comment_activities",s,"comment_activities",r]}return null},d=function(t,e,n){var o;if(o=u(t,e,n),null==o)throw Error("Cannot find activity with the key: "+e);return o},l=function(n){function o(){}return t(o,n),o.fromMutable=function(t){var n;return n=e.create(o.prototype,t),n.comment_activities=n.comment_activities.map(s.fromMutable),n},o.prototype.findActivityByKey=function(t,e){var n;return null==e&&(e=!1),n=u(this,t,e),null!=n?p(this,n):null},o.prototype.purgeActivity=function(t){var n,o;return o=u(this,t),null==o?this:(c(o.length>0,"Cannot purge root activity"),n=o.pop(),y(this,o,e.partial(v,e,[[n,1]])))},o.prototype.updateDeleteActivity=function(t,n){var o;return o=u(this,t),null==o?this:y(this,o,e.partial(m,e,{isDeleted:n}))},o.prototype.appendActivity=function(t,n){var o;return o=d(this,t,!0),o.push("comment_activities"),y(this,o,e.partial(_,e,[n]))},o.prototype.updateResolveActivity=function(t,n){var o;return o=d(this,t),o.push("comment"),y(this,o,e.partial(m,e,{resolved:n}))},o.prototype.updateLikeActivity=function(t,e,n){var o;return o=d(this,t),o.push("likes"),y(this,o,function(t){var o;return e?(o=new i({liker_dict:n,when_mses:Date.now()}),_(t,[o])):t.filter(f(n.id))})},o.prototype.updateActivityStatus=function(t,n){var o;return o=d(this,t),y(this,o,e.partial(m,e,{status:n}))},o.prototype.updateEnableActivity=function(t){return m(this,{feedback_off:!t})},o.prototype.markCommentsSeen=function(t){var e,n;return n=d(this,t),c(n.length>0,"Cannot mark root activity as seen"),e=n.pop(),n.pop(),y(this,n,function(e){return m(e,{seen_comment_count:e.comment_activities.length,lastSeenActivityKey:t})})},o.prototype.union=function(t){var n;return n=e.indexBy(t.comment_activities,"activity_key"),t.lastSeenActivityKey=this.lastSeenActivityKey,this.comment_activities.forEach(function(e){var o,i,s;return null!=e.isPending?t.comment_activities.push(e):(o=n[e.activity_key],i=e.getPendingCommentActivities(),i.length&&null!=o?(s=o.comment_activities).push.apply(s,i):void 0)}),t},o}(a)})}.call(this),function(){define("modules/clean/comments/models/loading_spinner",[],function(){return function(t,e){return null==e||e.comment_activities.length>0?t:!1}})}.call(this),function(){var t=function(t,n){function o(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return o.prototype=n.prototype,t.prototype=new o,t.__super__=n.prototype,t},e={}.hasOwnProperty;define("modules/clean/comments/models/pending_comment_activity",["external/underscore","modules/clean/activity/activity","modules/clean/activity/comment"],function(e,n,o){var i,s,r;return i=n.ActivityType,s=n.CommentActivity,r=function(n){function s(){}return t(s,n),s.prototype.isPending=!0,s.build=function(t){var n,r,a,l,c;return n=t.activityUser,c=t.text,l=t.metadata,l=null!=l?l:{},r=e.extend(Object.create(o.prototype),{commenter:n,raw_comment_text:c,resolved:!1,when_mses:(new Date).getTime(),comment_metadata:new o.Metadata(l)}),a=e.extend(new s,{activity_key:e.uniqueId("pending-activity-"),status:"PENDING",activity_type:i.COMMENT,comment_activities:[],feedback_off:!1,likes:[],owner:n,comment:r})},s}(s)})}.call(this),function(){define("modules/clean/comments/models/preview_types",[],function(){return{PDFJS:0,IMAGE:1}})}.call(this),function(){define("modules/clean/comments/revisions",["external/underscore"],function(t){var e;return e=function(e,n){var o;return null!=e.set?(null!=e.thumbnail_url_tmpl&&(e=e.set("thumbnail_url_tmpl",n.direct_blockserver_link)),e.merge({direct_blockserver_link:n.direct_blockserver_link,sjid:null})):(o=t.clone(e),o.direct_blockserver_link=n.direct_blockserver_link,null!=o.thumbnail_url_tmpl&&(o.thumbnail_url_tmpl=n.direct_blockserver_link),o.sjid=null,o)},{getFileWithRevision:e}})}.call(this),function(){define("modules/clean/comments/store",["external/underscore","external/react","external/reflux","modules/constants/legacy","modules/core/exception","modules/core/i18n","modules/clean/activity/activity","modules/clean/annotations/annotation","modules/clean/gandalf_util","modules/clean/promise","modules/clean/comments/actions","modules/clean/comments/events","modules/clean/comments/models/loading_spinner","modules/clean/comments/revisions","modules/clean/comments/utils","modules/clean/react/file_viewer/actions","modules/clean/react/file_comments/logger","modules/clean/react/file_comments/comment_tab_nav","modules/clean/react/pass/actions"],function(t,e,n,o,i,s,r,a,l,c,u,d,p,h,m,f,_,v,y){var g,b,w,T,C,S,A,I,x;return A=i.assert,S=s._,b=r.CommentActivity,g=a.Annotation,w=c.Promise,C=v.TAB_NAV_COMMENTS,T=v.TAB_NAV_ANNOTATIONS,x=e.addons.update,I=function(t,e,n){return t=null!=t?t:"",t+":"+e+":"+n},n.createStore({listenables:u,init:function(){return this.state=this.getInitialState()},getInitialState:function(){var t;return t={actorId:null,viewing:{context:null,contextData:null,revision:null,file:null},activity:null,showLoadingSpinner:!0,oref:null,showResolvedComments:!1,isPreviewReady:!1,isCommentsHidden:!1,shouldTrackCollapsedState:!0,viewAnnotation:null,createAnnotation:null,annotationText:null,annotationReplyTextByKey:{},highlightedActivityKey:null,selectedTab:C,shouldShowOnboarding:void 0}},setState:function(e,n){return t.extend(this.state,e),this.trigger(this.state),"function"==typeof n?n():void 0},replaceState:function(t){return this.state=t,this.forceUpdate()},forceUpdate:function(){return this.trigger(this.state)},onReceiveFileActivity:function(t){return null!=t&&null==this.state.viewing.revision&&(this.state.viewing.revision=t.latestRevision),null!=t&&null!=t.seen_states&&null!=this.state.viewing&&null!=this.state.viewing.file&&l.getGandalfRule("file_viewer_seen_state")&&setTimeout(function(e){return function(){return y.updateSeenStates(e.state.viewing.file.ns_id,e.state.viewing.file.ns_path,t.seen_states)}}(this),0),this.setState({activity:t,viewAnnotation:null})},onStartViewingComments:function(t){var e,n,o,i,s,r,a,l;return e=t.actorId,n=t.context,o=t.contextData,s=t.oref,i=t.file,r=t.previewSelector,a=t.shouldTrackCollapsedState,l=null!==this.state.contextData?p(this.state.showLoadingSpinner,this.state.activity):!0,this.setState({actorId:e,viewing:{context:n,contextData:o,file:i,revision:null},oref:s,viewAnnotation:null,createAnnotation:null,isPreviewReady:!1,showLoadingSpinner:l,isReactViewer:(null!=r?r.indexOf("react"):void 0)>=0,annotationText:null,annotationReplyTextByKey:{},shouldTrackCollapsedState:a})},onStopViewingComments:function(){return this.setState({actorId:null,activity:null,viewing:{context:null,contextData:null,revision:null,file:null},showLoadingSpinner:!0,oref:null,viewAnnotation:null,createAnnotation:null,isPreviewReady:!1,isReactViewer:!1,annotationText:null,annotationReplyTextByKey:{},shouldTrackCollapsedState:!0})},onShowResolvedComments:function(){return this.setState({showResolvedComments:!0})},onHideResolvedComments:function(){return this.setState({showResolvedComments:!1})},onHighlightComment:function(t){var e;return e=t.activityKey,this.setState({highlightedActivityKey:e,selectedTab:T})},onSwitchTabs:function(t){var e;return e=t.selectedTab,this.setState({selectedTab:e})},onNotifyPreviewReady:function(){return this.setState({isPreviewReady:!0}),null!=this.state.activity?d.emit("preview-and-comments-ready"):void 0},onShowAnnotationConversation:function(t){var e,n;return n=t.annotation,e=t.activityKey,A(null!=this.state.activity,"Cannot show annotation when file activity is not ready!"),A(null!=n,"Invalid annotation to show"),A(null!=this.state.activity.findActivityByKey(e),"Invalid inline comment to show: "+e),this.onCancelHideAnnotationConversationDelayed(),this.setState({viewAnnotation:{annotation:n,activityKey:e},createAnnotation:null})},onHideAnnotationConversation:function(){return this.onCancelHideAnnotationConversationDelayed(),this.setState({viewAnnotation:null})},onHideAnnotationConversationDelayed:function(t){var e;return null!=this.state.viewAnnotation?(e=function(t){return function(){return t.onHideAnnotationConversation()}}(this),this.state.viewAnnotation.hideTimerId=window.setTimeout(e,t)):void 0},onCancelHideAnnotationConversationDelayed:function(){var t,e;return e=null!=(t=this.state.viewAnnotation)?t.hideTimerId:void 0,null!=e?(window.clearTimeout(e),this.state.viewAnnotation.hideTimerId=null):void 0},onStartAnnotationCreation:function(t){var e;return e=t.annotation,this.setState({viewAnnotation:null,createAnnotation:{annotation:e,showBubble:!0}})},onStopAnnotationCreation:function(){return this.setState({createAnnotation:null})},onUpdateAnnotationText:function(t){return this.setState({annotationText:t})},onUpdateAnnotationReplyText:function(e){var n,o,i,s;return n=e.activityKey,s=e.text,n in this.state.annotationReplyTextByKey&&!s?(o=t.omit(this.state.annotationReplyTextByKey,n),this.setState({annotationReplyTextByKey:o})):(o=t.extend({},this.state.annotationReplyTextByKey,(i={},i[""+n]=s,i)),this.setState({annotationReplyTextByKey:o}))},onShowAnnotationInput:function(){return null!=this.state.createAnnotation?this.setState({createAnnotation:{annotation:this.state.createAnnotation.annotation,showBubble:!0}}):void 0},onHideAnnotationInput:function(){return null!=this.state.createAnnotation?this.setState({createAnnotation:{annotation:this.state.createAnnotation.annotation,showBubble:!1}}):void 0},onSwitchRevision:function(t){var e,n,i,s,r;return r=t.revision,e=t.commentActivity,A(null!=r,"Revision to switch to must not be null!"),A(null!=this.state.activity,"Cannot switch revision when file activity is not ready!"),m.isRevisionEqual(r,this.state.viewing.revision)?void 0:(m.isRevisionEqual(r,this.state.activity.latestRevision)?(this.state.isReactViewer?f.restoreRevision():d.emit("switch-revision",{revision:r,commentActivity:e}),n=o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SWITCH_TO_LATEST_REVISION):(this.state.isReactViewer?(i=h.getFileWithRevision(this.state.viewing.file,r),f.switchRevision(i)):d.emit("switch-revision",{revision:r,commentActivity:e}),n=o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SWITCH_TO_OLD_REVISION),this.setState({viewing:x(this.state.viewing,{revision:{$set:r}}),isPreviewReady:!1}),d.emit("revision-did-change"),_.log_annotation_event(n,this.state.activity.activity_key,null!=e?e.activity_key:void 0,this.state.actorId,this.state.viewing.context,null!=e&&null!=(s=e.comment.comment_metadata)?s.annotation:void 0))},onRevealAnnotation:function(t){var e,n,i,s;return n=t.commentActivity,i=n.comment.comment_metadata,s=null!=i?i.revision:void 0,e=g.createAnnotationFromDict(i.annotation),this.onSwitchRevision({revision:s,commentActivity:n}),d.emit("reveal-annotation",{page:e.getFirstPdfPage(),commentActivity:n}),_.log_annotation_event(o.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_ANNOTATION_BUTTON_CLICKED,this.state.activity.activity_key,n.activity_key,this.state.actorId,this.state.viewing.context,i.annotation)},onShowComments:function(){return this.state.shouldTrackCollapsedState?this.setState({isCommentsHidden:!1}):f.openComments()},onHideComments:function(){return this.state.shouldTrackCollapsedState?this.setState({isCommentsHidden:!0}):f.closeComments()},onSetShouldShowOnboarding:function(t){return this.setState({shouldShowOnboarding:t})}})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/comments/utils",["modules/clean/annotations/annotation","modules/clean/activity/activity","modules/clean/activity/activity_user","modules/clean/comments/models/preview_types","modules/clean/datetime","modules/clean/gandalf_util","modules/clean/viewer","modules/core/exception","modules/core/i18n"],function(e,n,o,i,s,r,a,l,c){var u,d,p,h,m,f,_,v,y,g,b,w,T,C,S,A,I;return d=e.Annotation,u=n.ActivityContext,p=c._,h=function(){return!0},_=function(t){var e;return e=a.get_viewer(),null!=t?o.fromUser(e.get_user_by_id(t)):e.work_user||e.personal_user?o.fromUser(e.work_user||e.personal_user):e.is_signed_in?void 0:new o},y=function(e,n){var o;if(o=[u.BROWSE_FILE_VIEWER,u.SHARED_LINK_VIEW,u.SHARED_CONTENT_LINK_VIEW],t.call(o,e)>=0&&null!=n){if("photo"===n)return i.IMAGE;if("doc"===n||"adobecs"===n)return i.PDFJS}return null},m=function(t,e){return l.assert(null!=t&&null!=e,"Revision object to compare with cannot be null!"),e.when-t.when},C=function(t,e){return m(t,e)<0},T=function(t,e){return m(t,e)>0},w=function(t,e){return 0===m(t,e)},S=function(){return this.keyCode||this.which||this.charCode},b=function(t){var e,n,o,i,r,a,l,c,u;for(i={},c=[],l=Date.now(),r=0,a=t.length;a>r;r++)e=t[r],n=new Date(e.comment.when_mses),o=l-e.comment.when_mses,u=12e4>o?p("Just now"):864e5>o?p("Today"):1728e5>o?p("Yesterday"):s.format_date(n,"MMM d, yyyy"),i[u]?i[u].push(e):(c.push(u),i[u]=[e]);return[c,i]},g=function(t){var e,n,o,i,s,r,a,l;for(o={},a=[],s=0,r=t.length;r>s;s++)n=t[s],i=n.comment.has_metadata()&&n.comment.comment_metadata.has_annotation_data(),i&&(e=d.createAnnotationFromDict(n.comment.comment_metadata.annotation),l=e.getFirstPdfPage(),o[l]?o[l].push(n):(a.push(l),o[l]=[n]));return a.sort(function(t,e){return t-e}),[a,o]},f=function(t,e){var n,o,i,s,r,a,l,c,u,d;for(null==e&&(e={}),r=null!=e.includeAnnotations?e.includeAnnotations:!0,a=null!=e.includeDocLevel?e.includeDocLevel:!0,l=null!=e.includeNotResolved?e.includeNotResolved:!0,c=null!=e.includeResolved?e.includeResolved:!1,d=null!=e.sortBy?e.sortBy:null,o=[],s=0,u=t.length;u>s;s++)if(n=t[s],null==n.isDeleted){if(i=n.comment.has_metadata()&&n.comment.comment_metadata.has_annotation_data(),!e.includeAnnotations&&i)continue;if(!a&&!i)continue;c&&n.comment.resolved&&o.push(n),l&&!n.comment.resolved&&o.push(n)}return d&&o.sort(function(t,e){return d(t,e)}),o},v=function(t){var e,n,o,i;for(i=0,n=0,o=t.length;o>n;n++)e=t[n],e.comment.resolved&&i++;return i},I=function(t,e){return e.comment.when_mses-t.comment.when_mses},A=function(t,e){var n,o,i,s,r,a;return n=d.createAnnotationFromDict(t.comment.comment_metadata.annotation),o=d.createAnnotationFromDict(e.comment.comment_metadata.annotation),i=n.getFirstCoordindates().x,r=n.getFirstCoordindates().y,s=o.getFirstCoordindates().x,a=o.getFirstCoordindates().y,a-r||s-i},{normalizedKeyCode:S,canAnnotate:h,getActivityUser:_,getPreviewType:y,compareRevision:m,isRevisionOlderThan:C,isRevisionNewerThan:T,isRevisionEqual:w,groupCommentActivitiesByTime:b,groupAnnotationActivitiesByPage:g,filterCommentActivities:f,getNumResolved:v,sortByTime:I,sortByCoordinates:A}})}.call(this),function(){define("modules/clean/contacts/util",["modules/clean/contacts/types"],function(t){var e;return e=function(){function e(){}return e.activityUserToContact=function(e,n){return null==n&&(n=0),{dbx_account_id:e.unique_id,fname:e.fname,lname:e.lname,name:e.display_name,name_tokens:[e.fname,e.lname],email:e.email,type:t.DBX_ID,priority:n,photo_url:e.photo_circle_url}},e}()})}.call(this),function(){define("modules/clean/event_emitter",["external/reflux"],function(t){return t.utils.EventEmitter})}.call(this),function(){define("modules/clean/file_activity/api",["external/underscore","modules/core/types","modules/clean/ajax","modules/clean/activity/activity","modules/clean/comments/models/immutable_comment_activity","modules/clean/comments/models/immutable_file_activity","modules/clean/promise"],function(t,e,n,o,i,s,r){var a,l,c,u,d,p,h,m,f,_,v,y,g,b,w,T,C,S,A,I,x,P,N,k,E,R,O,D,M,L,U,F,B,H,K,V;return F=e.takes,M=e.returns,m=e.Maybe,c=e.Either,f=r.Promise,w={actorId:m(Number),oref:m(String),isBackgroundRequest:m(Boolean)},I=function(e){var o,i,s,r,a,l,c,u;return u=e.url,c=e.type,i=e.data,o=e.actorId,r=e.oref,s=e.isBackgroundRequest,l=s?n.SilentBackgroundRequestOref:n.WebRequestOref,a=new f(function(e,n){return l({url:u,type:c,data:t.extend({oref:r},i),subject_user:o,success:e,error:function(t,e){return n(e)}})}),a.then(JSON.parse)},C=function(t){var e,n,o;if("error"===t.status)throw n=null!=(o=t.payload)?o.error_text:void 0,e=Error(n),e.payload=t.payload,e.error_text=n,e;return t.payload},S=function(t){var e,n;return n=C(t),e=t.bolt_data,[n,e]},T=function(t){var e;return e=new o.FileActivity(t),s.fromMutable(e)},a=t.extend({commentActivityKey:m(String),context:Number,contextData:String,text:m(String),metadata:m(Object)},w),x=F(a,M(f,function(t){var e,n,s,r,a,l,c,u;return e=t.actorId,n=t.commentActivityKey,s=t.context,r=t.contextData,u=t.text,l=t.metadata,c=t.oref,a=t.isBackgroundRequest,I({actorId:e,url:"/file_activity/comment",type:"POST",data:{activity_context:s,activity_context_data:r,comment_text:u,comment_metadata_json:null!=l?JSON.stringify(l):null,target_comment_activity_key:n},oref:c,isBackgroundRequest:a}).then(C).then(function(t){var e;return e=new o.CommentActivity(t),i.fromMutable(e)})})),l=t.extend({commentActivityKey:String,context:Number,contextData:String},w),P=F(l,M(f,function(t){var e,n,o,i,s,r;return e=t.actorId,n=t.commentActivityKey,o=t.context,i=t.contextData,r=t.oref,s=t.isBackgroundRequest,I({actorId:e,url:"/file_activity/comment/delete",type:"POST",data:{comment_key:n,activity_context:o,activity_context_data:i},oref:r,isBackgroundRequest:s}).then(C)})),y=t.extend({liked:Boolean,commentActivityKey:String,context:Number,contextData:String},w),K=F(y,M(f,function(t){var e,n,o,i,s,r,a;return e=t.actorId,r=t.liked,n=t.commentActivityKey,o=t.context,i=t.contextData,a=t.oref,s=t.isBackgroundRequest,I({actorId:e,url:"/file_activity/comment/like",type:"POST",data:{activity_key:n,activity_context:o,activity_context_data:i,liked:r},oref:a,isBackgroundRequest:s}).then(C)})),v=t.extend({enableComment:Boolean,context:Number,contextData:String},w),B=F(v,M(f,function(t){var e,n,o,i,s,r;return e=t.actorId,i=t.enableComment,n=t.context,o=t.contextData,r=t.oref,s=t.isBackgroundRequest,I({actorId:e,url:"/file_activity/feedback_setting",type:"POST",data:{activity_context:n,activity_context_data:o,feedback_off:!i},oref:r,isBackgroundRequest:s}).then(C)})),g=t.extend({resolved:Boolean,commentActivityKey:String,context:Number,contextData:String},w),V=F(g,M(f,function(t){var e,n,o,i,s,r,a;return e=t.actorId,a=t.resolved,n=t.commentActivityKey,o=t.context,i=t.contextData,r=t.oref,s=t.isBackgroundRequest,I({actorId:e,url:"/file_activity/comment/resolve",type:"POST",data:{activity_key:n,activity_context:o,activity_context_data:i,resolved:a},oref:r,isBackgroundRequest:s}).then(C)})),h=t.extend({commentActivityKey:String,context:Number,contextData:String},w),D=F(h,M(f,function(t){var e,n,o,i,s,r;return e=t.actorId,n=t.commentActivityKey,o=t.context,i=t.contextData,r=t.oref,s=t.isBackgroundRequest,I({actorId:e,url:"/file_activity/mark_comments_seen",type:"POST",data:{last_seen_comment_key:n,activity_context:o,activity_context_data:i},oref:r,isBackgroundRequest:s}).then(C)})),p=t.extend({context:Number,contextData:String},w),A=function(t){var e,n,i,s,r;return e=t.actorId,n=t.context,i=t.contextData,r=t.oref,s=t.isBackgroundRequest,I({actorId:e,url:"/file_activity/file_activity",type:"GET",data:{activity_context:n,activity_context_data:i,activity_type:o.ActivityType.FILE},oref:r,isBackgroundRequest:s})},E=F(p,M(f,function(t){return A(t).then(C).then(T)})),R=F(p,M(f,function(t){return A(t).then(S).then(function(t){var e,n;return e=t[0],n=t[1],[T(e),n]})})),d=t.extend({context:Number,contextDataList:Array},w),k=F(d,M(f,function(e){var n,i,s,r,a;return n=e.actorId,i=e.context,s=e.contextDataList,a=e.oref,r=e.isBackgroundRequest,I({actorId:n,url:"/file_activity/file_activity_batch",type:"GET",data:{activity_context:i,activity_context_data_batch:JSON.stringify(s),activity_type:o.ActivityType.FILE},oref:a,isBackgroundRequest:r}).then(function(e){return t.mapObject(e,T)})})),b=t.extend({targetUserEmail:m(String),subscribed:Boolean,context:Number,contextData:String},w),H=F(b,M(f,function(t){var e,n,o,i,s,r,a;return e=t.actorId,a=t.targetUserEmail,r=t.subscribed,n=t.context,o=t.contextData,s=t.oref,i=t.isBackgroundRequest,I({actorId:e,url:"/file_activity/subscribe",type:"POST",data:{activity_context:n,activity_context_data:o,subscribed:r,target_user_identifier:a},oref:s,isBackgroundRequest:i}).then(C)})),u=t.extend({context:Number,contextDataList:Array},w),N=F(u,M(f,function(e){var n,o,i,s,r;return n=e.actorId,o=e.context,i=e.contextDataList,r=e.oref,s=e.isBackgroundRequest,I({actorId:n,url:"/file_activity/comment_status_batch",type:"POST",data:{activity_context:o,activity_context_data_batch:JSON.stringify(i)},oref:r,isBackgroundRequest:s}).then(C).then(function(e){return t.mapObject(e,function(t){var e,n,o;return n=t.feedback_off,e=t.comment_count,o=t.unresolved_comment_count,{feedback_off:n,comment_count:e,unresolved_comment_count:o}})})})),_=t.extend({feedbackText:String,context:Number,contextData:String},w),U=F(_,M(f,function(t){var e,n,o,i,s,r;return e=t.actorId,i=t.feedbackText,n=t.context,o=t.contextData,r=t.oref,s=t.isBackgroundRequest,I({actorId:e,url:"/file_activity/product_feedback",type:"POST",data:{activity_context:n,activity_context_data:o,feedback_text:i},oref:r,isBackgroundRequest:s}).then(C)})),O=F({actorId:Number},M(f,function(t){var e,o;return e=t.actorId,o=new f(function(t,o){return n.SilentBackgroundRequestOref({url:"/file_activity/mark_commenting_onboarding_seen",type:"POST",success:t,error:o,subject_user:e})}),o.then(JSON.parse).then(C)})),L=F({actorId:Number},M(f,function(t){var e,o;return e=t.actorId,o=new f(function(t,o){return n.SilentBackgroundRequestOref({url:"/file_activity/should_show_commenting_onboarding",type:"POST",success:t,error:o,subject_user:e})}),o.then(JSON.parse).then(C)})),{markCommentingOnboardingSeen:O,shouldShowCommentingOnboarding:L,addComment:x,deleteComment:P,updateLikeComment:K,updateResolveComment:V,updateCommentSetting:B,markCommentsSeen:D,fetchCommentStatusBatch:N,fetchFileActivity:E,fetchFileActivityWithBoltData:R,fetchFileActivities:k,updateFileActivitySubscription:H,submitProductFeedback:U}})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e=function(t,e){function o(){this.constructor=t}for(var i in e)n.call(e,i)&&(t[i]=e[i]);return o.prototype=e.prototype,t.prototype=new o,t.__super__=e.prototype,t},n={}.hasOwnProperty;define("modules/clean/file_activity/clients/file_activity_bolt_client",["external/underscore","modules/core/exception","modules/core/types","modules/clean/bolt","modules/clean/event_emitter","modules/clean/file_activity/api","modules/clean/promise","modules/clean/storage"],function(n,o,i,s,r,a,l,c){
var u,d,p,h,m,f,_;return _=i.takes,d=i.Maybe,p=l.Promise,h=c.SessionStorage,m=function(t,e){return new s.SignedChannelState("file_activity",t.activity_key,e.revision,e.token)},f=function(t){var e,n;return e=t.revision,n=t.token,{revision:e,token:n}},u=function(n){function i(){return this._onBoltRefresh=t(this._onBoltRefresh,this),this._onBoltUpdate=t(this._onBoltUpdate,this),r.apply(this,arguments)}var r;return e(i,n),r=_({actorId:d(Number),context:Number,contextData:String,oref:d(String)},function(t){var e,n,o,i;return e=t.actorId,n=t.context,o=t.contextData,i=t.oref,this.__requestOptions={actorId:e,context:n,contextData:o,oref:i,isBackgroundRequest:!0},this.__isLive=!1,this.__isReady=!1,this.__canInit=!0}),i.prototype.getFileActivity=function(){return this.__fileActivity},i.prototype.isReady=function(){return this.__isReady},i.prototype.isLive=function(){return this.__isLive},i.prototype.init=function(){o.assert(this.__canInit,"Cannot initialize an already initialized or initialization in-progress client"),this.__canInit=!1,this._pullFromServer().then(function(t){return function(){return t.__isLive?t._doStartLiveUpdate():void 0}}(this)).catch(function(t){return function(){return t.__canInit=!0}}(this))},i.prototype.startLiveUpdate=function(){return o.assert(!this.__isLive,"Client is already live updating"),this.__isReady&&this._doStartLiveUpdate(),this.__isLive=!0},i.prototype.stopLiveUpdate=function(){var t;return this.__isLive=!1,null!=(t=this.__boltClient)?t.unsubscribe():void 0},i.prototype.update=function(t){var e,n;return o.assert(this.__isReady,"Cannot open transaction when server data is not ready"),n=this.__fileActivity,e=t(this.__fileActivity),this.__fileActivity=e,this.emit("updated",e,n),e},i.prototype._doStartLiveUpdate=function(){var t;return t=m(this.__fileActivity,this.__boltData),this.__boltClient=new s.BoltClient([t],this._onBoltUpdate,this._onBoltRefresh),this.__boltClient.start()},i.prototype._pullFromServer=function(){var t;return h.set("reload-timestamp",(new Date).getTime()),t=a.fetchFileActivityWithBoltData(this.__requestOptions),t.then(function(t){return function(e){var n,o,i;return o=e[0],n=e[1],i=t.__fileActivity,t.__fileActivity=(null!=i?i.union(o):void 0)||o,t.__boltData=n,t.__isReady?t.emit("updated",t.__fileActivity,i):(t.__isReady=!0,t.emit("ready",t.__fileActivity))}}(this)),t.catch(function(t){return function(e){return t.emit("error",e)}}(this)),t},i.prototype._onBoltUpdate=function(t){var e;return 1===(null!=t?t.length:void 0)&&t[0].unique_id===this.__fileActivity.activity_key?(e=t[0],this.__boltData=f(e),this._pullFromServer().then(function(t){return function(){return t.__isLive?(e=m(t.__fileActivity,t.__boltData),t.__boltClient.update_states([e])):void 0}}(this))):void 0},i.prototype._onBoltRefresh=function(){return this._pullFromServer().then(function(t){return function(){return t.__isLive?(t.stopLiveUpdate(),t.startLiveUpdate()):void 0}}(this))},i}(r)})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define("modules/clean/file_activity/clients/file_activity_data_source",["external/underscore","external/lru","modules/clean/comments/events","modules/clean/comments/store","modules/clean/file_activity/clients/file_activity_bolt_client","modules/clean/promise"],function(e,n,o,i,s,r){var a,l,c;return l=r.Promise,c=function(t,e,n,o){return null==o&&(o=""),t=null!=t?t:"",t+":"+e+":"+n+":"+o},a=function(){function r(e){this._cache=e._cache,this._unsubscribeStore=e._unsubscribeStore,this._sendFileActivity=e._sendFileActivity,this._state=e._state,this.onClientUpdated=t(this.onClientUpdated,this),this.onStoreUpdate=t(this.onStoreUpdate,this)}return r.getInstance=function(){var t;return t=r,null==t.__instance&&(t.__instance=t.create(i,function(t){return o.emit("file-activity-updated",t)})),t.__instance},r.create=function(t,e,o){var i,s;return null==o&&(o=10),i=new n(o),i.shift=function(){var t,e;return e=n.prototype.shift.call(this),t=e.value,null!=t&&t.removeAllListeners(),null!=t&&t.stopLiveUpdate(),e},s=new r({_cache:i,_state:{},_sendFileActivity:e}),s._unsubscribeStore=t.listen(s.onStoreUpdate),s.onStoreUpdate(t.state),s},r.prototype.dispose=function(){return this._unsubscribeStore()},r.prototype.replaceState=function(t){var e;return this.shouldUpdate(t)?(this.willUpdate(t),e=this._state,this._state=t,this.didUpdate(e)):void 0},r.prototype.getState=function(){return this._state},r.prototype.onStoreUpdate=function(t){var e,n,o,i,s,r;return e=t.actorId,s=t.oref,r=t.viewing,n=r.context,o=r.contextData,i={oref:s,actorId:e,context:n,contextData:o},this.replaceState(i)},r.prototype.shouldUpdate=function(t){return!e.isEqual(this._state,t)},r.prototype.willUpdate=function(){var t;return t=this.getCurrentClient(),null!=t?this.deactivateClient(t):void 0},r.prototype.didUpdate=function(){var t;return t=this.getCurrentFetchKey(),this.isFetching(t)||(this.sendActivity(null),this.isNullState(this._state))?void 0:this.fetchAndSend(this._state)},r.prototype.getFetchKey=function(t){var e,n,o,i;return e=t.actorId,n=t.context,o=t.contextData,i=t.oref,c(e,n,o,i)},r.prototype.getCurrentFetchKey=function(){return this.getFetchKey(this._state)},r.prototype.getCurrentClient=function(){var t;return t=this.getCurrentFetchKey(),this._cache.get(t)},r.prototype.isFetching=function(t){var e;return e=this._cache.find(this.getFetchKey(t)),null!=e&&!e.isReady()},r.prototype.isNullState=function(t){return!(null!=t.context&&null!=t.contextData)},r.prototype.activateClient=function(t){return t.on("ready",this.onClientUpdated),t.on("updated",this.onClientUpdated),t.on("error",this.onClientError),t.startLiveUpdate(),t.isReady()?this.onClientUpdated(t.getFileActivity()):void 0},r.prototype.deactivateClient=function(t){return t.off("ready",this.onClientUpdated),t.off("updated",this.onClientUpdated),t.off("error",this.onClientError),t.stopLiveUpdate()},r.prototype.deactivateCurrentClient=function(){var t;return t=this.getCurrentClient(),null!=t?this.deactivateClient(t):void 0},r.prototype.fetchAndSend=function(t){var e,n,o,i,s,r,a;return e=t.actorId,i=t.context,s=t.contextData,a=t.oref,r=c(e,i,s,a),n=this._cache.get(r),null!=n?this.activateClient(n):(o=this.createFileActivityBoltClient({actorId:e,context:i,contextData:s,oref:a}),o.init(),this._cache.set(r,o),this.activateClient(o))},r.prototype.onClientUpdated=function(t){return this.sendActivity(t)},r.prototype.onClientError=function(t){throw t},r.prototype.sendActivity=function(t){return this._sendFileActivity(t)},r.prototype.createFileActivityBoltClient=function(t){return new s(t)},r.prototype.modify=function(t){var e;return e=this.getCurrentClient(),null!=e?(e.update(t),!0):!1},r}()})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define("modules/clean/file_viewer_interface_controller",["jquery","modules/clean/activity/activity","modules/clean/comments/models/preview_types","modules/clean/comments/utils","modules/clean/event_emitter","modules/clean/frame_messenger","modules/clean/keycode"],function(e,n,o,i,s,r){var a,l;return a=n.ActivityContext,l=function(){function n(e,n,i){switch(this._handleMessageFromWindow=t(this._handleMessageFromWindow,this),this._handleMessageFromChild=t(this._handleMessageFromChild,this),this._prepareImageInterface=t(this._prepareImageInterface,this),this._preparePdfJsInterface=t(this._preparePdfJsInterface,this),this.dispatchEvent=t(this.dispatchEvent,this),this._notifyEventsTriggered=t(this._notifyEventsTriggered,this),this.registerEventsCallbacks=t(this.registerEventsCallbacks,this),this._eventsHandler=null,this._eventEmitter=new s,this._previewType=n,this._previewSelector=i,this._previewType){case o.PDFJS:this._preparePdfJsInterface(e);break;case o.IMAGE:this._prepareImageInterface()}}return n.prototype.registerEventsCallbacks=function(t){return this._eventsHandler=t},n.prototype._notifyEventsTriggered=function(t,e){return"function"==typeof this._eventsHandler?this._eventsHandler(t,e):void 0},n.prototype.addListener=function(t,e){return this._eventEmitter.on(t,e)},n.prototype.removeListener=function(t,e){return this._eventEmitter.off(t,e)},n.prototype.once=function(t,e){return this._eventEmitter.once(t,e)},n.prototype.on=n.prototype.addListener,n.prototype.off=n.prototype.removeListener,n.prototype.dispatchEvent=function(t,e){switch(this._previewType){case o.PDFJS:return this._frameMessenger.postMessageToChildren(t,e);case o.IMAGE:return window.postMessage(JSON.stringify({action:t,parameters:e}),"*")}},n.prototype.destroy=function(){var t;switch(this._eventEmitter.removeAllListeners(),this._eventsHandler=null,this._previewType){case o.PDFJS:return null!=(t=this._frameMessenger)?t.stopListening():void 0;case o.IMAGE:return window.removeEventListener("message",this._handleMessageFromWindow)}},n.prototype._preparePdfJsInterface=function(){return this._frameMessenger=new r,this._frameMessenger.configureChildMessaging(this._getIframeQuery(),e.proxy(this._handleMessageFromChild,this),["annotation-hidden","annotation-placed","annotation-start-drag","annotation-end-drag","annotation-ui-enter","annotation-ui-over","annotation-ui-leave","annotation-ui-click","annotation-enter","annotation-leave","page-rendered","scroll","scale-change","on-keydown"]),this._frameMessenger.startListening()},n.prototype._prepareImageInterface=function(){return window.addEventListener("message",this._handleMessageFromWindow)},n.prototype._getIframeQuery=function(){return"#pdf-embed-iframe"},n.prototype._handleMessageFromChild=function(t){return this._eventEmitter.emit(t.action,t.parameters),"function"==typeof this._notifyEventsTriggered?this._notifyEventsTriggered(t.action,t.parameters):void 0},n.prototype._handleMessageFromWindow=function(t){var e,n,o;try{o=JSON.parse(t.data)}catch(t){return void(e=t)}return this._eventEmitter.emit(o.action,o.parameters),"function"==typeof this._notifyEventsTriggered?this._notifyEventsTriggered(o.action,o.parameters):void 0},n}()})}.call(this),function(){define("modules/clean/immutability_helper",["external/underscore","external/react","modules/core/types"],function(t,e,n){var o,i,s,r,a,l,c,u,d,p;return c=n.takes,o=n.Either,d=e.addons.update,p=c(o(Object,Array),Array,Function,function(t,e,n){var o,i;return i=function(t,e){var n;return n={},n[""+e]=t,n},o=e.reduceRight(i,{$apply:n}),d(t,o)}),a=function(t,e,n){return p(t,e,function(){return n})},i=c(o(Object,Array),Array,function(t,e){var n;return n=function(t,e){return null!=t?t[e]:void 0},e.reduce(n,t)}),s=function(t,e){return d(t,{$merge:e})},r=function(t,e){return d(t,{$push:e})},u=function(t,e){return d(t,{$unshift:e})},l=function(t,e){return d(t,{$splice:e})},{updateIn:p,setIn:a,getIn:i,splice:l,unshift:u,push:r,merge:s}})}.call(this),function(){define("modules/clean/react/activity/annotation_button",["external/react","external/underscore","jquery","modules/clean/datetime","modules/clean/annotations/annotation","modules/clean/image_preview_util","modules/core/i18n"],function(t,e,n,o,i,s,r){var a,l,c,u,d,p,h,m,f,_,v,y,g,b;return l=i.Annotation,h=i.AnnotationTypes,u=i.AnnotationSubtypes,g=r._,b=t.DOM,f=610,m=790,_=28,y=6,v=3,a=120,p=t.createClass({displayName:"AnnotationThumbnail",propTypes:{annotation:t.PropTypes.object,thumbnailUrl:t.PropTypes.string,shouldShowAnnotationUIOnImages:t.PropTypes.bool},getDefaultProps:function(){return{}},getInitialState:function(){return{}},_getThumbnail:function(t,e,n){var o;return this.props.thumbnailUrl?this._getThumbnailImageFromUrl():(o=_*e/n,b.div({className:"annotation-thumbnail-page",style:{width:o,height:_}},this._getAnnotationThumbnail(t,e,n,o,_)))},_getAnnotationThumbnail:function(t,n,o,i,s){var r,a,l,c,u,d,p,m,f,_,g,w,T,C,S,A,I,x;switch(r=this.props.annotation,r.type){case h.MARKER:return l=null!=t&&null!=(C=t[0].coordinates)?C[0]:void 0,b.div({className:"annotation-thumbnail-page__marker",style:{left:this._calculateThumbnailDistance(null!=l?l.x:void 0,n,i,y),top:this._calculateThumbnailDistance(null!=l?l.y:void 0,o,s,y)}});case h.HIGHLIGHT:for(A=[],T=r.getFirstPdfPage(),u=0,p=t.length;p>u;u++)c=t[u],c.page===T&&(a=c.coordinates[1].x-c.coordinates[0].x,A.push(b.div({className:"annotation-thumbnail-page__highlight",style:{left:this._calculateThumbnailDistance(c.coordinates[0].x,n,i),top:this._calculateThumbnailDistance(c.coordinates[0].y,o,s,v),width:this._calculateThumbnailDistance(a,n,i)}})));return A;case h.REGION:for(A=[],T=r.getFirstPdfPage(),d=0,m=t.length;m>d;d++)S=t[d],S.page===T&&(I=e.pluck(S.coordinates,"x"),x=e.pluck(S.coordinates,"y"),g=e.min(I),f=e.max(I),w=e.min(x),_=e.max(x),A.push(b.div({className:"annotation-thumbnail-page__region",style:{left:this._calculateThumbnailDistance(g,n,i),top:this._calculateThumbnailDistance(w,o,s),width:this._calculateThumbnailDistance(f-g,n,i),height:Math.abs(this._calculateThumbnailDistance(_,o,s)-this._calculateThumbnailDistance(w,o,s))}})));return A}},_getThumbnailImageFromUrl:function(){return b.div({className:"annotation-thumbnail-image"},b.img({src:this.props.thumbnailUrl}))},_getAnnotationText:function(){var t;return t=this.props.annotation.text_highlight.text,t.length>a&&(t=t.substring(0,a-3)+"..."),'"'+t+'"'},_calculateThumbnailDistance:function(t,e,n,o){var i;return null==o&&(o=0),n-=o,i=o/2,t/e*n+i},_translateCoordinates:function(t,e,n){var o,i,s,r,a,l,c,u,d,p,h;for(d=[],s=0,a=t.length;a>s;s++){for(o=t[s],i=[],u=o.coordinates,r=0,l=u.length;l>r;r++)c=u[r],p=e(c.x),h=n(c.y),i.push({x:p,y:h});d.push({coordinates:i,page:o.page})}return d},render:function(){var t,e,n,o,i,r;if(e=this.props.annotation,e.isImageAnnotation()){if(!this.props.shouldShowAnnotationUIOnImages)return null;t=s.getPreviewImage(),i=t.width(),o=t.height(),n=this._translateCoordinates(e.image_coordinates,function(t){return t*i},function(t){return t*o})}else i=f,o=m,null!=(null!=(r=e.pdf_coordinates)?r[0].page_size:void 0)&&(i=e.pdf_coordinates[0].page_size.width,o=e.pdf_coordinates[0].page_size.height),n=this._translateCoordinates(e.pdf_coordinates,function(t){return t},function(t){return o-t});return this._getThumbnail(n,i,o)}}),d=t.createFactory(p),c=t.createClass({displayName:"AnnotationButton",propTypes:{annotation:t.PropTypes.object,revision:t.PropTypes.object,isOldRevision:t.PropTypes.bool,onAnnotationButtonMouseUp:t.PropTypes.func,thumbnailUrl:t.PropTypes.string,shouldShowAnnotationUIOnImages:t.PropTypes.bool,isInThread:t.PropTypes.bool},_getAnnotationText:function(){var t;return t=this.props.annotation.text_highlight.text,t.length>a&&(t=t.substring(0,a-3)+"..."),'"'+t+'"'},_getLabelHeader:function(){return this.props.isInThread?g("Go to comment"):this._getPageText()},_getPageText:function(){return this.props.annotation.isPdfAnnotation()?g("Page %(page_number)s").format({page_number:this.props.annotation.getFirstPdfPage()}):this.props.annotation.isImageAnnotation()?g("Annotation"):void 0},_getLabelSubtext:function(){var t,e,n;return null!=this.props.revision.when&&!isNaN(new Date(null!=this.props.revision.when))&&this.props.isOldRevision?(n=o.ago(new Date(1e3*this.props.revision.when)),e=g("on older revision, updated %(time_ago)s").format({time_ago:n})):e=g("on latest revision"),this.props.isInThread?(t=this._getPageText(),g("%(page_text)s %(revision_text)s").format({page_text:t,revision_text:e})):e},onAnnotationButtonMouseUp:function(t){return this.props.onAnnotationButtonMouseUp(t)},render:function(){return b.a({className:"comment-annotation-button",onMouseUp:this.onAnnotationButtonMouseUp},b.div({className:"annotation-page-label"},d({annotation:this.props.annotation,thumbnailUrl:this.props.thumbnailUrl,shouldShowAnnotationUIOnImages:this.props.shouldShowAnnotationUIOnImages}),b.div({className:"annotation-thumbnail-label"},b.div({className:"annotation-thumbnail-label__page"},this._getLabelHeader()),b.div({className:"annotation-thumbnail-label__info"},this._getLabelSubtext()))),this.props.annotation.type===h.HIGHLIGHT?b.div({className:"annotation-thumbnail-text"},this._getAnnotationText()):void 0)}}),{AnnotationButtonClass:c,AnnotationThumbnailClass:p}})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/comment_activity_ui",["external/react","external/underscore","modules/core/exception","modules/clean/activity/activity","modules/clean/annotations/annotation","modules/clean/react/activity/resolve_button","modules/clean/react/activity/time_counter","modules/clean/react/modal","modules/core/i18n","modules/clean/viewer","modules/clean/activity/comment","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar","modules/clean/avatar/viewer_avatar","modules/clean/sticker_util","modules/clean/react/activity/annotation_button","modules/clean/comments/action_creators","modules/clean/comments/events","modules/clean/comments/utils","modules/clean/react/file_comments/threaded_comment_header"],function(e,n,o,i,s,r,a,l,c,u,d,p,h,m,f,_,v,y,g,b){var w,T,C,S,A,I,x,P,N,k,E,R,O,D,M,L,U,F;return U=o.assert,w=i.Activity,N=i.FileActivity,T=s.Annotation,I=s.AnnotationTypes,A=s.AnnotationSubtypes,R=l.SimpleModal,L=c._,S=_.AnnotationButtonClass,F=e.DOM,E=e.createFactory(r),D=e.createFactory(a),x=e.createFactory(p),k=e.createFactory(h),M=e.createFactory(m),C=e.createFactory(S),O=e.createFactory(b),P=e.createClass({displayName:"CommentActivityUI",propTypes:{parentActivity:e.PropTypes.instanceOf(w).isRequired,fileActivity:e.PropTypes.instanceOf(N).isRequired,comment_activity:e.PropTypes.object.isRequired,user:e.PropTypes.object.isRequired,shouldAnnotationButtonUseThumbnailUrls:e.PropTypes.bool,shouldAutoLinkify:e.PropTypes.bool,shouldUseSimpleModals:e.PropTypes.bool,shouldHidePhotoAvatars:e.PropTypes.bool,isReply:e.PropTypes.bool,shouldShowReplyButton:e.PropTypes.bool,onReplyButtonMouseUp:e.PropTypes.func,isVisibleAtMentions:e.PropTypes.bool,isOffline:e.PropTypes.bool,shouldShowAnnotationUIOnImages:e.PropTypes.bool,isInThread:e.PropTypes.bool,isExpanded:e.PropTypes.bool,truncateLength:e.PropTypes.number,threadHover:e.PropTypes.bool},getDefaultProps:function(){return{shouldAutoLinkify:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,shouldShowReplyButton:!1,isVisibleAtMentions:!1,isOffline:!1,shouldAnnotationButtonUseThumbnailUrls:!1,shouldShowAnnotationUIOnImages:!0,isExpanded:!0,isInThread:!1}},onAnnotationButtonMouseUp:function(){return v.revealAnnotation({commentActivity:this.props.comment_activity})},isPendingComment:function(){return this.props.comment_activity.isPending},isFailedPendingComment:function(){return this.isPendingComment()&&"FAILED"===this.props.comment_activity.status},onUpdateResolve:function(t){return v.setCommentResolved({commentActivityKey:this.props.comment_activity.activity_key,resolved:t})},onDeleteComment:function(t){var e;return e=this.props.shouldUseSimpleModals?"simple":"default",t.preventDefault(),R.show({title_text:L("Delete comment?"),body_html:L("Are you sure you want to delete this comment?"),cancel_text:L("Cancel"),confirm_text:L("Delete"),style:e,confirm_callback:function(t){return function(){return v.deleteComment({commentActivityKey:t.props.comment_activity.activity_key})}}(this)})},_isCommentForOldRevision:function(){var t,e;return e=null!=(t=this.props.comment_activity.comment.comment_metadata)?t.revision:void 0,null!=e&&!g.isRevisionEqual(e,this.props.fileActivity.latestRevision)},onReplyButtonMouseUp:function(){var t;return"function"==typeof(t=this.props).onReplyButtonMouseUp?t.onReplyButtonMouseUp():void 0},onRetryPendingComment:function(){return U(this.isPendingComment(),"Cannot retry posting non-pending comment"),v.postPendingComment({targetActivity:this.props.parentActivity,pendingCommentActivity:this.props.comment_activity})},_renderAnnotationLocation:function(t){var e,n;return e=T.createAnnotationFromDict(t.annotation),n=t.revision,F.div({className:"comment-annotation"},C({revision:n,annotation:e,isOldRevision:this._isCommentForOldRevision(),onAnnotationButtonMouseUp:this.onAnnotationButtonMouseUp,thumbnailUrl:this.props.shouldAnnotationButtonUseThumbnailUrls?t.thumbnailUrl:"",shouldShowAnnotationUIOnImages:this.props.shouldShowAnnotationUIOnImages,isInThread:this.props.isInThread}))},_renderAnnotationHeader:function(){var t,e,n,o;return e=this.props.comment_activity.comment,e.has_metadata()&&e.comment_metadata.has_annotation_data()?(n=e.comment_metadata,t=T.createAnnotationFromDict(n.annotation),o=n.revision,O({revision:o,annotation:t,isOldRevision:this._isCommentForOldRevision(),onAnnotationButtonMouseUp:this.onAnnotationButtonMouseUp,thumbnailUrl:this.props.shouldAnnotationButtonUseThumbnailUrls?n.thumbnailUrl:"",shouldShowAnnotationUIOnImages:this.props.shouldShowAnnotationUIOnImages,onUpdateResolve:this.onUpdateResolve,isOffline:this.props.isOffline,shouldShowResolveButton:!this.isPendingComment()&&this.props.user.is_signed_in&&!this.props.isReply,resolved:e.resolved})):void 0},renderPhoto:function(){var e,n,o;return n={dimension:32,defaultAvatar:new k({dimension:32,shape:"CIRCLE",initials:this.props.comment_activity.comment.commenter.initials})},this.props.shouldHidePhotoAvatars||""===this.props.comment_activity.comment.commenter.photo_circle_url||(n.photoUrl=this.props.comment_activity.comment.commenter.photo_circle_url),o=this.props.comment_activity.comment.commenter.id,e=t.call(u.get_viewer().get_user_ids(!0),o)>=0?new M(n):new x(n),F.div({className:"commenter-photo"},e)},renderCommentBody:function(){var t,e;return t=this.props.comment_activity.comment.raw_comment_text,e=d.convertRawCommentTextToReactDom(t,this.props.shouldAutoLinkify,this.props.isVisibleAtMentions,!this.props.isExpanded&&this.props.truncateLength)},renderBody:function(){var t,o,i,s,r,a,l,c,d;return d=u.get_viewer(),c=n.intersection(d.get_user_ids(!0),null!=(a=this.props.comment_activity.permissions)?a.user_ids_who_can_delete:void 0).length,t=(c||d.can_moderate_comments)&&!this.props.isOffline&&!this.isPendingComment(),o=this.props.comment_activity.comment,s=o.has_metadata()&&o.comment_metadata.has_annotation_data(),this.props.isExpanded&&s&&(r=this._renderAnnotationLocation(o.comment_metadata)),i=e.addons.classSet({"comment-body":!0,"has-annotation":s}),F.div({className:i},F.div({className:"comment-top-bar"},F.div({className:"commenter-name"},o.commenter.display_name),this.isPendingComment()||!this.props.user.is_signed_in||this.props.isReply?void 0:E({resolved:o.resolved,onUpdateResolve:this.onUpdateResolve,isOffline:this.props.isOffline})),o.has_metadata()&&o.comment_metadata.has_sticker_data()?F.div({className:"comment-sticker-body"},F.img({src:f.getStickerImageUrl(o.comment_metadata.get_sticker_id())})):F.span({},F.div({className:"comment-text"},this.renderCommentBody()),this.props.isExpanded?r:void 0),this.isFailedPendingComment()?F.div({className:"comment-bottom-bar"},F.div({className:"pending-comment--failed"},F.span({className:"pending-comment__warning"},L("Unable to post comment.")),F.a({className:"pending-comment__retry",onClick:this.onRetryPendingComment},L("Retry")))):!this.props.isInThread||this.props.shouldShowReplyButton||this.props.isExpanded?F.div({className:"comment-bottom-bar"},this.props.shouldShowReplyButton?this.props.isInThread&&this.props.isExpanded?void 0:(l=e.addons.classSet({"reply-button":!0,"thread-hover":this.props.threadHover}),F.a({className:l,onMouseUp:this.onReplyButtonMouseUp},L("Reply..."))):void 0,this.props.isExpanded?D({when_mses:o.when_mses}):void 0,this.props.isExpanded&&t?F.span({className:"delete"},F.div({className:"second-bottom-dot"}," · "),F.div({className:"delete-icon",onMouseDown:function(t){return function(e){return t.onDeleteComment(e)}}(this)},L("Delete"))):void 0):void 0)},render:function(){var t;return t=e.addons.classSet({comment:!0,resolved:this.props.comment_activity.comment.resolved,"comment--old-revision":this._isCommentForOldRevision(),"comment--reply":this.props.isReply,"comment--pending":this.isPendingComment(),expanded:this.props.isExpanded}),F.div({className:"comment-activity","data-comment-activity-key":this.props.comment_activity.activity_key},this.props.isInThread?this._renderAnnotationHeader():void 0,F.div({className:t},this.renderPhoto(),this.renderBody()))}})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/comment_input",["jquery","external/react","external/underscore","modules/core/browser","modules/core/exception","modules/core/i18n","modules/core/notify","modules/clean/activity/activity","modules/clean/activity/activity_user","modules/clean/contacts/types","modules/clean/contacts/util","modules/clean/gandalf_util","modules/clean/keycode","modules/clean/storage","modules/clean/react/activity/mentions_controller","modules/clean/react/activity/users_to_notify","modules/clean/react/button","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar","modules/clean/avatar/viewer_avatar","modules/clean/viewer","modules/clean/react/file_comments/logger","modules/clean/react/react_i18n","modules/constants/legacy"],function(e,n,o,i,s,r,a,l,c,u,d,p,h,m,f,_,v,y,g,b,w,T,C,S){var A,I,x,P,N,k,E,R,O,D,M,L,U,F,B,H;return U=r._,H=r.ungettext,A=l.Activity,P=l.FileActivity,x=l.CommentActivity,k=m.LocalStorage,O=C.R_,E=4e3,B=n.DOM,D=n.createFactory(n.addons.CSSTransitionGroup),R=n.createFactory(f),M=n.createFactory(_),I=n.createFactory(y),N=n.createFactory(g),L=n.createFactory(b),F=n.createFactory(v.button),n.createClass({displayName:"CommentInput",mixins:[n.addons.PureRenderMixin],propTypes:{activity:n.PropTypes.instanceOf(P).isRequired,usersToNotify:n.PropTypes.arrayOf(c).isRequired,metadata:n.PropTypes.object,onAddComment:n.PropTypes.func,onCancelComment:n.PropTypes.func,resizeCallback:n.PropTypes.func,positionDropdownCallback:n.PropTypes.func,onFocus:n.PropTypes.func,onBlur:n.PropTypes.func,user:n.PropTypes.instanceOf(c).isRequired,onShowNewComment:n.PropTypes.func,inBlankState:n.PropTypes.bool,enableNotifyText:n.PropTypes.bool,enableNoNotifyHint:n.PropTypes.bool,showNewComment:n.PropTypes.bool,shouldPopupsDropdown:n.PropTypes.bool,initialText:n.PropTypes.string,shouldInitiallyFocusInput:n.PropTypes.bool,shouldAlwaysInEditMode:n.PropTypes.bool,isCommentInputDisabled:n.PropTypes.bool,shouldEnableStickers:n.PropTypes.bool,onAddSticker:n.PropTypes.func,contactSearchLogger:n.PropTypes.object,enableImport:n.PropTypes.bool,shouldHidePhotoAvatars:n.PropTypes.bool,isReplyInput:n.PropTypes.bool,shouldUseSimpleModals:n.PropTypes.bool,shouldEnableCancelButton:n.PropTypes.bool,isOffline:n.PropTypes.bool,shouldShowAvatar:n.PropTypes.bool,onStickerDropdownShown:n.PropTypes.func,onStickerDropdownHidden:n.PropTypes.func,onContactsSelectorPopupShown:n.PropTypes.func,onContactsSelectorPopupHidden:n.PropTypes.func,onContactsSelectorSuggestionsUpdate:n.PropTypes.func,shouldDisableBubbleDropdownHideOnResize:n.PropTypes.bool},getInitialState:function(){var t,e,n,o;return t=!0,o=this.props.shouldAlwaysInEditMode,e=null!=this.props.initialText?this.props.initialText:this._getCommentLocalStorage(null!=(n=this.props.activity)?n.activity_key:void 0),e.length>0&&(t=!1,o=!0),{button_disabled:t,shouldShowPostButton:o,initialText:e,users_to_notify:null!=this.props.usersToNotify,commentMetadata:null}},getDefaultProps:function(){return{onShowNewComment:e.noop,shouldAlwaysInEditMode:!1,isCommentInputDisabled:!1,enableImport:!0,shouldHidePhotoAvatars:!1,isReplyInput:!1,shouldEnableCancelButton:!1,isOffline:!1,shouldShowAvatar:!0,metadata:null}},componentDidMount:function(){var t;return t=function(t,n){var o;return o=(null!=n?n.getDOMNode():void 0)||null,o?t.target===o||e.contains(o,t.target):!1},e(this.getDOMNode()).on("click.comment-input",function(e){return function(n){return t(n,e.refs.postButton)&&e.verifySubscribersBeforePost(),t(n,e.refs.showNewCommentButton)?e.props.onShowNewComment():void 0}}(this))},componentWillUnmount:function(){return e(this.getDOMNode()).off(".comment-input")},componentWillReceiveProps:function(t){return this.updateNotificationCount(t.usersToNotify)},_contactsSelectorPopupShown:function(){var t;return T.log_event(S.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.LITTLE_MAN_BUTTON,this.props.user.id),"function"==typeof(t=this.props).onContactsSelectorPopupShown?t.onContactsSelectorPopupShown():void 0},_contactsSelectorPopupHidden:function(){var t;return"function"==typeof(t=this.props).onContactsSelectorPopupHidden?t.onContactsSelectorPopupHidden():void 0},_onAtSignKeyPress:function(){return this.props.user.is_signed_in?T.log_event(S.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.AT_SIGN_KEYPRESS,this.props.user.id):void 0},_onNoAtSignKeyPress:function(){return T.log_event(S.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.NO_AT_SIGN_KEYPRESS,this.props.user.id)},_contactPopupSelectedCallback:function(){return s.assert(this.props.user.is_signed_in,"Contact selected from popup when user is logged out"),T.log_event(S.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SELECTED,this.props.activity.activity_key,null,S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.LITTLE_MAN_BUTTON,this.props.user.id)},_contactSelectedCallback:function(t){var e;return s.assert(this.props.user.is_signed_in,"Contact selected when user is logged out"),e=t?S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.NO_AT_SIGN_KEYPRESS:S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.AT_SIGN_KEYPRESS,T.log_event(S.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SELECTED,this.props.activity.activity_key,null,e,this.props.user.id)},_onStickerPopupShown:function(){return T.log_event(S.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_STICKERS_SHOWN,this.props.activity.activity_key,null,S.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.STICKER_BUTTON,this.props.user.id)},onMentionsFocus:function(t){var e;return this.togglePostButton(!0),"function"==typeof(e=this.props).onFocus?e.onFocus(t):void 0},onMentionsBlur:function(){var t;if("function"==typeof(t=this.props).onBlur&&t.onBlur(),this.refs.mentions.getEncodedMessage()){if(this.shouldSaveText())return this._storeCommentLocalStorage(this.refs.mentions.getRawMessage(),this.props.activity.activity_key)}else if(!this.props.shouldAlwaysInEditMode)return this.togglePostButton(!1)},onMentionsCancel:function(){var t;return"function"==typeof(t=this.props).onCancelComment?t.onCancelComment():void 0},onKeyDown:function(t){return t.keyCode===h.ENTER&&(t.ctrlKey||t.metaKey)?(this.verifySubscribersBeforePost(),t.preventDefault()):void 0},onKeyUp:function(){return this._setPostButtonState(),this.updateNotificationCount(this.props.usersToNotify)},onPaste:function(t){return t.clipboardData.getData("text/plain").length>E?(a.error(U("The text you're trying to paste is too long.")),t.preventDefault()):setTimeout(function(t){return function(){return t._setPostButtonState(),t.updateNotificationCount(t.props.usersToNotify)}}(this),10)},refreshDropdownDirection:function(){var t;return"function"==typeof(t=this.props).positionDropdownCallback?t.positionDropdownCallback():void 0},togglePostButton:function(t){return this.setState({shouldShowPostButton:t},function(e){return function(){var n;return"function"==typeof(n=e.props).resizeCallback?n.resizeCallback(t):void 0}}(this))},shouldSaveText:function(){return!this.props.user.is_signed_in||!this.props.user.is_email_verified},updateNotificationCount:function(t){var e,n,i,s,r,a,l,u,d,p,h,m,f;if(null!=t){if(m=function(){var e,n,o;for(o=[],e=0,n=t.length;n>e;e++)f=t[e],o.push(f.unique_id);return o}(),d=this.refs.mentions.extractMentions(),u=function(){var t,e,n;for(n=[],t=0,e=d.length;e>t;t++)l=d[t],n.push(l.dbx_account_id||l.identifier);return n}(),e=o.union(m,u).sort(),n=o.pluck(this.state.users_to_notify,"id").sort(),o.isEqual(n,e))return;

for(p=o.object(u,d),r=o.difference(e,m),h=o.clone(t),i=0,a=r.length;a>i;i++)s=r[i],h.push(new c({id:s,display_name:p[s].name}));return this.setState({users_to_notify:h})}},updateCurrentNotificationCount:function(){return this.updateNotificationCount(this.props.usersToNotify)},setCursorToEndOfInput:function(){return this.refs.mentions.setCursorToEndOfInput()},_onSkipAddMention:function(){return this.postComment()},_setPostButtonState:function(){var t;return t=""===this.refs.mentions.getEncodedMessage(),this.state.button_disabled!==t?this.setState({button_disabled:t}):void 0},verifySubscribersBeforePost:function(){var t,e,n,o;return this.props.user.is_signed_in&&(t=function(){var t,e,n,i;for(n=this.state.users_to_notify,i=[],t=0,e=n.length;e>t;t++)o=n[t],o.id!==this.props.user.id&&i.push(o);return i}.call(this),0===t.length&&0===(null!=(e=this.props.activity.comment_activities)?e.length:void 0)&&this.props.enableNoNotifyHint)?void(null!=(n=this.refs.mentions)&&n.showNoNotifyHint()):this.postComment()},postComment:function(){var t,e;return(e=this.refs.mentions.getEncodedMessage())?e.length>E?void a.error(U("The comment is too long.")):(this.shouldSaveText()||(this.refs.mentions.disableMentions(),this.refs.mentions.clearTextField(),this._setPostButtonState(),this.togglePostButton(!1)),"function"==typeof(t=this.props).onAddComment?t.onAddComment(e):void 0):void 0},focusInput:function(){var t;return null!=(t=this.refs.mentions)?t.focusInput():void 0},getRawCommentInput:function(){var t;return null!=(t=this.refs.mentions)?t.getRawMessage():void 0},getPlaceholderText:function(){return U(this.props.isReplyInput?"Reply...":this.props.inBlankState?"Write a comment":"Comment or @mention")},_usersToNotifyToContacts:function(t){var e,n,o,i;for(e=[],n=0,o=t.length;o>n;n++)i=t[n],i.id!==this.props.user.id&&e.push(d.activityUserToContact(i,Number.MAX_VALUE));return e},_onCancelMouseUp:function(){var t;return"function"==typeof(t=this.props).onCancelComment?t.onCancelComment():void 0},_clearCommentLocalStorage:function(){return k.set("tmp-file-comment",null)},_getCommentLocalStorage:function(t){var n,o;return o=k.get("tmp-file-comment"),n="",o&&o.activity_key===t&&((new Date).getTime()-o.time<3e5&&(n=o.text),this._clearCommentLocalStorage()),e("<div/>").html(n).text()},_storeCommentLocalStorage:function(t,n){var o;return o=e("<div/>").text(t).html(),k.set("tmp-file-comment",{activity_key:n,text:o,time:(new Date).getTime()})},_renderShowNewComment:function(){var t,e;return e=[],this.props.showNewComment&&(t=B.a({className:"show-new-comment-button",ref:"showNewCommentButton"},B.span({className:"show-new-comment-icon",key:key}),B.span({className:"show-new-comment-text"},U("New Comment"))),e=B.div({className:"comment-show-new-comment"},t)),D({transitionName:"comment-show-new-comment",component:"div"},e)},_renderCommentBox:function(){var t,e;return t=null!=this.props.usersToNotify?this.props.usersToNotify:[],e=R({ref:"mentions",placeholder_text:this.getPlaceholderText(),initialText:this.state.initialText,contactSearchLogger:this.props.contactSearchLogger,user:this.props.user,shouldPopupsDropdown:this.props.shouldPopupsDropdown,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,shouldAlwaysInEditMode:this.props.shouldAlwaysInEditMode,showMentionsHelper:"ON"===p.getGandalfRule("comments_add_mention_dropdown")&&this.props.user.is_signed_in,enableNoAtMentions:"ON"===p.getGandalfRule("comments_no_at_mentions")&&this.props.user.is_signed_in,onFocus:this.onMentionsFocus,onBlur:this.onMentionsBlur,onCancel:this.onMentionsCancel,position_contacts_callback:this.props.positionDropdownCallback,resizeCallback:this.props.resizeCallback,onKeyUp:this.onKeyUp,onKeyDown:this.onKeyDown,onPaste:this.onPaste,onMention:this.updateCurrentNotificationCount,contactsSelectorPopupShown:this._contactsSelectorPopupShown,contactsSelectorPopupHidden:this._contactsSelectorPopupHidden,onContactsSelectorSuggestionsUpdate:this.props.onContactsSelectorSuggestionsUpdate,onAtSignKeyPress:this._onAtSignKeyPress,onNoAtSignKeyPress:this._onNoAtSignKeyPress,contactPopupSelectedCallback:this._contactPopupSelectedCallback,contactSelectedCallback:this._contactSelectedCallback,onSkipAddMention:this._onSkipAddMention,enableImport:this.props.enableImport,extraContacts:this._usersToNotifyToContacts(t),shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,shouldEnableStickers:this.props.shouldEnableStickers,onStickerPopupShown:this._onStickerPopupShown,onAddSticker:this.props.onAddSticker,onStickerDropdownShown:this.props.onStickerDropdownShown,onStickerDropdownHidden:this.props.onStickerDropdownHidden,shouldDisableBubbleDropdownHideOnResize:this.props.shouldDisableBubbleDropdownHideOnResize}),B.div({className:"comment-box"},e,B.div({className:"post-area",ref:"postArea"},this.props.enableNotifyText?this._renderTooltipContainer():void 0,this._renderButtonsContainer()))},_renderCommenterPhoto:function(){var e,n,o,i;return n={dimension:32,defaultAvatar:new N({dimension:32,shape:"CIRCLE",initials:this.props.user.initials||"?"})},this.props.shouldHidePhotoAvatars||(n.photoUrl=this.props.user.photo_circle_url),o=null!=(i=this.props.user)?i.id:void 0,e=t.call(w.get_viewer().get_user_ids(!0),o)>=0?new L(n):new I(n),B.div({className:"commenter-photo"},this.props.shouldShowAvatar?e:void 0)},_renderTooltipContainer:function(){return this.props.isOffline?B.div({className:"comment-box-text"},O({},"Posting will be re-enabled when you are online")):B.div({ref:"usersToNotify",className:"tooltip-container"},M({usersToNotify:this.state.users_to_notify,user:this.props.user,shouldShowExtraText:!this.state.shouldShowPostButton}))},_renderCancelButton:function(){return B.a({className:"cancel-button",onMouseUp:this._onCancelMouseUp},U("Cancel"))},_renderButtonsContainer:function(){var t,e,n,o;return n=!this.state.shouldShowPostButton,e=this.state.button_disabled||this.props.isOffline,t={className:"post-button",disabled:e,ref:"postButton"},o=F(t,U("Post")),B.div({className:"button-container",hidden:n},o,this.props.shouldEnableCancelButton?this._renderCancelButton():void 0)},render:function(){var t;return t=n.addons.classSet({"comment-field":!0,"comment-field--disabled":this.props.isCommentInputDisabled||this.props.isOffline}),B.div({className:t},this._renderShowNewComment(),this._renderCommenterPhoto(),this._renderCommentBox(),this.props.isCommentInputDisabled||this.props.isOffline?B.div({className:"comment-field__diabled"},""):void 0)}})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/contacts_selector",["external/react","external/typeahead.bundle","jquery","modules/clean/keycode","modules/clean/ajax","modules/clean/activity/activity_user","modules/clean/contacts/bloodhound_contacts","modules/clean/contacts/list","modules/clean/contacts/types","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar","modules/clean/profile_services/profile_services_constants","modules/clean/profile_services/profile_services_link","modules/clean/react/sprite","modules/core/i18n","modules/core/exception"],function(e,n,o,i,s,r,a,l,c,u,d,p,h,m,f){var _,v,y,g,b,w,T,C;return g=h.LinkedProfileServices,w=h.ProfileServicesLinkingHandler,T=e.addons.classSet,C=e.DOM,b=5,v=99,y=3,_=e.createClass({displayName:"ContactsSelector",propTypes:{showNullHint:e.PropTypes.bool,contactSelectedCallback:e.PropTypes.func,contactHighlightedCallback:e.PropTypes.func,contactSearchLogger:e.PropTypes.object,noAtMentionTriggerCallback:e.PropTypes.func,resultsLimit:e.PropTypes.number,matchFullQUery:e.PropTypes.bool,noMatchesText:e.PropTypes.string,user:e.PropTypes.object,showContactsInNullState:e.PropTypes.bool,x_offset:e.PropTypes.number,y_offset:e.PropTypes.number,enableImport:e.PropTypes.bool,show_contacts:e.PropTypes.bool,should_dropdown:e.PropTypes.bool,last_keydown:e.PropTypes.number,extraContacts:e.PropTypes.arrayOf(e.PropTypes.object),shouldHidePhotoAvatars:e.PropTypes.bool},getInitialState:function(){return this.contactSelectedCallback=this.props.contactSelectedCallback,null!=this.props.user&&this.props.user.is_signed_in&&this.props.enableImport&&(this.profile_services=g.get_linked_profile_services_for_user(this.props.user.id)),{suggestions:[],matches_count:0,focused_row:null,query:"",show_no_results:!1,hover_import_contact:!1,show_import_list:!1}},getDefaultProps:function(){return{contactSelectedCallback:void 0,should_dropdown:!0,show_contacts:!1,enableImport:!0,x_offset:0,y_offset:0,last_keydown:-1,showNullHint:!0,showContactsInNullState:!1,noMatchesText:f._("No matches. Keep typing an email address."),matchFullQUery:!1,extraContacts:[],shouldHidePhotoAvatars:!1}},componentWillMount:function(){return this.contacts=new a,this.contacts.setExtraContacts(this.props.extraContacts),0===this.state.query.length&&this.props.showContactsInNullState?this.get_suggestions(""):void 0},componentDidMount:function(){var t,e;return this.$typeahead_container=o(null!=(t=this.refs.suggestionsContainer)?t.getDOMNode():void 0),this.$typeahead_suggestions=o(null!=(e=this.refs.suggestionsList)?e.getDOMNode():void 0),this._position_contacts_list(),this._toggle_contacts_list(),this.state.show_contacts?void 0:this._reset_import_state()},componentWillReceiveProps:function(t){return this.contacts.setExtraContacts(t.extraContacts),0===this.state.query.length&&t.showContactsInNullState!==this.props.showContactsInNullState?this.get_suggestions(""):void 0},componentDidUpdate:function(){var t,e,n;return this.$typeahead_container=o(null!=(e=this.refs.suggestionsContainer)?e.getDOMNode():void 0),this.$typeahead_suggestions=o(null!=(n=this.refs.suggestionsList)?n.getDOMNode():void 0),this._position_contacts_list(),this._toggle_contacts_list(),"function"==typeof(t=this.props).contactHighlightedCallback?t.contactHighlightedCallback(this._get_suggestion_row(this.state.focused_row)):void 0},_reset_import_state:function(){return this.setState({hover_import_contact:!1,show_import_list:!1})},_append_import_to_suggestions:function(t){var e,n,o,i;for(o=p.contact_services(),e=0,n=o.length;n>e;e++)i=o[e],t.push(this._append_provider(i));return t},_append_provider:function(t){var e;return e=p.to_name(t),this.profile_services.service_is_connected(t)&&(e+=f._(" (Connected)")),{type:v,provider:t,name:e,photo_url:p.to_img(t)[0]}},_import_contacts_mouseover:function(){return this.setState({hover_import_contact:!0})},_import_contacts_mouseleave:function(){return this.setState({hover_import_contact:!1})},_mouse_down_import_contacts:function(t){return t.preventDefault(),this.setState({hover_import_contact:!this.state.hover_import_contact,show_import_list:!this.state.show_import_list})},_focus_suggestion_row:function(t){return null!=t&&this.state.focused_row!==t||null===t?this.setState({focused_row:t}):void 0},_focus_suggestion_row_mouseover:function(t){var e,n;return e=o(t.currentTarget),n=e.index(),n>-1?this._focus_suggestion_row(n):void 0},_get_suggestion_row:function(){return this.$typeahead_suggestions.find(".suggestion-row.focused")},_get_suggestions_callback:function(t,e,n){var o,s,r,a,u;return this.isMounted()?(e=function(){var t,n,o;for(o=[],t=0,n=e.length;n>t;t++)r=e[t],r.type!==c.NEW_STYLE_GROUP&&o.push(r);return o}(),e=l.sortContactsByTeamFirst(e),n||(e=t.length>=b?this._getApproximateNameMatches(t,e):this._getExactFirstOrLastNameMatches(t,e)),this.matchesCountFromBloodhoundContacts=e.length,e=e.slice(0,this.props.resultsLimit),a=e.length,u=0===a&&this.props.last_keydown!==i.SPACE&&t.indexOf(" ")<0||0===a&&this.props.matchFullQUery,n||"function"==typeof(s=this.props).noAtMentionTriggerCallback&&s.noAtMentionTriggerCallback(a),this.props.enableImport&&0===a?e=this._append_import_to_suggestions(e):a>0&&this._reset_import_state(),this.props.should_dropdown?o=0:(o=e.length-1,e.reverse()),this.setState({suggestions:e,focused_row:o,show_no_results:u,matches_count:a})):void 0},_has_suggestion_row_at_index:function(t){return null!=t&&t>=0&&t<this.get_suggestions_count()},_mouse_down_select_suggestion:function(t){return t.preventDefault(),this.select_suggestion(t.currentTarget)},_position_contacts_list:function(){var t,e;return e=this.$typeahead_container.parent(),t=this.$typeahead_container.width(),t+this.props.x_offset>e.width()?this.$typeahead_container.css("left",e.width()-t):this.$typeahead_container.css("left",this.props.x_offset),this.props.should_dropdown?this.$typeahead_container.css("top",this.props.y_offset):this.$typeahead_container.css("top",this.props.y_offset-this.$typeahead_container.height()-12)},_toggle_contacts_list:function(){return this.props.show_contacts&&(this._matches_count()>0||0===this.state.query.length||this.state.show_no_results&&this.state.query.length)?this.$typeahead_container.show():this.$typeahead_container.hide()},_matches_count:function(){return this.state.matches_count},_getExactFirstOrLastNameMatches:function(e,n){var o;return function(){var i,s,r;for(r=[],i=0,s=n.length;s>i;i++)o=n[i],t.call(o.name_tokens,e)>=0&&r.push(o);return r}()},_getApproximateNameMatches:function(t,e){var n,o,i,s,r,a,l,c;for(a=[],n=0,i=e.length;i>n;n++)for(r=e[n],c=r.name_tokens,o=0,s=c.length;s>o;o++)if(l=c[o],0===l.indexOf(t)){a.push(r);break}return a},get_suggestions:function(t,e){return null==e&&(e=!0),null!=this.props.user&&this.props.user.is_signed_in?(this.contacts.get(t,function(n){return function(o){return n._get_suggestions_callback(t,o,e)}}(this)),this.setState({query:t})):void 0},get_suggestions_count:function(){return this.props.show_contacts?this.$typeahead_suggestions.children().size():0},navigate_suggestions:function(t){var e,n,o,s,r;if(e=t.keyCode||t.which||t.charCode,t.keyCode===i.ENTER||t.keyCode===i.TAB){if(t.preventDefault(),this._has_suggestion_row_at_index(this.state.focused_row))return r=this._get_suggestion_row(this.state.focused_row),this.select_suggestion(r)}else if(((o=t.keyCode)===i.UP||o===i.DOWN)&&(n=this.get_suggestions_count(),n>0))if(t.keyCode===i.UP){if(s=null!=this.state.focused_row?this.state.focused_row:n,0!==this.state.focused_row)return this._focus_suggestion_row((s-1)%n)}else if(t.keyCode===i.DOWN&&(s=null!=this.state.focused_row?this.state.focused_row:-1,this.state.focused_row!==n-1))return this._focus_suggestion_row((s+1)%n)},select_suggestion:function(t){var e,n,i;return e=o(t),e.data("type")===v?void(null!=this.props.user&&this.props.user.is_signed_in&&(n=new w,n.auth_service_with_user(String(e.data("provider")),this.props.user.id,function(t){return w.show_import_notifications(t)},"contact-importer-modal"))):(null!=this.props.contactSearchLogger&&(i={sort_variant:null,context:"mentions",search_expr:this.state.query,selected_pos:this.state.focused_row,num_query_results:this.matchesCountFromBloodhoundContacts,contact_type:e.data("type"),contact_id:e.data("identifier"),contact_name:e.data("name"),did_select_suggestion:!0},this.props.contactSearchLogger.add_record(i)),null!=this.contactSelectedCallback&&this.contactSelectedCallback(e),this.isMounted()?this.setState({focused_row:null,suggestions:[]}):void 0)},render:function(){var t,n,o,i;return n=e.addons.classSet({"contacts-list-suggestions":!0,"animating-down":this.props.show_contacts&&!this.props.should_dropdown,"animating-up":this.props.show_contacts&&this.props.should_dropdown}),C.div({className:n,ref:"suggestionsContainer"},this.props.show_contacts&&this.props.user?this.props.user.is_signed_in?0===this.state.query.length&&this.props.showNullHint&&!this.props.showContactsInNullState?C.div({className:"suggestion-row empty-state-row"},f._("Mention someone by name or email")):this.state.query.length||0===this.state.query.length&&this.props.showContactsInNullState?(t=C.div({ref:"suggestionsList"},function(){var t,e,o,s;for(o=this.state.suggestions,s=[],t=0,e=o.length;e>t;t++)i=o[t],s.push(function(t){return function(e){var o,i,s,a,l,p,h,m,_;return n={"import-row":e.type===v,"suggestion-row":!0,focused:null!=t.state.focused_row&&t.state.suggestions.indexOf(e)===t.state.focused_row},a=T(n),e.type===c.EMAIL?(m=e.email,l=e.email):e.type===c.FB?(m="fb_"+e.fb_id,l="Facebook Contact"):e.type===c.NEW_STYLE_GROUP?(m=e.group_id,l="Group"):e.type===v?(m="Import-"+e.name,s=C.img({src:e.photo_url})):e.type===c.DBX_ID&&(m=e.dbx_account_id,l=f._("Dropbox User")),p=!1,null!=e.name&&e.name.length>0?_=e.name:null!=e.email&&(p=!0,_=e.email,l=null),e.type===v||null==e.photo_url&&null==_||(p?h="@":(o=new r({display_name:_}),h=o.initials),i={dimension:32,defaultAvatar:new d({dimension:32,shape:"CIRCLE",initials:h})},t.props.shouldHidePhotoAvatars||(i.photoUrl=e.photo_url),s=new u(i)),C.div({key:m,className:a,"data-identifier":m,"data-name":_,"data-type":e.type,"data-photo-url":e.photo_url,"data-dbx-account-id":e.dbx_account_id||null,"data-provider":e.provider||null,onMouseDown:function(e){return t._mouse_down_select_suggestion(e)},onMouseEnter:function(e){return t._focus_suggestion_row_mouseover(e)}},C.div({className:"suggestion-wrapper"},s?C.div({className:"suggestion-avatar"},s):void 0,C.div({className:"suggestion-info"},null!=_?C.div({className:"suggestion-name"},_):void 0,null!=l?C.div({className:"suggestion-identifier"},l):void 0)))}}(this)(i));return s}.call(this)),this.state.show_no_results?C.div({},C.div({className:"suggestion-row empty-state-row"},C.div({className:"empty-state-row-text"},this.state.hover_import_contact||this.state.show_import_list?f._("Import Contacts"):this.props.noMatchesText),this.props.enableImport?(o={"import-contacts":!0,active:null!=this.state.show_import_list},C.a({className:T(o),onMouseDown:function(t){return function(e){return t._mouse_down_import_contacts(e)}}(this),onMouseEnter:function(t){return function(e){return t._import_contacts_mouseover(e)}}(this),onMouseLeave:function(t){return function(e){return t._import_contacts_mouseleave(e)}}(this)},m({group:"web",name:"user_add"}))):void 0),this.state.show_import_list?C.div({className:T({"suggestion-row-top-divider":!0,"animating-down":this.props.should_dropdown,"animating-up":!this.props.should_dropdown})},t):void 0):this._matches_count()>0?t:void 0):void 0:C.div({className:"suggestion-row empty-state-row"},f._("Login to @mention your contacts")):void 0)}})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/contacts_selector_popup",["jquery","external/react","modules/core/browser","modules/core/exception","modules/core/i18n","modules/clean/activity/activity","modules/clean/contacts/types","modules/clean/keycode","modules/clean/react/activity/contacts_selector","modules/clean/react/react_i18n","modules/clean/validators/validators"],function(e,n,o,i,s,r,a,l,c,u,d){var p,h,m,f,_;return m=n.DOM,h=u.R_,_=[l.UP,l.DOWN,l.ESC,l.ENTER,l.TAB],f=d.check(d.create(["EmailValidator"])),p=n.createClass({displayName:"ContactsSelectorPopup",propTypes:{showContactsInNullState:n.PropTypes.bool,shouldShowNoNotifyHint:n.PropTypes.bool,should_dropdown:n.PropTypes.bool,user:n.PropTypes.object,contactHighlightedCallback:n.PropTypes.func,contactSelectedCallback:n.PropTypes.func,contactSearchLogger:n.PropTypes.object,emailEnteredCallback:n.PropTypes.func,clearContactHighlightedCallback:n.PropTypes.func,onAddPeopleMouseUp:n.PropTypes.func,onSkipAddMention:n.PropTypes.func,enableImport:n.PropTypes.bool,extraContacts:n.PropTypes.arrayOf(n.PropTypes.object),shouldHidePhotoAvatars:n.PropTypes.bool},getInitialState:function(){return{query:"",show_contacts:!0,last_keydown:-1,shouldShowNoNotifyHint:!1}},getDefaultProps:function(){return{showContactsInNullState:!0,enableImport:!0,extraContacts:[],shouldHidePhotoAvatars:!1}},showNoNotifyHint:function(){var t;return this.setState({shouldShowNoNotifyHint:!0}),"function"==typeof(t=this.props).clearContactHighlightedCallback?t.clearContactHighlightedCallback():void 0},contactHighlightedCallback:function(t){var e;return i.assert(!this.state.shouldShowNoNotifyHint,"Should not have highlight callback in no notify state"),"function"==typeof(e=this.props).contactHighlightedCallback?e.contactHighlightedCallback(t):void 0},contactSelectedCallback:function(t){var e;return this._resetInput(),"function"==typeof(e=this.props).contactSelectedCallback?e.contactSelectedCallback(t):void 0},_resetInput:function(){return this.setState({query:""}),e(this.refs.contactSelectorPopupInput.getDOMNode()).val(""),this.refs.contactSelectorPopup.get_suggestions("")},_logEmailEntered:function(t){var e;return null!=this.props.contactSearchLogger?(e={sort_variant:null,context:"mentions",contact_type:a.EMAIL,contact_id:t,did_select_suggestion:!1},this.props.contactSearchLogger.add_record(e)):void 0},_onInputKeyDown:function(t){var e,n,i;if(n=t.keyCode||t.which||t.charCode,null!=o.msie&&n===l.ENTER){if(i=t.target.value,this.refs.contactSelectorPopup.get_suggestions_count()>0)return this.refs.contactSelectorPopup.navigate_suggestions(t);if(f(i))return"function"==typeof(e=this.props).emailEnteredCallback&&e.emailEnteredCallback(i),this._logEmailEntered(i)}},_onInputKeyUp:function(e){var n,o,i;if(o=e.keyCode||e.which||e.charCode,i=e.target.value,null!=this.refs.contactSelectorPopup){if(!(t.call(_,o)>=0))return this.setState({query:i}),this.refs.contactSelectorPopup.get_suggestions(i);if(this.refs.contactSelectorPopup.get_suggestions_count()>0)return this.refs.contactSelectorPopup.navigate_suggestions(e);if(o===l.ENTER&&f(i))return"function"==typeof(n=this.props).emailEnteredCallback&&n.emailEnteredCallback(i),this._logEmailEntered(i)}},_onAddPeopleMouseUp:function(t){var n;return this.setState({shouldShowNoNotifyHint:!1},function(t){return function(){var n;return e(null!=(n=t.refs.contactSelectorPopupInput)?n.getDOMNode():void 0).focus()}}(this)),"function"==typeof(n=this.props).onAddPeopleMouseUp?n.onAddPeopleMouseUp(t):void 0},_onSkipAddMention:function(t){var e;return"function"==typeof(e=this.props).onSkipAddMention?e.onSkipAddMention(t):void 0},render:function(){var t,e,n;return m.div({className:"contacts-selector-popup"},this.state.shouldShowNoNotifyHint?m.div({className:"contacts-selector-hint"},"Your comment won't notify anyone.",m.div({}),m.a({className:"",onMouseUp:this._onAddPeopleMouseUp},"Add people"),m.span({className:"bottom-dot"}," · "),m.a({className:"",onMouseUp:this._onSkipAddMention},"Just for me")):(e=m.div({className:"contacts-selector-popup-input-wrapper"},m.input({ref:"contactSelectorPopupInput",onKeyDown:this._onInputKeyDown,onKeyUp:this._onInputKeyUp,placeholder:"Type an email or name"})),t=this.state.query.trim().length>0||this.props.showContactsInNullState?m.hr({className:"separator"}):m.span({}),n=c({ref:"contactSelectorPopup",contactSelectedCallback:this.contactSelectedCallback,contactHighlightedCallback:this.contactHighlightedCallback,contactSearchLogger:this.props.contactSearchLogger,show_contacts:this.state.show_contacts,should_dropdown:this.props.should_dropdown,y_offset:0,x_offset:0,user:this.props.user,last_keydown:this.state.last_keydown,showNullHint:!1,showContactsInNullState:this.props.showContactsInNullState,matchFullQUery:!0,resultsLimit:5,enableImport:this.props.enableImport,extraContacts:this.props.extraContacts,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars}),this.props.should_dropdown?[e,t,n]:[n,t,e]))}})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/like_bar",["external/react","modules/core/i18n","modules/core/notify","modules/clean/activity/activity","modules/clean/react/image","modules/clean/react/tooltip","modules/clean/static_urls","modules/clean/viewer","modules/clean/comments/action_creators"],function(e,n,o,i,s,r,a,l,c){var u,d,p,h,m,f,_,v,y;return f=n._,v=a.static_url,_=e.DOM,y=l.get_viewer(),u=i.ActivityType,d=e.createFactory(s),m=e.createFactory(r.Tooltip),h=15,p=e.createClass({displayName:"LikeBar",propTypes:{activity:e.PropTypes.object.isRequired,user:e.PropTypes.object.isRequired,isOffline:e.PropTypes.bool},getDefaultProps:function(){return{isOffline:!1}},is_liked_by_viewing_user:function(){var e,n;return this.props.user.is_signed_in?(n=this.props.user.id,t.call(function(){var t,n,o,i;for(o=this.props.activity.likes,i=[],t=0,n=o.length;n>t;t++)e=o[t],i.push(e.liker.id);return i}.call(this),n)>=0):void 0},addLike:function(){return c.setCommentLiked({commentActivityKey:this.props.activity.activity_key,liked:!0})},removeLike:function(){return c.setCommentLiked({commentActivityKey:this.props.activity.activity_key,liked:!1})},getInitialState:function(){return{like_added:!1}},onLikeClicked:function(){var t;return this.props.isOffline?(t=f(this.is_liked_by_viewing_user()?"Cannot unlike comments while offline":"Cannot like comments while offline"),o.error(t)):this.is_liked_by_viewing_user()?this.removeLike():this.addLike()},render:function(){var t,n,o,i,s,a,l,c,u;return c=this.props.activity.likes,u=c.length,this.is_liked_by_viewing_user()?(n=v("/static/images/commenting/bluestar-vflwfsjbk.png"),o=v("/static/images/commenting/bluestar@2x-vflQOnE8w.png")):(n=v("/static/images/commenting/star-vflyDabKg.png"),o=v("/static/images/commenting/star@2x-vflHL5dvN.png")),t=e.addons.classSet({"like-img":!0,animating:this.is_liked_by_viewing_user()&&this.state.like_added}),l=function(){var t,e,n;for(n=[],t=0,e=c.length;e>t;t++)i=c[t],n.push(i.liker);return n}(),l=l.slice(0,h),c.length>h&&l.push({id:"extra",display_name:f("%(num_extra)d more...").format({num_extra:c.length-h})}),s=u>0?_.div({className:"liker-names"},function(){var t,e,n;for(n=[],t=0,e=l.length;e>t;t++)a=l[t],n.push(function(){return function(t){return _.div({key:t.id},t.display_name)}}(this)(a));return n}.call(this)):this.props.user.is_signed_in?_.span({},f("Like")):_.span({},f("Login to like comment")),_.div({className:"like-bar"},m({position:r.TooltipPosition.TOP,tooltip_contents:s,tooltip_classname:"like-tooltip"},_.div({},_.a({className:t,onMouseDown:this.onLikeClicked},d({src:n,srcHiRes:o,alt:f("like")})),u>0?_.div({className:"like-text"},u):void 0)))}})})}.call(this),function(){var t=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/clean/react/activity/mentions_controller",["jquery","external/react","external/purify","modules/core/browser","modules/core/exception","modules/core/i18n","modules/clean/activity/activity_user","modules/clean/contacts/types","modules/clean/keycode","modules/clean/validators/validators","modules/clean/react/bubble_dropdown","modules/clean/react/input","modules/clean/react/react_i18n","modules/clean/react/sprite","modules/clean/react/tooltip","modules/clean/react/activity/contacts_selector","modules/clean/react/activity/contacts_selector_popup","modules/clean/react/file_comments/stickers"],function(e,n,o,i,s,r,a,l,c,u,d,p,h,m,f,_,v,y){var g,b,w,T,C,S,A,I,x,P,N,k,E,R,O,D,M,L;return k=r._,P=y.Stickers,R=n.DOM,E=n.addons.classSet,S=h.R_,g=n.createFactory(d),b=n.createFactory(_),w=n.createFactory(v),x=n.createFactory(m),N=n.createFactory(f.Tooltip),O="\ufeff",D=new RegExp(O,"g"),A=" ",I="",T="",M=[c.UP,c.DOWN,c.ESC,c.ENTER,c.TAB],L=u.check(u.create(["EmailValidator"])),C=n.createClass({displayName:"MentionsController",propTypes:{shouldPopupsDropdown:n.PropTypes.bool,enableNoAtMentions:n.PropTypes.bool,showContactsInNullState:n.PropTypes.bool,initialText:n.PropTypes.string,user:n.PropTypes.object,position_contacts_callback:n.PropTypes.func,showMentionsHelper:n.PropTypes.bool,contactSearchLogger:n.PropTypes.object,contactsSelectorPopupShown:n.PropTypes.func,contactsSelectorPopupHidden:n.PropTypes.func,contactPopupSelectedCallback:n.PropTypes.func,contactSelectedCallback:n.PropTypes.func,onKeyDown:n.PropTypes.func,onKeyUp:n.PropTypes.func,onAtSignKeyPress:n.PropTypes.func,onNoAtSignKeyPress:n.PropTypes.func,onBlur:n.PropTypes.func,onFocus:n.PropTypes.func,onPaste:n.PropTypes.func,onCancel:n.PropTypes.func,onMention:n.PropTypes.func,placeholder_text:n.PropTypes.string,resultsLimit:n.PropTypes.number,resizeCallback:n.PropTypes.func,onSkipAddMention:n.PropTypes.func,onAddPeopleMouseUp:n.PropTypes.func,shouldInitiallyFocusInput:n.PropTypes.bool,shouldShowNoNotifyHint:n.PropTypes.bool,shouldAlwaysInEditMode:n.PropTypes.bool,enableImport:n.PropTypes.bool,extraContacts:n.PropTypes.arrayOf(n.PropTypes.object),shouldHidePhotoAvatars:n.PropTypes.bool,shouldEnableStickers:n.PropTypes.bool,onStickerPopupShown:n.PropTypes.func,onAddSticker:n.PropTypes.func,onStickerDropdownShown:n.PropTypes.func,onStickerDropdownHidden:n.PropTypes.func,onContactsSelectorSuggestionsUpdate:n.PropTypes.func,shouldDisableBubbleDropdownHideOnResize:n.PropTypes.bool},getInitialState:function(){var t;return t=this.props.shouldAlwaysInEditMode,this.isInNoAtMentionMode=!1,this.currentCursorWordStartPosition=0,this.currentCursorWordEndPosition=0,this.props.initialText&&this.props.initialText.length>0&&(t=!0),{default_state:!0,x_offset:0,y_offset:0,in_edit_mode:t,mention_triggered:!1,search_end_position:-1,search_start_position:-1,show_contacts:!1,last_keydown:-1}},getDefaultProps:function(){return{shouldPopupsDropdown:!0,initialText:"",user:new a,resultsLimit:5,shouldShowNoNotifyHint:!1,enableNoAtMentions:!1,shouldAlwaysInEditMode:!1,enableImport:!0,extraContacts:[],shouldHidePhotoAvatars:!1,shouldEnableStickers:!1}},componentDidMount:function(){return this._componentSetup(),this.state.default_state&&this.props.initialText.length>0&&(null!=i.mozilla?setTimeout(function(t){return function(){return t._initializeInputWithText(t.props.initialText)}}(this),0):this._initializeInputWithText(this.props.initialText)),this.props.shouldInitiallyFocusInput?setTimeout(function(t){return function(){return t.focusInput()}}(this),0):void 0},componentDidUpdate:function(t,e){var n,o;return this._componentSetup(),o=this._getCaretPosition(),e.show_contacts===this.state.show_contacts||(null!=o?o.left:void 0)===this.state.x_offset&&(null!=o?o.top:void 0)===this.state.y_offset?void 0:(n={x_offset:o.left,y_offset:o.top},this.setState(n))},showNoNotifyHint:function(){var t,e;return this.refreshDropdownDirection(),null!=(t=this.refs.mentionsHintDropdown)&&t.show(),null!=(e=this.refs.mentionsContactSelectorPopup)?e.showNoNotifyHint():void 0},_resetInputToPlaceholderState:function(){return this._dangerouslySetInputHtml(""),this.setState({in_edit_mode:!1,search_end_position:-1,search_start_position:-1})},_initializeInputWithText:function(t){var e,n,i;return t=o.sanitize(t,{FORBID_ATTR:["src","href"]}),this._clearInputWithoutBlurring(),this.$text_input.focus(),n=this.$text_input.get(0),i=document.createRange(),n&&(i.setStart(n,0),e=/@\[(\s*(?:dbid:)?[^:\[\]]+):([^\[]+)\]/g,t=t.replace(e,function(t){return function(e,n,o){return n=n.trim(),o=o.trim(),t._mentionWrapper(n,o)}}(this)),this.unsafeInsertHtmlAtRange(t,i,!0),!this.state.in_edit_mode)?this.setState({in_edit_mode:!0}):void 0},_componentSetup:function(){return this.contacts_selector=this.refs.contactSelector,this.$mentions_input=e(this.refs.input.getDOMNode()),this.$text_input=e(this.refs.textInput.getDOMNode())},_logEmailEntered:function(t){var e;return null!=this.props.contactSearchLogger?(e={sort_variant:null,context:"mentions",contact_type:l.EMAIL,contact_id:t,did_select_suggestion:!1},this.props.contactSearchLogger.add_record(e)):void 0},_parseInputTextAndReplace:function(){var t,e;return t=0,e=new RegExp(/@[a-z0-9!#$%&'*+\/=?^_`{|}~-]+(?:\.[a-z0-9!#$%&'*+\/=?^_`{|}~-]+)*@(?:[a-z0-9](?:[a-z0-9-]*[a-z0-9])?\.)+[a-z0-9](?:[a-z0-9-]*[a-z0-9])?/gi),this._parseInputTextWithRegex(e,function(e){return function(n,o){var s,r,a,l,c;return r=n[0],s=n.index,l=r.substring(1),L(l)&&null==i.msie?(c=document.createRange(),c.setStart(o,s),c.setEnd(o,s+r.length),a=e._createMentionObject(l,l),e._addMentionIntoInput(a,c),t++,e._logEmailEntered(l)):void 0}}(this)),t>0?this.setCursorToEndOfInput():void 0},_parseInputTextWithRegex:function(t,n){var o,s,r,a,l,c,u,d;if(s=this.$text_input.html().replace(D,""),
null!=s&&""!==s){for(l=this.$text_input[0].childNodes,u=[],r=0,a=l.length;a>r;r++)o=l[r],null!=i.msie&&e(o).is("p")||o.nodeType===Node.TEXT_NODE&&""!==o.nodeValue.trim()?(d=null!=i.msie?e(o).text():o.nodeValue,u.push(function(){var e;for(e=[];null!==(c=t.exec(d));)e.push(n(c,o));return e}())):u.push(void 0);return u}},refreshDropdownDirection:function(){var t;return"function"==typeof(t=this.props).position_contacts_callback?t.position_contacts_callback():void 0},_getEndRangeUnicodeIndex:function(){return this.$text_input.html().indexOf(T)},_getStartRangeUnicodeIndex:function(){return this.$text_input.html().indexOf(I)},_endRangeUnicodeExists:function(){return this._getEndRangeUnicodeIndex()>=0},_startRangeUnicodeExists:function(){return this._getStartRangeUnicodeIndex()>=0},_startAndEndRangeUnicodeExistsAndValid:function(){var t,e;return e=this._getStartRangeUnicodeIndex(),t=this._getEndRangeUnicodeIndex(),e>=0&&t>0&&t>e},_clearStartToEndRangeUnicode:function(){return this._dangerouslyReplaceStartToEndRangeUnicode(""),this._clearRangeUnicode()},_dangerouslyInsertValueBeforeStartUnicode:function(t){var e,n,i,s,r;return this._getStartRangeUnicodeIndex()>=0?(r=this._getStartRangeUnicodeIndex(),n=this.$text_input.html(),e=n.substr(0,r),i=n.substr(r),t=o.sanitize(t),s=""+e+t+i,this._dangerouslySetInputHtml(s)):void 0},_dangerouslyReplaceStartToEndRangeUnicode:function(t){var e,n,i,s,r;return this._startAndEndRangeUnicodeExistsAndValid()?(r=this._getStartRangeUnicodeIndex(),n=this._getEndRangeUnicodeIndex(),s=this.$text_input.html(),i=s.substr(0,r),e=s.substr(n),t=o.sanitize(t),this._dangerouslySetInputHtml(""+i+I+t+T+e)):void 0},_clearRangeUnicode:function(){var t;return t=this.$text_input.html(),t=t.replace(/\u0091/g,""),t=t.replace(/\u0092/g,""),this.$text_input.html(t)},_dangerouslyInsertLiveTextWithRangeUnicode:function(t){var e;return null==i.msie&&this._cleanUpDelimiters(),(this._getStartRangeUnicodeIndex()<0||this._getEndRangeUnicodeIndex()<0)&&(this._clearRangeUnicode(),this._dangerouslySetInputHtml(""+this.$text_input.html()+I+T)),e=this._isSpaceBeforeStartUnicode()?"":" ",t=o.sanitize(t),this._dangerouslyReplaceStartToEndRangeUnicode(""+e+t)},_getRangeBetweenStartEndRangeUnicode:function(){var t,n,o,s,r,a,l,c,u;if(n=this.$text_input.html().replace(D,""),null!=n&&""!==n)for(l=this.$text_input[0].childNodes,s=0,r=l.length;r>s;s++)if(t=l[s],u=null!=i.msie?e(t).text():t.nodeValue,null!=u&&u.length>0&&(c=u.indexOf(I),o=u.indexOf(T),c>=0&&o>0&&o>c))return a=document.createRange(),a.setStart(t,c),a.setEnd(t,o),a},_isSpaceBeforeStartUnicode:function(){var t;return t=this._getStartRangeUnicodeIndex(),t>=0?this._isSpaceBeforeIndex(t):!1},_isSpaceBeforeIndex:function(t){var e;return e=this.$text_input.html(),t>0&&" "===e.substr(t-1,1)||t>=6&&"&nbsp;"===e.substr(t-6,6)},_dangerouslySetInputHtml:function(t){return this.$text_input.html(t)},_onAddPeopleMouseUp:function(t){var e;return"function"==typeof(e=this.props).onAddPeopleMouseUp?e.onAddPeopleMouseUp(t):void 0},_onSkipAddMention:function(t){var e,n;return null!=(n=this.refs.mentionsHintDropdown)&&n.hide(),"function"==typeof(e=this.props).onSkipAddMention?e.onSkipAddMention(t):void 0},_contactsSelectorPopupHidden:function(){var t;return this.props.showMentionsHelper&&(this._clearStartToEndRangeUnicode(),0===this.$text_input.html().trim().length&&this.state.in_edit_mode&&this._getCaretPosition().top<=0&&this._resetInputToPlaceholderState()),null!=(null!=(t=this.refs.textInput)?t.getDOMNode():void 0)?this.setCursorToEndOfInput():void 0},_contactsSelectorPopupShown:function(){var t,e,n,o;return this.isMounted()&&this.props.showMentionsHelper?(this.state.in_edit_mode||this._clearDefaultState(),null!=(e=this.refs.mentionsContactSelectorPopup)&&null!=(n=e.refs)&&null!=(o=n.contactSelectorPopupInput)&&o.getDOMNode().focus(),"function"==typeof(t=this.props).contactsSelectorPopupShown?t.contactsSelectorPopupShown():void 0):void 0},_emailEnteredCallback:function(t){return this._addMentionIntoRangeUnicode(this._createMentionObject(t)),this.setCursorToEndOfInput(),this.refs.mentionsHintDropdown.hide()},_clearContactHighlightedCallback:function(){return this._clearStartToEndRangeUnicode()},_contactHighlightedCallback:function(t){var e,n,o;return o=(null!=t?t.data("name"):void 0)||"",n=(null!=t?t.data("identifier"):void 0)||"",this._dangerouslyInsertLiveTextWithRangeUnicode("@"+o),"function"==typeof(e=this.props).onContactsSelectorSuggestionsUpdate?e.onContactsSelectorSuggestionsUpdate():void 0},_contactPopupSelectedCallback:function(t){var e;return this._addMentionIntoRangeUnicode(this._createMentionObjectFromSuggestion(t)),this.setCursorToEndOfInput(),this.refs.mentionsHintDropdown.hide(),"function"==typeof(e=this.props).contactPopupSelectedCallback?e.contactPopupSelectedCallback(t):void 0},_contactSelectedCallback:function(t){var e;return this._addMentionIntoInput(this._createMentionObjectFromSuggestion(t)),"function"==typeof(e=this.props).contactSelectedCallback?e.contactSelectedCallback(this.isInNoAtMentionMode):void 0},_addMentionIntoRangeUnicode:function(t){var e;return this._isSpaceBeforeStartUnicode()||this._dangerouslyInsertValueBeforeStartUnicode(" "),e=this._getRangeBetweenStartEndRangeUnicode(),e?(this._addMentionIntoInput(t,e),this._clearRangeUnicode()):void 0},_noAtMentionTriggerCallback:function(t){var e;if(this.props.enableNoAtMentions){if(!this.state.show_contacts&&t>0)return this.refreshDropdownDirection(),this.setState({show_contacts:!0}),this.isInNoAtMentionMode=!0,"function"==typeof(e=this.props).onNoAtSignKeyPress?e.onNoAtSignKeyPress():void 0;if(this.isInNoAtMentionMode&&0===t)return this.setState({show_contacts:!1}),this.isInNoAtMentionMode=!1}},setCursorToEndOfInput:function(){return setTimeout(function(t){return function(){var e,n;return t.focusInput(),e=t.$text_input[0].lastChild,null!=e?(n=document.createRange(),n.selectNode(e),n=n.cloneRange(),n.setStartAfter(e),n.collapse(!1),t._selection().removeAllRanges(),t._selection().addRange(n)):void 0}}(this),10)},_getCaretPosition:function(){var t,e,n,o;return e=null!=(o=this.refs.container)?o.getDOMNode().getClientRects()[0]:void 0,t={left:this.state.x_offset,top:this.state.y_offset},this._selection().rangeCount>0&&(n=this._selection().getRangeAt(0).getClientRects()[0],null!=n&&null!=e&&(t.left=n.left-e.left,t.top=this.props.shouldPopupsDropdown?n.bottom-e.top:n.top-e.top)),t},unsafeInsertHtmlAtRange:function(t,n,o){var i,s,r,a;for(n.deleteContents(),a=e("<span />").html(t)[0],i=document.createDocumentFragment();r=a.firstChild;)s=i.appendChild(r);return n.insertNode(i),s&&o&&(n=n.cloneRange(),n.setStartAfter(s),n.collapse(!0),this._selection().removeAllRanges(),this._selection().addRange(n)),s},_checkEndOfLine:function(){var t,n,o,r,a;return s.assert(null!=i.mozilla,"_checkEndOfLine called from non mozilla browser"),r=this._extractCursorInfo(),n=r[0],o=r[1],a=r[2],e(n).hasClass("text-input")&&e(this.$text_input.contents()[o]).is("br")&&o>0&&(t=this.$text_input.contents()[o-1],t.nodeType===Node.TEXT_NODE&&t.nodeValue===O)?this._setCursorLocation(t,0):void 0},_selection:function(){return window.getSelection()},_setCursorLocation:function(t,n){var o;if(null!=t){if(o=document.createRange(),t.nodeType===Node.TEXT_NODE)o.setStart(t,n);else{if(!e(t).hasClass("new-mention"))return;0===n?o.setStartBefore(t):o.setStartAfter(t)}return o.collapse(!0),this._selection().removeAllRanges(),this._selection().addRange(o)}},_updateCurrentWordBoundary:function(){var t,e,n,o,i,s,r;return o=this._extractCursorInfo(),e=o[0],n=o[1],i=o[2],r=i.slice(0,n).lastIndexOf(" ")+1,t=i.slice(0,n).lastIndexOf(A)+1,t>r&&(r=t),s=i.slice(n).indexOf(" "),s=-1===s?i.length:n+s,this.currentCursorWordStartPosition=r,this.currentCursorWordEndPosition=s},_cleanMentionHighlighting:function(t){var n,o,i,s,r;for(null==t&&(t=null),o=this.$text_input.children(),null!=t&&(o=[t]),r=[],i=0,s=o.length;s>i;i++)n=o[i],r.push(e(n).removeClass("selected"));return r},_cleanUpNbsp:function(){var t;return t=this.$text_input.html(),t=t.replace(/\u00a0/g," "),t=t.replace(/\s{2,}/g," "),this.$text_input.html(t)},_cleanUpDelimiters:function(){var t,n,r,a,l,c,u,d,p,h;for(s.assert(null==i.msie,"_cleanUpDelimiters() called from MSIE"),c=this._extractCursorInfo(),a=c[0],l=c[1],h=c[2],u=this.$text_input.contents(),n=0,r=u.length;r>n;n++)t=u[n],t.nodeType===Node.TEXT_NODE?(t.nodeValue=t.nodeValue.replace(D,""),""===t.nodeValue&&(t!==a?t.parentNode.removeChild(t):l=0)):e(t).hasClass("new-mention")&&(p=document.createTextNode(o.sanitize(O)),t.parentNode.insertBefore(p,t),d=document.createTextNode(o.sanitize(O)),t.parentNode.insertBefore(d,t.nextSibling));return null!=a&&a.nodeType===Node.TEXT_NODE&&a.nodeValue.length<l&&(l=a.nodeValue.length),this._setCursorLocation(a,l),null==i.mozilla&&null!=a&&""===a.nodeValue?a.parentNode.removeChild(a):void 0},_checkAndMergeAdjacentNodes:function(){var t,n,o,r,a,l,u,d,p,h;return s.assert(null!=i.msie,"_checkAndMergeAdjacentNodes called from non IE browser"),d=this._extractCursorInfo(),a=d[0],l=d[1],h=d[2],!e(a).hasClass("text-input")&&!e(a).is("p")||(p=event.keyCode)!==c.BACKSPACE&&p!==c.DELETE||(t=e(a).contents()[l],(null!=t?t.nodeType:void 0)!==Node.TEXT_NODE)?void 0:(o=t.nodeValue,n=0,u=t.previousSibling,r=t.nextSibling,null!=u&&u.nodeType===Node.TEXT_NODE&&(n=u.nodeValue.length,o=u.nodeValue+o,u.parentNode.removeChild(u)),null!=r&&r.nodeType===Node.TEXT_NODE&&(o+=r.nodeValue,r.parentNode.removeChild(r)),t.nodeValue=o,this._setCursorLocation(t,n))},_isCursorAfterSpaceOrBeginningOfLine:function(t,e){var n;if(e-1>=0){if(n=t.slice(e-1,e)," "===n||""===n||" "===n)return!0}else if(0===e)return!0;return!1},_extractCursorInfo:function(){var t,e,n;return t=this._selection().focusNode,e=this._selection().focusOffset,n="",null!=t&&t.nodeType===Node.TEXT_NODE&&(n=t.nodeValue.length?t.nodeValue:""),[t,e,n]},_clearDefaultState:function(){return this.state.default_state&&this._clearInputWithoutBlurring(),this.state.in_edit_mode?void 0:this.setState({in_edit_mode:!0})},_clearInputWithoutBlurring:function(){return null!=i.msie?this.$text_input[0].innerText="":this.$text_input[0].textContent=""},clearTextField:function(){return this._clearInputWithoutBlurring(),this.setState({in_edit_mode:this.props.shouldAlwaysInEditMode}),this.$text_input.blur()},_onInputKeydownMozilla:function(t){var e,n,o,r,a,l,u,d;if(s.assert(null!=i.mozilla,"_onInputKeydownMozilla called from non mozilla browser"),this._cleanUpDelimiters(),this._checkEndOfLine(),a=this._extractCursorInfo(),n=a[0],o=a[1],d=a[2],null!=n&&n.nodeType===Node.TEXT_NODE)if(r=n.previousSibling,e=n.nextSibling,(l=t.keyCode)===c.DELETE||l===c.RIGHT){if(d===O&&null!=e&&this._toggleMentionSelectState(e,t))return this._setCursorLocation(n,1);if(d.length!==o||null==e||e.nodeType!==Node.TEXT_NODE||e.nodeValue!==O)return this._cleanMentionHighlighting();if(null!=e.nextSibling&&this._toggleMentionSelectState(e.nextSibling,t))return this._setCursorLocation(e,1)}else if(((u=t.keyCode)===c.BACKSPACE||u===c.LEFT)&&0===o&&null!=r){if(d===O&&this._toggleMentionSelectState(r,t))return this._setCursorLocation(n,0);if(r.nodeType===Node.TEXT_NODE&&r.nodeValue===O&&null!=r.previousSibling&&this._toggleMentionSelectState(r.previousSibling,t))return this._setCursorLocation(r,0)}},_onInputKeydownMsie:function(t){var n,o,r,a,l,u,d,p,h,m,f;if(s.assert(null!=i.msie,"_onInputKeydownMsie called from non MSIE browser"),u=this._extractCursorInfo(),r=u[0],a=u[1],f=u[2],null!=r){if(e(r).hasClass("text-input")||e(r).is("p"))return n=e(r).contents(),((d=t.keyCode)===c.BACKSPACE||d===c.LEFT)&&a>0&&e(n[a-1]).hasClass("new-mention")?this._toggleMentionSelectState(n[a-1],t):(p=t.keyCode)!==c.DELETE&&p!==c.RIGHT||!e(n[a]).hasClass("new-mention")?this._cleanMentionHighlighting():this._toggleMentionSelectState(n[a],t);if(l=r.previousSibling,o=r.nextSibling,(h=t.keyCode)===c.BACKSPACE||h===c.LEFT){if(0===a&&null!=l&&e(l).hasClass("new-mention"))return this._toggleMentionSelectState(l,t)}else{if((m=t.keyCode)!==c.DELETE&&m!==c.RIGHT)return this._cleanMentionHighlighting();if(a===f.length&&null!=o&&e(o).hasClass("new-mention"))return this._toggleMentionSelectState(o,t)}}},_onInputKeydownWebkit:function(t){var e,n,o,r,a,l,u,d;if(s.assert(null!=i.webkit,"_onInputKeydownWebkit called from non webkit browser"),this._cleanUpDelimiters(),a=this._extractCursorInfo(),n=a[0],o=a[1],d=a[2],null!=n&&n.nodeType===Node.TEXT_NODE)if(r=n.previousSibling,e=n.nextSibling,(l=t.keyCode)===c.BACKSPACE||l===c.LEFT){if(null!=r&&d===O&&this._toggleMentionSelectState(r,t)){if(t.keyCode===c.BACKSPACE)return this._setCursorLocation(n,o-1);if(t.keyCode===c.LEFT)return this._setCursorLocation(r.previousSibling,1)}}else{if((u=t.keyCode)!==c.DELETE&&u!==c.RIGHT)return this._cleanMentionHighlighting();if(o!==d.length||null==e||e.nodeType!==Node.TEXT_NODE||e.nodeValue!==O&&0!==e.nodeValue.length){if(d===O&&0===o&&null!=e&&this._toggleMentionSelectState(e,t)){if(t.keyCode===c.DELETE)return this._setCursorLocation(n,1);if(t.keyCode===c.RIGHT)return this._setCursorLocation(e,1)}}else if(null!=e.nextSibling&&this._toggleMentionSelectState(e.nextSibling,t)){if(t.keyCode===c.DELETE)return this._setCursorLocation(e,1);if(t.keyCode===c.RIGHT)return this._setCursorLocation(e.nextSibling,1)}}},_onInputKeydown:function(e){var n,o,s,r,a,l,u,d;if(r=this._normalizeKeycode(e),this.setState({default_state:!1,last_keydown:r}),r!==c.PROCESSING)if(!(this._selection().rangeCount>0&&this._selection().getRangeAt(0).collapsed||0===this._selection().rangeCount)||r!==c.BACKSPACE&&r!==c.DELETE&&r!==c.LEFT&&r!==c.RIGHT?this._cleanMentionHighlighting():null!=i.webkit?this._onInputKeydownWebkit(e):null!=i.mozilla?this._onInputKeydownMozilla(e):null!=i.msie&&this._onInputKeydownMsie(e),"function"==typeof(n=this.props).onKeyDown&&n.onKeyDown(e),u=this._extractCursorInfo(),a=u[0],l=u[1],d=u[2],this.state.show_contacts){if(t.call(M,r)>=0){if(e.preventDefault(),r===c.ESC||0===this.contacts_selector.get_suggestions_count()&&r===c.ENTER)return this.setState({show_contacts:!1})}else if(r===c.BACKSPACE&&(null!=a?a.nodeType:void 0)===Node.TEXT_NODE&&l>0&&(s=d.substr(l-1,1),"@"===s&&this._isCursorAfterSpaceOrBeginningOfLine(d,l-1)))return this.setState({show_contacts:!1})}else if(r===c.ESC)return"function"==typeof(o=this.props).onCancel?o.onCancel():void 0},_onInputKeypress:function(t){var n,o,s,r,a,l,u,d,p;return d=this._extractCursorInfo(),l=d[0],u=d[1],p=d[2],this._normalizeKeycode(t)===c.AT_SIGN&&!this.state.mention_triggered&&("function"==typeof(n=this.props).position_contacts_callback&&n.position_contacts_callback(),r=!1,l.nodeType===Node.TEXT_NODE?this._isCursorAfterSpaceOrBeginningOfLine(p,u)&&(r=!0,s=u):(e(l).hasClass("text-input")||null!=i.msie&&e(l).is("p"))&&(r=!0,s=0),r)?(a={search_start_position:s,search_end_position:s,mention_triggered:!0},this.setState(a),"function"==typeof(o=this.props).onAtSignKeyPress?o.onAtSignKeyPress():void 0):void 0},_onInputKeyup:function(e){var n,o,r,a,l,u,d,p,h,m,f,_;if(this.state.last_keydown===c.PROCESSING)return void s.assert(null!=i.webkit,"PROCESSING keycode detected in non-webkit browser");if(null!=i.msie&&this._checkAndMergeAdjacentNodes(),p=this._extractCursorInfo(),l=p[0],u=p[1],_=p[2],this.props.enableNoAtMentions&&this._updateCurrentWordBoundary(),a={},this.state.mention_triggered&&(a.mention_triggered=!1,a.show_contacts=!0,u-this.state.search_start_position>1&&(o=_.slice(this.state.search_start_position+1,u).indexOf("@"),a.show_contacts=-1===o?!0:!1)),!this.state.show_contacts&&!a.show_contacts||this.isInNoAtMentionMode)this.props.enableNoAtMentions&&(m=e.keyCode,t.call(M,m)>=0&&this.state.show_contacts&&this.contacts_selector.get_suggestions_count()>0?this.contacts_selector.navigate_suggestions(e):e.keyCode!==c.ESC&&this.contacts_selector.get_suggestions(_.slice(this.currentCursorWordStartPosition,this.currentCursorWordEndPosition).trim(),!1));else if(h=e.keyCode,t.call(M,h)>=0&&this.contacts_selector.get_suggestions_count()>0)this.contacts_selector.navigate_suggestions(e);else if(u<=this.state.search_start_position||l.nodeType!==Node.TEXT_NODE)a.show_contacts=!1;else if(e.keyCode===c.SPACE)if(d=this._parseMentionQuery(_,this.state.search_end_position).trim(),0!==d.length){if(L(d))return r=this._createMentionObject(d),this._addMentionIntoInput(r),void this._logEmailEntered(d);this.contacts_selector.get_suggestions(d,!0)}else this.setState({show_contacts:!1});else this.contacts_selector.get_suggestions(this._parseMentionQuery(_,u).trim(),!0);return(e.keyCode===c.ENTER||e.keyCode===c.TAB||e.keyCode===c.SPACE&&!this.state.show_contacts&&!a.show_contacts)&&this._parseInputTextAndReplace(),null==i.msie&&(this._selection().rangeCount>0&&this._selection().getRangeAt(0).collapsed||0===this._selection().rangeCount)&&this._cleanUpDelimiters(),"function"==typeof(n=this.props).onKeyUp&&n.onKeyUp(e),f=this._normalizeKeycode(e),t.call(M,f)>=0&&this.state.show_contacts?void 0:this.setState(a,function(t){return function(){var e;return"function"==typeof(e=t.props).resizeCallback?e.resizeCallback():void 0}}(this))},_normalizeKeycode:function(t){return t.keyCode||t.which||t.charCode},_onInputBlur:function(){var t,e;return this._parseInputTextAndReplace(),"function"==typeof(t=this.props).onBlur&&t.onBlur(),e={show_contacts:!1,default_state:!1},!this.state.in_edit_mode||this.getEncodedMessage().length||this.props.shouldAlwaysInEditMode||(e.in_edit_mode=!1,e.search_end_position=-1,e.search_start_position=-1),this.setState(e)},_onInputFocus:function(t){var e,n;return t.target===this.$text_input.get(0)?("function"==typeof(e=this.props).onFocus&&e.onFocus(),n={show_contacts:!1},this.state.in_edit_mode||(n.in_edit_mode=!0,n.search_end_position=-1,n.search_start_position=-1),setTimeout(function(t){return function(){return t.isMounted()?t.setState(n):void 0}}(this),0)):void 0},_onInputMouseDown:function(){return this.setState({default_state:!1}),this._cleanMentionHighlighting()},_onInputPaste:function(t){var e;return this.setState({default_state:!1}),"function"==typeof(e=this.props).onPaste?e.onPaste(t):void 0},_createMentionObjectFromSuggestion:function(t){var e,n,o;return o=t.data("name"),n=t.data("identifier"),e=t.data("dbx-account-id"),this._createMentionObject(n,o,e)},_createMentionObject:function(t,e,n){return null==e&&(e=null),null==n&&(n=null),e||(e=t),n&&(t=n),{name:e,identifier:t,dbx_account_id:n}},_toggleMentionSelectState:function(t,n){if(e(t).hasClass("new-mention")){if(e(t).hasClass("selected"))return this._cleanMentionHighlighting(t),!0;n.stopPropagation(),n.preventDefault(),e(t).addClass("selected")}return!1},_onMentionMouseDown:function(t){var e;return t.preventDefault(),t.stopPropagation(),0===t.button?(this._cleanMentionHighlighting(),this._toggleMentionSelectState(t.target,t),e=document.createRange(),e.selectNode(t.target),this._selection().removeAllRanges(),this._selection().addRange(e)):null!=i.mozilla&&2===t.button?this._setCursorLocation(t.target,1):void 0},_mentionWrapper:function(t,e,n){return null!=i.webkit?"<span class='new-mention' data-id=\""+t+'" data-name="'+e+'" data-dbx-account-id="'+n+'">'+e+"</span>":'<input type="button" class=\'new-mention\' data-id="'+t+'" data-name="'+e+'" data-dbx-account-id="'+n+'" value="'+e+'"></input>'},_parseMentionQuery:function(t,e){var n;return e>this.state.search_end_position?this.setState({search_end_position:e}):e=this.state.search_end_position,n="",e<=t.length?n=t.slice(this.state.search_start_position,e):this.state.search_start_position<=t.length&&(this.setState({search_end_position:t.length}),n=t.slice(this.state.search_start_position)),n.replace("@","")},_addMentionIntoInput:function(t,n){var s,r,a,l,c,u,d,p,h,m,f,_;return u=this.refs.textInput.getDOMNode(),_=this._mentionWrapper(t.identifier,t.name,t.dbx_account_id),p=e(o.sanitize(_))[0],null!=i.webkit?p.setAttribute("contenteditable","false"):null!=i.mozilla&&p.setAttribute("style","margin-left:-3px; margin-right:-3px"),e(p).mousedown(function(t){return function(e){return t._onMentionMouseDown(e)}}(this)),null==n&&(d=this._extractCursorInfo(),l=d[0],c=d[1],f=d[2],n=document.createRange(),m=this.state.search_start_position,r=this.state.search_end_position,this.state.show_contacts||(this.setState({search_start_position:l.length}),this.setState({search_end_position:l.length}),m=l.length,r=l.length),this.isInNoAtMentionMode&&(m=this.currentCursorWordStartPosition,r=this.currentCursorWordEndPosition),n.setStart(l,m),n.setEnd(l,r)),p=this.unsafeInsertHtmlAtRange(p,n,!0),a=p.nextSibling,null!=a&&a.nodeType===Node.TEXT_NODE?(a.nodeValue=A+a.nodeValue,this._setCursorLocation(a,1)):(h=document.createTextNode(o.sanitize(A)),e(h).insertAfter(p),this._setCursorLocation(h,1)),"function"==typeof(s=this.props).onMention&&s.onMention(t),this.setState({show_contacts:!1})},focusInput:function(){var t;return this.setState({in_edit_mode:!0}),t=this.refs.textInput.getDOMNode(),t.focus()},disableMentions:function(){return this.state.show_contacts?this.setState({show_contacts:!1}):void 0},mentionsEnabled:function(){return this.state.show_contacts},_encodedMention:function(t){return"@[%(identifier)s:%(name)s]".format({identifier:t.identifier,name:t.name})},extractMentions:function(){var t,n,o,i,s,r,a,l;for(r=this.$text_input.find(".new-mention"),a=[],n=0,i=r.length;i>n;n++)s=r[n],o=e(s).data("id"),l=e(s).data("name"),t=e(s).data("dbx-account-id"),a.push(this._createMentionObject(o,l,t));return a},_encodeHtml:function(t){var n,o,i,s,r,a,l,c,u;if(i="",s=!1,t=t.replace(D,""),null!=t&&""!==t)for(c=e.parseHTML(t),r=0,a=c.length;a>r;r++)n=c[r],n.nodeType===Node.TEXT_NODE&&""!==n.nodeValue?(s=!0,i+=n.nodeValue):n instanceof HTMLParagraphElement?(s=!0,i=i+this._encodeHtml(e(n).html())+"\n"):e(n).hasClass("new-mention")?(s=!0,o=e(n).data(),l=this._createMentionObject(o.id,o.name),i+=this._encodedMention(l)):e(n).is("br")?i+="\n":e(n).is("div")?(u=e(n).text(),s=s||u.length>0,i=i+"\n"+u):(u=e(n).text(),s=s||u.length>0,i+=u);return i!==this.props.placeholder_text&&s?i:""},getRawMessage:function(){return this.$text_input.html()},getEncodedMessage:function(){var t;return t=this.$text_input.html(),this._encodeHtml(t)},_postSticker:function(t){var e,n;return"function"==typeof(e=this.props).onAddSticker&&e.onAddSticker(t),null!=(n=this.refs.stickerDropdown)?n.hide():void 0},_renderStickerButton:function(){var t,e,n;return n=R.button({className:"stickers-bubble-target comment-sticker-add sprite-button"},R.div({className:"comment-sticker-icon"}),R.span({className:"ax-visually-hidden"},k("Add sticker"))),t=this.props.shouldPopupsDropdown?"top":"bottom",e=this.props.shouldPopupsDropdown?4:-11,R.div({className:"comment-sticker-button",onMouseDown:this.refreshDropdownDirection},g({targetButton:n,ref:"stickerDropdown",arrow_position:t+"-right",vertical_displacement:e,extra_css_class:"stickers-bubble-dropdown",horizontal_displacement:1,anchor_bottom:!this.props.shouldPopupsDropdown,bubbleDropdownShown:this.props.onStickerDropdownShown,bubbleDropdownHidden:this.props.onStickerDropdownHidden,shouldDisableBubbleDropdownHideOnResize:this.props.shouldDisableBubbleDropdownHideOnResize},P({isPopupAbove:this.props.shouldPopupsDropdown,onStickerSelected:this._postSticker})))},render:function(){var t,e,o,s,r,a,l,c,u,d;return r={"text-input":!0,"edit-mode":this.state.in_edit_mode},l=E(r),a=!0,null!=i.webkit&&(a="plaintext-only"),t={ref:"textInput",className:l,contentEditable:a,defaultValue:this.props.initialText,onKeyPress:this._onInputKeypress,onKeyDown:this._onInputKeydown,onKeyUp:this._onInputKeyup,onFocus:this._onInputFocus,onBlur:this._onInputBlur,onPaste:this._onInputPaste,onMouseDown:this._onInputMouseDown},p=R.div({className:"mention-text-input-wrapper"},R.div(t,this.state.in_edit_mode?void 0:this.props.placeholder_text)),d=b({ref:"contactSelector",contactSelectedCallback:this._contactSelectedCallback,noAtMentionTriggerCallback:this._noAtMentionTriggerCallback,contactSearchLogger:this.props.contactSearchLogger,show_contacts:this.state.show_contacts,should_dropdown:this.props.shouldPopupsDropdown,y_offset:this.state.y_offset,x_offset:this.state.x_offset,user:this.props.user,last_keydown:this.state.last_keydown,resultsLimit:this.props.resultsLimit,enableImport:this.props.enableImport,extraContacts:this.props.extraContacts,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars}),c=n.addons.classSet({"mentions-container":!0,"mentions-container-w-hint":this.props.showMentionsHelper}),u=n.addons.classSet({"mentions-input":!0,"animating-highlight":this.props.shouldInitiallyFocusInput&&!this.props.shouldAlwaysInEditMode}),R.div({className:c,ref:"container"},R.div({className:u,ref:"input"},p,this.props.showMentionsHelper?(o=R.button({className:"comment-mention-hint-add sprite-button"},x({group:"web",name:"s_mention_add",alt:k("@mention someone")})),e=this.props.shouldPopupsDropdown?"top":"bottom",s=this.props.shouldPopupsDropdown?0:-16,R.div({className:"comment-mention-hint"},N({position:f.TooltipPosition.LEFT,tooltip_contents:S({},"@mention someone"),tooltip_classname:"notification-names-tooltip"},R.div({className:"comment-mention-hint-button",onMouseDown:this.refreshDropdownDirection},g({targetButton:o,autofocus:!0,ref:"mentionsHintDropdown",arrow_position:e+"-right",vertical_displacement:s,horizontal_displacement:3,anchor_bottom:!this.props.shouldPopupsDropdown,extra_css_class:"mentions-helper-bubble-dropdown",bubbleDropdownHidden:this._contactsSelectorPopupHidden,bubbleDropdownShown:this._contactsSelectorPopupShown,shouldDisableBubbleDropdownHideOnResize:this.props.shouldDisableBubbleDropdownHideOnResize},w({key:"mentionsContactSelectorPopup",ref:"mentionsContactSelectorPopup",shouldShowNoNotifyHint:this.props.shouldShowNoNotifyHint,user:this.props.user,contactSearchLogger:this.props.contactSearchLogger,emailEnteredCallback:this._emailEnteredCallback,contactSelectedCallback:this._contactPopupSelectedCallback,contactHighlightedCallback:this._contactHighlightedCallback,clearContactHighlightedCallback:this._clearContactHighlightedCallback,should_dropdown:this.props.shouldPopupsDropdown,onAddPeopleMouseUp:this._onAddPeopleMouseUp,onSkipAddMention:this._onSkipAddMention,enableImport:this.props.enableImport,extraContacts:this.props.extraContacts,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars})))))):void 0,this.props.shouldEnableStickers?this._renderStickerButton():void 0),d)}})})}.call(this),function(){define("modules/clean/react/activity/resolve_button",["external/react","modules/core/i18n","modules/core/notify","modules/clean/react/sprite"],function(t,e,n,o){var i,s,r;return r=t.DOM,s=t.createFactory(o),i=t.createClass({displayName:"ResolveButton",propTypes:{resolved:t.PropTypes.bool.isRequired,onUpdateResolve:t.PropTypes.func.isRequired,isOffline:t.PropTypes.bool},getDefaultProps:function(){return{isOffline:!1}},_updateResolved:function(){var t;return this.props.isOffline?(t=e._(this.props.resolved?"Cannot unresolve comments while offline":"Cannot resolve comments while offline"),n.error(t)):this.props.onUpdateResolve(!this.props.resolved)},render:function(){var t;return t={className:"resolved-icon",onClick:this._updateResolved,onMouseEnter:function(t){return function(){return t.setState({hover:!0})}}(this),onMouseLeave:function(t){return function(){return t.setState({hover:!1})}}(this)},this.props.resolved?r.div({className:"resolve-wrapper"},r.div(t,s({group:"web",name:"s_greencheck",alt:e._("resolve button (resolved)")})),this.state.hover?r.div({className:"unresolve-text"},e._("Unresolve")):void 0):this.props.resolved?void 0:r.div({className:"resolve-wrapper"},r.div(t,s({group:"web",name:"s_greycheck",alt:e._("resolve button (unresolved)")})),this.state.hover?r.div({className:"resolve-text"},e._("Resolve")):void 0)},getInitialState:function(){return{hover:!1}}})})}.call(this),function(){define("modules/clean/react/activity/time_counter",["external/react","modules/clean/datetime"],function(t,e){var n,o;return o=t.DOM,n=t.createClass({displayName:"TimeCounter",render:function(){var t;return t=e.ago(new Date(this.props.when_mses)),o.div({className:"activity-time-ago"},t)},updateLoop:function(){},componentDidMount:function(){return this.updateLoop()},getUpdateInterval:function(){return 5e3}})})}.call(this),function(){define("modules/clean/react/activity/users_to_notify",["external/react","modules/core/i18n","modules/clean/react/tooltip"],function(t,e,n){var o,i,s,r,a;return s=e._,a=e.ungettext,r=t.DOM,o=t.createFactory(n.Tooltip),i=t.createClass({displayName:"UsersToNotify",propTypes:{usersToNotify:t.PropTypes.array.isRequired,user:t.PropTypes.object.isRequired,shouldShowExtraText:t.PropTypes.bool.isRequired},render:function(){var t,e,i,l,c,u,d;return t=null==this.props.usersToNotify?[]:function(){var t,e,n,o;for(n=this.props.usersToNotify,o=[],t=0,e=n.length;e>t;t++)d=n[t],d.id!==this.props.user.id&&o.push(d);return o}.call(this.props.user.is_signed_in?this:this),e=t.length,e>0?(u=r.div({className:"notification-names-container"},function(){var e,n,o;for(o=[],e=0,n=t.length;n>e;e++)d=t[e],o.push(function(){return function(t){return r.div({key:t.id},t.getDisplayIdentity())}}(this)(d));return o}.call(this)),l=1===e?this.props.shouldShowExtraText?s('<span class="blue">%(name)s</span> will be notified. Anyone who can view this file can comment.').format({name:t[0].getDisplayIdentity()}):s('<span class="blue">%(name)s</span> will be notified.').format({name:t[0].getDisplayIdentity()}):2===e?this.props.shouldShowExtraText?s('<span class="blue">%(name)s and %(name2)s</span> will be notified. Anyone who can view this file can comment.').format({name:t[0].getDisplayIdentity(),name2:t[1].getDisplayIdentity()}):s('<span class="blue">%(name)s and %(name2)s</span> will be notified.').format({name:t[0].getDisplayIdentity(),name2:t[1].getDisplayIdentity()}):this.props.shouldShowExtraText?a('<span class="blue">%(name)s and %(num)s other person</span> will be notified. Anyone who can view this file can comment.','<span class="blue">%(name)s and %(num)s others</span> will be notified. Anyone who can view this file can comment.',e-1).format({name:t[0].getDisplayIdentity(),num:e-1}):a('<span class="blue">%(name)s and %(num)s other person</span> will be notified.','<span class="blue">%(name)s and %(num)s others</span> will be notified.',e-1).format({name:t[0].getDisplayIdentity(),num:e-1}),i=r.div({dangerouslySetInnerHTML:{__html:l},className:"comment-box-text"}),o({position:n.TooltipPosition.TOP,tooltip_contents:u,tooltip_classname:"notification-names-tooltip"},i)):(c=s(this.props.shouldShowExtraText?"Comments won't notify anyone yet. Anyone who can view this file can comment.":"Comments won't notify anyone yet"),r.div({className:"comment-box-text"},c))}})})}.call(this),function(){define("modules/clean/react/activity/users_to_notify_facepile",["external/react","modules/core/i18n","modules/clean/react/tooltip","modules/clean/avatar/avatar_with_default","modules/clean/avatar/initials_avatar","modules/clean/avatar/viewer_avatar"],function(t,e,n,o,i,s){var r,a,l,c,u;return l=e._,u=e.ungettext,c=t.DOM,r=6,a=t.createClass({propTypes:{usersToNotify:t.PropTypes.array.isRequired,user:t.PropTypes.object.isRequired},render:function(){var t,e,o,a,l,u,d,p,h,m,f;for(o=function(){var t,e,n,o;for(n=this.props.usersToNotify,o=[],t=0,e=n.length;e>t;t++)f=n[t],o.push(f);return o}.call(this),t=[],h=[],a=function(){return function(e){return r>l?t.push(e):h.push(e)}}(this),l=u=0,d=o.length;d>u;l=++u)f=o[l],a(f);return c.div({className:"notify-facepile-container"},function(){var o,r,a;for(a=[],o=0,r=t.length;r>o;o++)f=t[o],e=c.div({},f.display_name),a.push(c.div({className:"notify-facepile-photo",key:f.id},n.Tooltip({position:n.TooltipPosition.BOTTOM,tooltip_contents:e,tooltip_classname:"notification-names-tooltip"},s({alt:f.display_name,dimension:32,photoUrl:f.photo_circle_url,defaultAvatar:new i({alt:f.display_name,dimension:32,shape:"CIRCLE",initials:f.initials}),key:f.id}))));return a}(),o.length>r?(m=c.div({},function(){var t,e,n;

for(n=[],t=0,e=h.length;e>t;t++)p=h[t],n.push(c.div({},p.get_display_identity()));return n}()),n.Tooltip({position:n.TooltipPosition.BOTTOM,tooltip_contents:m,tooltip_classname:"notification-names-tooltip"},c.div({className:"notify-facepile-more"},"+"+(o.length-r)))):void 0)}})})}.call(this),function(){define("modules/clean/react/file_comments/annotation_bubble",["external/react","modules/clean/react/activity/comment_input","modules/clean/comments/action_creators","modules/clean/comments/annotation_utils"],function(t,e,n,o){var i,s,r,a;return a=t.DOM,r=t.addons.classSet,s=t.createFactory(e),i=t.createClass({displayName:"AnnotationBubble",mixins:[t.addons.PureRenderMixin],propTypes:{user:t.PropTypes.object,activity:t.PropTypes.object,x:t.PropTypes.number,y:t.PropTypes.number,showBubble:t.PropTypes.bool,in_blank_state:t.PropTypes.bool,annotation:t.PropTypes.object,position:t.PropTypes.string,maxHeight:t.PropTypes.number,shouldShowExpandBubble:t.PropTypes.bool,isMouseOnAnnotation:t.PropTypes.bool,commentText:t.PropTypes.string},getInitialState:function(){return{showExpandBubble:this.props.shouldShowExpandBubble}},getDefaultProps:function(){return{position:"top"}},componentWillReceiveProps:function(t){if(this.props.shouldShowExpandBubble)if(t.commentText||this.props.showBubble!==!1||t.showBubble!==!0||this.setState({showExpandBubble:!0}),this.props.isMouseOnAnnotation){if(!t.isMouseOnAnnotation)return this._onAnnotationExpandBubbleMouseLeave()}else if(t.isMouseOnAnnotation)return this._onAnnotationExpandBubbleMouseEnter()},componentWillUpdate:function(t){return this.props.showBubble===!0&&t.showBubble===!1?this._saveDraft():void 0},componentWillUnmount:function(){return this._saveDraft(),clearTimeout(this.hideBubbleTimeout)},onInputFocus:function(){return{}},onInputBlur:function(){return{}},onAddComment:function(t){return n.addAnnotationComment({text:t}),n.stopAnnotationCreation(),n.updateAnnotationText(null)},onCancelComment:function(){return n.stopAnnotationCreation(),n.updateAnnotationText(null)},_focusOnCommentInput:function(){var t;return null!=(t=this.refs.commentInput)?t.focusInput():void 0},_getRawCommentInput:function(){var t;return(null!=(t=this.refs.commentInput)?t.getRawCommentInput():void 0)||""},_saveDraft:function(){var t,e;return t=this._getRawCommentInput(),n.updateAnnotationText(t.length>0&&t!==(null!=(e=this.refs.commentInput)?e.getPlaceholderText():void 0)?t:null)},_onAnnotationExpandBubbleClick:function(){return this.setState({showExpandBubble:!1})},_onAnnotationExpandBubbleMouseEnter:function(){return clearTimeout(this.hideBubbleTimeout)},_onAnnotationExpandBubbleMouseLeave:function(){return this._setHideCommentTimeOut()},_setHideCommentTimeOut:function(){return clearTimeout(this.hideBubbleTimeout),this.hideBubbleTimeout=setTimeout(this._maybeHideComment,3e3)},_maybeHideComment:function(){return this.state.showExpandBubble&&!this.props.isMouseOnAnnotation?this.onCancelComment():void 0},_renderCommentBox:function(){var t;return t={"max-height":this.props.maxHeight||220},a.div({className:"annotation-bubble__field",style:t},s({ref:"commentInput",activity:this.props.activity,metadata:this.props.annotation,targetActivity:this.props.activity,user:this.props.user,initialText:this.props.commentText,inBlankState:!1,enableNotifyText:!1,enableNoNotifyHint:!1,commentMetadataAllowed:!0,shouldPopupsDropdown:!1,shouldAlwaysInEditMode:this.props.shouldShowExpandBubble,shouldEnableCancelButton:!0,shouldInitiallyFocusInput:this.props.shouldShowExpandBubble,onAddComment:this.onAddComment,onCancelComment:this.onCancelComment,onFocus:this.onInputFocus,onBlur:this.onInputBlur}))},_renderExpandBubble:function(){return a.div({className:"plus",onClick:this._onAnnotationExpandBubbleClick,onMouseEnter:this._onAnnotationExpandBubbleMouseEnter,onMouseLeave:this._onAnnotationExpandBubbleMouseLeave},"+")},render:function(){var t,e,n,i,s,l,c,u,d,p;return d=this.props.x||0,p=this.props.y||0,n=this.props.position,e=this.props.position.indexOf("bottom")>=0?"bottom":"top",this.state.showExpandBubble&&(u=o.getExpandBubblePosition(this.props.position,this.props.x,this.props.y),i=u[0],s=u[1],d=s.x,p=s.y,n=i),l={left:d},l[""+e]=p,t=l,a.div({className:"annotation-bubble-container"},a.div({className:r((c={"annotation-bubble":!0,"annotation-bubble--hidden":!this.props.showBubble,"bubble-dropdown":!0,"expand-bubble":this.state.showExpandBubble},c[""+n]=!0,c)),style:t},this.state.showExpandBubble?this._renderExpandBubble():this._renderCommentBox(),a.div({className:"bubble-arrow-border"}),a.div({className:"bubble-arrow"})))}})})}.call(this),function(){define("modules/clean/react/file_comments/annotation_comments_list_ui_bubble",["jquery","external/react","modules/clean/activity/activity_user","modules/clean/activity/file_viewer_state","modules/clean/datetime","modules/clean/keycode","modules/clean/react/file_comments/threaded_comment_activity_ui","modules/clean/react/activity/comment_activity_ui","modules/clean/comments/action_creators","modules/clean/comments/annotation_utils","modules/clean/comments/utils"],function(t,e,n,o,i,s,r,a,l){var c,u,d,p,h;return h=e.DOM,p=e.addons.classSet,u=e.createFactory(a),d=e.createFactory(r),c=e.createClass({displayName:"AnnotationCommentsListUIBubble",mixins:[e.addons.PureRenderMixin],propTypes:{user:e.PropTypes.object,activity:e.PropTypes.object,x:e.PropTypes.number,y:e.PropTypes.number,showBubble:e.PropTypes.bool,annotation:e.PropTypes.object,commentActivity:e.PropTypes.object,position:e.PropTypes.string,maxHeight:e.PropTypes.number,isThreadingEnabled:e.PropTypes.bool,replyText:e.PropTypes.string},componentWillReceiveProps:function(t){var e,n,o,i;return n=null!=(o=this.props.commentActivity)?o.activity_key:void 0,e=null!=(i=t.commentActivity)?i.activity_key:void 0,n!==e||this.props.showBubble!==t.showBubble?this._saveReplyDraft():void 0},componentWillUnmount:function(){return this._saveReplyDraft()},getInitialState:function(){return{button_disabled:!0,show_post_button:!1,initial_text:"",replyFocused:!1}},getDefaultProps:function(){return{isThreadingEnabled:!1}},onMouseEnter:function(){return l.cancelHideAnnotationConversationDelayed()},onMouseLeave:function(){return this.state.replyFocused?void 0:l.hideAnnotationConversation()},onReplyInputBlur:function(){return this._saveReplyDraft(),this.setState({replyFocused:!1})},onReplyInputFocus:function(){return this.setState({replyFocused:!0})},_getReplyCommentInput:function(){var t;return null!=(t=this.refs.threadedCommentActivityUI)?t.refs.commentInput:void 0},_getRawReplyInput:function(){var t;return(null!=(t=this._getReplyCommentInput())?t.getRawCommentInput():void 0)||""},_saveReplyDraft:function(){var t,e,n;return t=this._getRawReplyInput(),n=t.length>0&&t!==(null!=(e=this._getReplyCommentInput())?e.getPlaceholderText():void 0)?t:null,l.updateAnnotationReplyText({activityKey:this.props.commentActivity.activity_key,text:n})},_getRevisionDateTime:function(){var t;return t=this._getRevision(),null==t.when||isNaN(new Date(null!=t.when))?void 0:""+i.ago(new Date(1e3*t.when))},_getRevision:function(){return this.props.commentActivity.comment.comment_metadata.revision},_isOnOldRevision:function(){return!1},_scrollToBottom:function(){var e;return e=this.refs.annotationBubbleField.getDOMNode(),t(e).animate({scrollTop:e.scrollHeight},{duration:300})},_renderThreadedListUI:function(){return d({ref:"threadedCommentActivityUI",key:"annotation_bubble_threaded_"+this.props.commentActivity.activity_key,activity:this.props.activity,commentActivity:this.props.commentActivity,user:this.props.user,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,shouldAutoLinkify:!0,onReplyInputFocus:this.onReplyInputFocus,onReplyInputBlur:this.onReplyInputBlur,replyText:this.props.replyText,onCommentExpanded:this._scrollToBottom})},_renderSingleCommentUI:function(){return u({key:"annotation_bubble_list_"+this.props.commentActivity.activity_key,comment_activity:this.props.commentActivity,parentActivity:this.props.activity,fileActivity:this.props.activity,user:this.props.user})},_renderComments:function(){var t,e;return e={"comments-holder":!0,"threading-enabled":this.props.isThreadingEnabled},t={"max-height":this.props.maxHeight||220},h.div({className:"annotation-bubble__field",ref:"annotationBubbleField",style:t,onMouseOver:this.onMouseOver,onMouseLeave:this.onMouseLeave,onMouseEnter:this.onMouseEnter},this._isOnOldRevision()?h.div({className:"annotation-bubble__field__old-revision"},"On older revision, updated "+this._getRevisionDateTime()):void 0,h.div({className:p(e)},h.div({className:"comment-list"},this.props.isThreadingEnabled?this._renderThreadedListUI():this._renderSingleCommentUI())))},render:function(){var t,e,n;return n={"annotation-bubble-container":!0},t={left:this.props.x||0},this.props.position.indexOf("bottom")>=0?t.bottom=this.props.y||0:t.top=this.props.y||0,e=[],this.props.showBubble&&(e=[h.div({className:"annotation-bubble bubble-dropdown "+this.props.position,style:t},this._renderComments(),h.div({className:"bubble-arrow-border"}),h.div({className:"bubble-arrow"}))]),h.div({className:p(n)},this.props.showBubble?e:void 0)}})})}.call(this),function(){define("modules/clean/react/file_comments/comment_list_header",["jquery","external/react","modules/core/i18n","modules/clean/activity/activity","modules/clean/react/activity/contacts_selector_popup","modules/clean/react/activity/users_to_notify_facepile","modules/clean/react/bubble_dropdown","modules/clean/react/file_comments/logger","modules/clean/react/react_i18n","modules/clean/react/sprite_div","modules/clean/react/tooltip","modules/clean/comments/action_creators","modules/clean/comments/events","modules/clean/comments/utils","modules/constants/legacy"],function(t,e,n,o,i,s,r,a,l,c,u,d,p,h,m){var f,_,v,y,g,b,w,T,C;return T=n._,y=l.R_,C=e.DOM,v=e.createFactory(i),w=e.createFactory(s),f=e.createFactory(r),g=e.createFactory(c),b=e.createFactory(u.Tooltip),_=e.createClass({displayName:"CommentListHeader",mixins:[e.addons.PureRenderMixin],propTypes:{activity:e.PropTypes.object,user:e.PropTypes.object,commentListOptions:e.PropTypes.node},contactSelectedCallback:function(){return this.refs.facepileContactSelectorDropdown.hide(),a.log_event(m.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SELECTED,this.props.activity.activity_key,null,m.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.FACEPILE_ADD_BUTTON,this.props.user.id)},_contactsSelectorPopupShown:function(){return setTimeout(function(){return function(){return t(".contacts-selector-popup input").trigger("focus")}}(this),300)},_facepileContactsSelectorPopupShown:function(){return null!=this.props.activity&&this.props.enableFacepile?a.log_event(m.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_CONTACT_LIST_SHOWN,this.props.activity.activity_key,null,m.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.FACEPILE_ADD_BUTTON,this.props.user.id):void 0},render:function(){var t;return C.div({className:"comment-list-header-container"},null!=this.props.activity&&this.props.enableFacepile?(this.props.user.is_signed_in?t=C.button({className:"comment-list-facepile-add-button",onMouseUp:this._contactsSelectorPopupShown},C.span({"aria-hidden":!0},"+"),C.span({className:"ax-visually-hidden"},y({},"Add subscribers"))):void 0,C.div({className:"comment-list-facepile"},b({position:u.TooltipPosition.BOTTOM,tooltip_contents:y({},"Subscribers will be notified of new comments"),tooltip_classname:"notification-names-tooltip"},C.div({className:"title"},y({},"Subscribers"))),C.div({},w({usersToNotify:this.props.activity.users_to_notify,user:this.props.user}),this.props.user.is_signed_in?C.div({className:"comment-list-facepile-add"},b({position:u.TooltipPosition.BOTTOM,tooltip_contents:y({},"Add subscribers"),tooltip_classname:"notification-names-tooltip"},f({ref:"facepileContactSelectorDropdown",targetButton:t,autofocus:!0,arrow_position:"top-right",vertical_displacement:-24,horizontal_displacement:-14,bubbleDropdownShown:this._facepileContactsSelectorPopupShown,extra_css_class:"notify-facepile-bubble-dropdown"},C.div({},v({ref:"facepileContactSelectorPopup",contactSelectedCallback:this.contactSelectedCallback,should_dropdown:!0,user:this.props.user,key:"facepileContactsPopup"}))))):void 0))):void 0,C.div({className:"comment-list-header"},C.div({className:"comment-list-header-inner"},C.span({className:"title"},y({},"Comments")),C.span({className:"options"}),this.props.commentListOptions)))}})})}.call(this),function(){define("modules/clean/react/file_comments/comment_list_ui",["jquery","external/react","external/underscore","external/classnames","modules/core/i18n","modules/clean/activity/activity_user","modules/clean/annotations/annotation","modules/clean/components/loading_indicator","modules/clean/gandalf_util","modules/clean/react/button","modules/clean/react/file_comments/comment_list_header","modules/clean/react/file_comments/comment_list_options","modules/clean/react/file_comments/comment_tab_nav","modules/clean/react/file_comments/threaded_comment_activity_ui","modules/clean/react/image","modules/clean/react/react_i18n","modules/clean/react/sprite","modules/clean/react/activity/comment_activity_ui","modules/clean/react/activity/comment_input","modules/clean/static_urls","modules/clean/comments/action_creators","modules/clean/comments/utils","modules/constants/comments_panel"],function(t,e,n,o,i,s,r,a,l,c,u,d,p,h,m,f,_,v,y,g,b,w,T){var C,S,A,I,x,P,N,k,E,R,O,D,M,L,U,F,B,H,K,V,q,G;return G=i.ungettext,C=r.Annotation,R=p.CommentTabNavClass,H=p.TAB_NAV_COMMENTS,B=p.TAB_NAV_ANNOTATIONS,q=g.static_url,V=e.DOM,D=f.R_,M=e.addons.CSSTransitionGroup,S=e.createFactory(c.button),I=e.createFactory(v),K=e.createFactory(h),x=e.createFactory(y),P=e.createFactory(u),E=e.createFactory(R),N=e.createFactory(d),O=e.createFactory(m),M=e.createFactory(M),F=e.createFactory(_),L=300,U=500,A=".comments-holder",k=e.createClass({displayName:"CommentListUI",mixins:[e.addons.PureRenderMixin],propTypes:{context:e.PropTypes.number.isRequired,activity:e.PropTypes.object,showLoadingSpinner:e.PropTypes.bool,contactSearchLogger:e.PropTypes.object,onInputFocus:e.PropTypes.func,onInputBlur:e.PropTypes.func,user:e.PropTypes.object,enableFacepile:e.PropTypes.bool,enableNoNotifyHint:e.PropTypes.bool,shouldInitiallyFocusInput:e.PropTypes.bool,showBottomBar:e.PropTypes.bool,showResolvedComments:e.PropTypes.bool,isUserSubscribed:e.PropTypes.bool,isCommentInputDisabled:e.PropTypes.bool,shouldShowHideButton:e.PropTypes.bool,shouldAutoLinkify:e.PropTypes.bool,enableImport:e.PropTypes.bool,shouldUseSimpleModals:e.PropTypes.bool,shouldHidePhotoAvatars:e.PropTypes.bool,isThreadingEnabled:e.PropTypes.bool,isVisibleAtMentions:e.PropTypes.bool,isOffline:e.PropTypes.bool,shouldAnnotationButtonUseThumbnailUrls:e.PropTypes.bool,shouldShowAnnotationUIOnImages:e.PropTypes.bool,initialCommentsCount:e.PropTypes.number,isTabNavEnabled:e.PropTypes.bool,highlightedActivityKey:e.PropTypes.string,selectedTab:e.PropTypes.oneOf([H,B])},getInitialState:function(){return{shouldPopupsDropdown:!0,showBottomBar:!1,showNewCommentPill:!1,allCommentsCollapsed:!0}},getDefaultProps:function(){return{isCommentInputDisabled:!1,shouldAutoLinkify:!0,enableImport:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,isThreadingEnabled:!1,isVisibleAtMentions:!1,isOffline:!1,shouldAnnotationButtonUseThumbnailUrls:!1,isTabNavEnabled:!1,selectedTab:H}},componentWillUnmount:function(){return t(window).unbind("resize.bottom_bar")},componentDidMount:function(){return t(window).bind("resize.bottom_bar",this.checkScroll),this.markCommentsSeenIfNecessary(),this.checkScroll()},componentWillReceiveProps:function(t){var e,o;return e=this.props.activity,o=t.activity,e!==o&&!this.isScrolledToBottom()&&null!=e&&null!=o&&n.some(o.comment_activities.slice(e.comment_activities.length),function(e){return e.comment.commenter.id!==t.user.id})?this.setState({showNewCommentPill:!0}):void 0},componentWillUpdate:function(){return this.shouldScrollToBottom=this.isScrolledToBottom()},componentDidUpdate:function(e){var n,o,i,s;return this.props.activity!==e.activity&&this.markCommentsSeenIfNecessary(),this._isActivityFetchDone()?(null==e.activity&&(null!=(i=this.props.activity)&&null!=(s=i.comment_activities)?s.length:void 0)>0&&this.animateScrollToBottom(U),this.shouldScrollToBottom&&this.scrollToBottom(),this.props.highlightedActivityKey&&this.props.highlightedActivityKey!==e.highlightedActivityKey&&(this.props.isTabNavEnabled?this.props.selectedTab===H?n=this.refs.tabNav.refs.commentList.getDOMNode():this.props.selectedTab===B&&(n=this.refs.tabNav.refs.annotationList.getDOMNode()):n=this.refs.commentList.getDOMNode(),o=n.querySelector(".threaded-comment-list[data-comment-activity-key='"+this.props.highlightedActivityKey+"']"),null==o&&(o=n.querySelector(".comment-activity[data-comment-activity-key='"+this.props.highlightedActivityKey+"']")),null!=o&&(o.classList.remove("start-highlight-animation"),o.offsetWidth=o.offsetWidth,o.classList.add("start-highlight-animation"),t(n).animate({scrollTop:o.offsetTop-n.offsetTop},{duration:500}))),this.checkScroll()):void 0},onNewCommentPillClick:function(){return this.animateScrollToBottom(L),this.setState({showNewCommentPill:!1})},onAddCommentFromList:function(t,e,n){return null==e&&(e={}),null==n&&(n=null),b.addComment({targetActivityKey:this.props.activity.activity_key,text:t,metadata:e}),this.scrollToBottom(),this.checkScroll()},isScrolledToBottom:function(){var e;return this.props.isTabNavEnabled?void 0:(e=t(this.refs.commentList.getDOMNode()),e[0].scrollHeight-e.scrollTop()-4<=e.outerHeight())},onCommentListMouseDown:function(e){return 0===t(e.target).parents(".threaded-comment-list").length?this.setState({allCommentsCollapsed:!0}):void 0},onAddSticker:function(t){return b.addStickerComment({targetActivityKey:this.props.activity.activity_key,stickerId:t})},onCommentExpanded:function(t,e){return this.scrollCommentIntoView(t,e),this.setState({allCommentsCollapsed:!1})},markCommentsSeenIfNecessary:function(){var t,e;return t=this.props.activity,null!=t?(e=n.findLastIndex(t.comment_activities,function(t){return!t.isPending}),e>=0?b.markCommentsSeen({lastSeenActivityKey:t.comment_activities[e].activity_key}):void 0):void 0},onScroll:function(){return this.checkScroll()},checkScroll:function(){var t;return this.props.isTabNavEnabled?void 0:(t=this.isScrolledToBottom(),this.setState({showBottomBar:!t,showNewCommentPill:!t&&this.state.showNewCommentPill}))},turnOnFeedback:function(){return b.setCommentsEnabled({enabled:!0})},_isActivityFetchDone:function(){return null!=this.props.activity},onFocus:function(){var t;return"function"==typeof(t=this.props).onInputFocus?t.onInputFocus():void 0},forceBlur:function(){return t(document.activeElement).blur()},animateScrollToBottom:function(e){var n;return null==e&&(e=600),this.props.isTabNavEnabled?void 0:(n=this.refs.commentList.getDOMNode(),t(n).animate({scrollTop:n.scrollHeight},{duration:e}))},scrollToBottom:function(){var t;return this.props.isTabNavEnabled?void 0:(t=this.refs.commentList.getDOMNode(),t.scrollTop=t.scrollHeight)},scrollCommentIntoView:function(e,n){var o,i;return this.props.isTabNavEnabled?void 0:(o=this.refs.commentList.getDOMNode(),i=e+n-o.offsetTop-t(o).outerHeight(),i>t(o).scrollTop()?t(o).animate({scrollTop:i},{duration:300}):void 0)},positionDropdownCallback:function(){var e,n,o,i;return this.props.isTabNavEnabled?void 0:(i=t(this.refs.commentList.getDOMNode()).outerHeight(),n=t(this.refs.commentListHeader.getDOMNode()).outerHeight(),o=t(this.refs.commentInput.getDOMNode()).outerHeight(),e=i+n+o,this.setState({shouldPopupsDropdown:Boolean(e/2>i)}))},renderLoadingSpinner:function(){var t;return V.div({className:"comments-loading"},t=e.createElement(a,{style:a.LoadingIndicatorStyle.BLUE_SPINNER}),null!=this.props.initialCommentsCount&&this.props.initialCommentsCount>0?V.div({className:"comments-loading__count",ref:"commentsLoadingCount"},G("Loading %(count)s comment","Loading %(count)s comments",this.props.initialCommentsCount).format({count:this.props.initialCommentsCount})):void 0)},renderBlankState:function(){return V.div({className:"blank-state"},V.div({className:"blank-state-illustration"},O({src:q("/static/images/commenting/comments_null_state-vflRF2RXk.png"),srcHiRes:q("/static/images/commenting/comments_null_state@2x-vflUmaRRX.png")})),V.div({className:"blank-state-text"},D({},'Post a comment to start a discussion. <span class="blue">@Mention</span> someone to notify them.')))},renderDisabledCommentState:function(){return V.div({className:"blank-state"},V.div({className:"blank-state-icon"},F({group:"web",name:"s_comments_locked"})),V.div({className:"blank-state-text"},D({},"Comments are off for this file.")),V.div({className:"blank-state-button"},S({importance:"secondary",onMouseUp:this.turnOnFeedback},D({},"Enable comments"))))},renderCommentField:function(t){var e;return(!this._isActivityFetchDone()||this.props.activity.feedback_off)&&this.props.showLoadingSpinner||this.props.isCommentInputDisabled?void 0:x({activity:this.props.activity,usersToNotify:null!=(e=this.props.activity)?e.users_to_notify:void 0,onAddComment:this.onAddCommentFromList,onCancelComment:this.forceBlur,contactSearchLogger:this.props.contactSearchLogger,onAddSticker:this.onAddSticker,ref:"commentInput",positionDropdownCallback:this.positionDropdownCallback,shouldPopupsDropdown:this.state.shouldPopupsDropdown,onFocus:this.onFocus,onBlur:this.props.onInputBlur,user:this.props.user,onShowNewComment:this.onNewCommentPillClick,showNewComment:this.state.showNewCommentPill,inBlankState:0===t.length,enableNotifyText:!this.props.enableFacepile,enableNoNotifyHint:this.props.enableNoNotifyHint,commentMetadataAllowed:T.ALLOW_STICKERS,shouldEnableStickers:T.ALLOW_STICKERS,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,isCommentInputDisabled:this.props.isCommentInputDisabled,enableImport:this.props.enableImport,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,shouldUseSimpleModals:this.props.shouldUseSimpleModals,isOffline:this.props.isOffline})},renderComment:function(t){return this.props.isThreadingEnabled?K({key:"threaded_"+t.activity_key,activity:this.props.activity,commentActivity:t,user:this.props.user,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,isVisibleAtMentions:this.props.isVisibleAtMentions,shouldShowAnnotationUIOnImages:this.props.shouldShowAnnotationUIOnImages,shouldAutoLinkify:this.props.shouldAutoLinkify,allCommentsCollapsed:this.state.allCommentsCollapsed,onCommentExpanded:this.onCommentExpanded,onCancelComment:this.forceBlur}):I({key:"comment_"+t.activity_key,parentActivity:this.props.activity,fileActivity:this.props.activity,comment_activity:t,user:this.props.user,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,isVisibleAtMentions:this.props.isVisibleAtMentions,shouldShowAnnotationUIOnImages:this.props.shouldShowAnnotationUIOnImages,shouldAutoLinkify:this.props.shouldAutoLinkify,isOffline:this.props.isOffline})},renderCommentGroup:function(t,e){return V.div({className:"comment-group"},V.div({className:"time"},t),e)},renderAnnotationGroup:function(t,e){return V.div({className:"comment-group"},t?V.div({className:"time"},"Page "+t):void 0,e)},renderCommentList:function(t){return this._isActivityFetchDone()?this._isActivityFetchDone()&&this.props.activity.feedback_off?this.renderDisabledCommentState():t.length>0?t:this._isActivityFetchDone()?this.renderBlankState():void 0:this.props.showLoadingSpinner?this.renderLoadingSpinner():this.renderBlankState()},renderCommentListOptions:function(t){var e,n;return n=this._isActivityFetchDone()&&this.props.activity.feedback_off,e=this._isActivityFetchDone()&&this.props.activity.can_edit_feedback,N({numResolved:t,show_resolved:this.props.showResolvedComments,is_subscribed:this.props.isUserSubscribed,shouldShowHideButton:this.props.shouldShowHideButton,shouldShowDisableButton:!n&&e,feedback_off:n,activity_context:this.props.context,activity:this.props.activity,user:this.props.user,isOffline:this.props.isOffline})},render:function(){var t,e,n,i,s,r,a,c,u,d,p,h,m,f,_,v,y,g,b,T,C,S,A;if(r=[],e=[],y=0,v=0,_=0,this._isActivityFetchDone()){if(d=w.filterCommentActivities(this.props.activity.comment_activities,{includeAnnotations:!this.props.isTabNavEnabled,includeDocLevel:!0,includeResolved:this.props.showResolvedComments,sortBy:this.props.isTabNavEnabled?w.sortByTime:void 0}),this.props.isThreadingEnabled)for(C=w.groupCommentActivitiesByTime(d),b=C[0],i=C[1],p=0,m=b.length;m>p;p++)A=b[p],a=function(){var t,e,o,s;for(o=i[A],s=[],t=0,e=o.length;e>t;t++)n=o[t],s.push(this.renderComment(n));return s}.call(this),r.push(this.renderCommentGroup(A,a));else r=function(){var t,e,o;for(o=[],t=0,e=d.length;e>t;t++)n=d[t],o.push(this.renderComment(n));return o}.call(this);if(y=w.getNumResolved(d),v=d.length,this.props.isTabNavEnabled){if(u=w.filterCommentActivities(this.props.activity.comment_activities,{includeAnnotations:!0,includeDocLevel:!1,includeResolved:this.props.showResolvedComments,sortBy:w.sortByCoordinates}),this.props.isThreadingEnabled)for(S=w.groupAnnotationActivitiesByPage(u),g=S[0],t=S[1],h=0,f=g.length;f>h;h++)T=g[h],a=function(){var e,o,i,s;for(i=t[T],s=[],e=0,o=i.length;o>e;e++)n=i[e],s.push(this.renderComment(n));return s}.call(this),e.push(this.renderAnnotationGroup(T,a));else e=function(){var t,e,o;for(o=[],t=0,e=u.length;e>t;t++)n=u[t],o.push(this.renderComment(n));return o}.call(this);_=u.length}}return s=o({"comment-list":!0,scrolled:this.state.showBottomBar}),c=o({"comments-holder":!0,"comments-activity-loaded":this._isActivityFetchDone(),"comments-holder-responsive":"ON"===l.getGandalfRule("comments_responsive_width"),"threading-enabled":this.props.isThreadingEnabled,"tab-nav-enabled":this.props.isTabNavEnabled}),this.props.isTabNavEnabled?V.div({className:c,ref:"commentsHolder"},E({ref:"tabNav",commentField:this.renderCommentField(r),commentList:this.renderCommentList(r),annotationList:this.renderCommentList(e),commentListOptions:this.renderCommentListOptions(y),selectedTab:this.props.selectedTab,numComments:v,numAnnotations:_})):V.div({className:c,ref:"commentsHolder"},P({ref:"commentListHeader",activity:this.props.activity,user:this.props.user,commentListOptions:this.renderCommentListOptions(y)}),V.div({className:s,ref:"commentList",onScroll:this.onScroll,onMouseDown:this.onCommentListMouseDown},this.renderCommentList(r)),this.renderCommentField(r))}})})}.call(this),function(){define("modules/clean/react/file_comments/comment_tab_nav",["jquery","external/react","external/classnames","modules/core/i18n","modules/clean/react/tabs/tab_nav","modules/clean/react/tabs/tab_util","modules/clean/comments/actions"],function(t,e,n,o,i,s,r){var a,l,c,u,d,p,h;return d=o._,h=o.ungettext,p=e.DOM,u=e.createFactory(i),c="tab_nav_comments",l="tab_nav_annotations",a=e.createClass({displayName:"CommentTabNav",propTypes:{commentListOptions:e.PropTypes.node,commentField:e.PropTypes.node,commentList:e.PropTypes.arrayOf(e.PropTypes.node),annotationList:e.PropTypes.arrayOf(e.PropTypes.node),selectedTab:e.PropTypes.oneOf([c,l]),numComments:e.PropTypes.number.isRequired,numAnnotations:e.PropTypes.number.isRequired},getDefaultProps:function(){return{selectedTab:c}},onTabNavChange:function(t){return r.switchTabs({selectedTab:t})},_getCommentsTabLabel:function(){return h("Comment (%(num)s)","Comments (%(num)s)",this.props.numComments).format({num:this.props.numComments})},_getAnnotationsTabLabel:function(){return h("Annotation (%(num)s)","Annotations (%(num)s)",this.props.numAnnotations).format({num:this.props.numAnnotations})},render:function(){var t,e;return e=n({"comments-tab-content":!0,hidden:this.props.selectedTab===l}),t=n({"annotations-tab-content":!0,hidden:this.props.selectedTab===c}),p.div({className:"comments-tab-nav__container"},p.div({className:"comments-tab-nav__options"},this.props.commentListOptions),u({tabs:[{value:c,label:this._getCommentsTabLabel()},{value:l,label:this._getAnnotationsTabLabel()}],defaultSelectedIndex:[c,l].indexOf(this.props.selectedTab),onChange:this.onTabNavChange,variant:s.variants.UNDERLINE+" comments-tab-nav__variant"},p.div({className:e},p.div({className:"comment-list"},null!=this.props.commentField?p.div({className:"comment-field-wrapper threaded-comment-list"},this.props.commentField):void 0,this.props.commentList)),p.div({className:t},p.div({ref:"annotationList",className:"comment-list"},this.props.annotationList))))}}),{CommentTabNavClass:a,TAB_NAV_COMMENTS:c,TAB_NAV_ANNOTATIONS:l}})}.call(this),function(){define("modules/clean/react/file_comments/file_comments_pane",["jquery","external/underscore","external/react","modules/core/i18n","modules/core/notify","modules/constants/comments_panel","modules/clean/activity/activity","modules/clean/analytics","modules/clean/file_activity/api","modules/clean/gandalf_util","modules/clean/react/modal","modules/clean/react/react_i18n","modules/clean/react/sprite","modules/clean/react/file_comments/comment_list_ui","modules/clean/react/file_comments/onboarding","modules/clean/react/file_viewer/actions","modules/clean/comments/action_creators","modules/clean/comments/events","modules/clean/comments/utils"],function(t,e,n,o,i,s,r,a,l,c,u,d,p,h,m,f,_,v,y){var g,b,w,T,C,S,A,I,x,P,N,k;return N=o._,T=r.FileActivity,w=a.ContactSearchLogger,x=u.SimpleModal,S=u.Modal,k=n.DOM,I=d.R_,g=n.createFactory(h),P=n.createFactory(p),b=n.createFactory(m),A=1e3,C=n.createClass({displayName:"FileCommentsPane",mixins:[n.addons.PureRenderMixin],propTypes:{showButtonColor:n.PropTypes.string.isRequired,activity:n.PropTypes.instanceOf(T),context:n.PropTypes.number,contextData:n.PropTypes.string,showResolvedComments:n.PropTypes.bool,isPreviewReady:n.PropTypes.bool,showLoadingSpinner:n.PropTypes.bool,isCommentsHidden:n.PropTypes.bool,feedbackId:n.PropTypes.string.isRequired,userId:n.PropTypes.number,showDisabledCommentBar:n.PropTypes.bool,previewSelector:n.PropTypes.string,shouldInitiallyFocusInput:n.PropTypes.bool,canCollapse:n.PropTypes.bool,shouldAutoLinkify:n.PropTypes.bool,enableImport:n.PropTypes.bool,shouldUseSimpleModals:n.PropTypes.bool,shouldHidePhotoAvatars:n.PropTypes.bool,oref:n.PropTypes.string,shouldCheckOffline:n.PropTypes.bool,shouldShowOnboarding:n.PropTypes.bool,onOnboardingModalOpen:n.PropTypes.func,shouldAnnotationButtonUseThumbnailUrls:n.PropTypes.bool,initialCommentsCount:n.PropTypes.number,shouldTrackCollapsedState:n.PropTypes.bool},getInitialState:function(){return{icon:"s_comments_locked",isCommentInputDisabled:!1,isOffline:!1,height:0}},getDefaultProps:function(){return{canCollapse:!0,shouldAutoLinkify:!0,enableImport:!0,shouldUseSimpleModals:!1,shouldHidePhotoAvatars:!1,file:null,shouldCheckOffline:!1,shouldShowOnboarding:!1,shouldAnnotationButtonUseThumbnailUrls:"ON"===c.getGandalfRule("comments_annotation_thumbnails")}},componentWillMount:function(){return this.isFileViewerReactEnabled=c.getGandalfRule("file_viewer_react"),this.isAnnotationCreationEnabled=c.getGandalfRule("comments_annotation_marker")||c.getGandalfRule("comments_annotation_highlight")||c.getGandalfRule("comments_annotation_region"),this.isAnnotationGhostEnabled=c.getGandalfRule("comments_annotation_ghost"),this.isThreadingEnabled=c.getGandalfRule("comments_threading"),this.isImagePreviewAnnotationEnabled=c.getGandalfRule("comments_annotation_image_previews")},componentDidMount:function(){return this._refreshWidth(),this.contactSearchLogger=new w,this.props.shouldCheckOffline?(this._checkAndSetIsOffline(),this.offlineInterval=setInterval(this._checkAndSetIsOffline,A)):void 0},maybeShowOnboardingModal:function(){var t;return this.props.shouldShowOnboarding?(t=b({onOpen:this.props.onOnboardingModalOpen}),S.showInstance(t)):void 0},fitToHeight:function(t){
return this.state.height!==t?this.setState({height:t}):void 0},_isAnnotationCreationEnabled:function(){return this.isAnnotationCreationEnabled&&this._isCommentsOnAndVisible()},_isPreviewAndCommentsReady:function(){return this.state.enabled&&null!=this._getActivity()&&this.previewIsReady&&!this.state.isFetchingActivity},_fileHasReplies:function(){var t,e,n,o;if(null!=this._getActivity())for(o=this._getActivity().comment_activities,e=0,n=o.length;n>e;e++)if(t=o[e],t.comment_activities.length>0)return!0;return!1},_isThreadingEnabled:function(){return this.isThreadingEnabled||this._fileHasReplies()},_checkAndSetIsOffline:function(){return this.setState({isOffline:!navigator.onLine})},_getActivity:function(){return this.props.activity},_showResolvedComments:function(){return this.props.showResolvedComments},_isUserSubscribed:function(){var t,e,n,o;if(this._getActivity()&&this._getActivity().users_to_notify)for(n=this._getActivity().users_to_notify,t=0,e=n.length;e>t;t++)if(o=n[t],o.id===this.getActivityUser().id)return!0;return!1},showFeedbackModal:function(e){var n;return null!=e&&e.preventDefault(),n='<div class="text-input comment-feedback-input"> <div class="text-input-wrapper"> <textarea id="comments-feedback-input" placeholder="Let us know how we can improve commenting in Dropbox." ></textarea> </div> </div>',x.show({title_text:N("Help us improve comments"),body_html:n,cancel_text:N("Cancel"),confirm_text:N("Submit Feedback"),confirm_callback:function(e){return function(){var n,o,s;return n=t("#comments-feedback-input").val(),s=function(){return i.success(N("Thank you! Your feedback will help improve Dropbox."))},o=function(){return function(){return i.error(N("There was an error submitting your feedback."))}},l.submitProductFeedback({actorId:e.props.userId,feedbackText:n,context:e.props.context,contextData:e.props.contextData,oref:e.props.oref}).then(s,o)}}(this)})},getActivityUser:function(){return y.getActivityUser(this.props.userId)},setLockedIcon:function(){return this.setState({icon:"s_comments_locked"})},setUnlockedIcon:function(){return this.setState({icon:"s_comments_unlocked"})},show:function(){return _.showComments(),v.emit("show-comments-pane")},_refreshWidth:function(){return t(".video-js").length?t(".video-js").css("width","100%"):void 0},render:function(){var t,e,o,i,r,a;return o=!this.props.isCommentsHidden,t=n.addons.classSet({"file-feedback":!0,"preview-ready":this.props.isPreviewReady,hidden:!this.state.enabled}),a=this.getActivityUser(),r=a.is_signed_in&&c.getGandalfRule("comments_web_feedback"),e=0!==this.state.height?{height:this.state.height}:{},o||!this.props.canCollapse?k.div({id:this.props.feedbackId,ref:"fileCommentsPane",className:t,tabIndex:"-1",style:e},k.div({className:"comments-and-feedback"},this.state.isOffline?k.div({className:"comments-offline-banner"},k.div({className:"comments-offline-banner-inner"},I({},"No Internet Connection"))):void 0,g({ref:"commentListUI",showLoadingSpinner:this.props.showLoadingSpinner,context:this.props.context,activity:this._getActivity(),user:a,contactSearchLogger:this.contactSearchLogger,initialCommentsCount:this.props.initialCommentsCount,highlightedActivityKey:this.props.highlightedActivityKey,selectedTab:this.props.selectedTab,enableFacepile:c.isGandalfInVariant("comments_notify_facepile","FACEPILE"),enableNoNotifyHint:c.isGandalfInVariant("comments_no_notify_hint","ON"),isUserSubscribed:this._isUserSubscribed(),shouldAutoLinkify:this.props.shouldAutoLinkify,shouldInitiallyFocusInput:this.props.shouldInitiallyFocusInput,showResolvedComments:this._showResolvedComments(),isCommentInputDisabled:this.state.isCommentInputDisabled,enableImport:this.props.enableImport,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,isThreadingEnabled:this._isThreadingEnabled(),isTabNavEnabled:s.IS_TAB_NAV_ENABLED,isVisibleAtMentions:c.isGandalfInVariant("comments_visible_at_mentions","ON"),isOffline:this.state.isOffline,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,shouldShowAnnotationUIOnImages:this.isImagePreviewAnnotationEnabled,shouldShowHideButton:Boolean(this.props.canCollapse&&this.props.shouldTrackCollapsedState)}),r?k.div({className:"comments-feedback-link"},k.div({className:"comments-feedback-link-inner"},k.a({onMouseUp:this.showFeedbackModal},I({},"Help us improve comments")))):void 0)):this.props.shouldTrackCollapsedState||o?o?(null!=(i=this._getActivity())?i.can_edit_feedback:void 0)?k.div({id:this.props.feedbackId,className:"hidden-comments",style:e,onMouseOver:this.setUnlockedIcon,onMouseOut:this.setLockedIcon},k.div({className:"show-button "+this.props.showButtonColor,onMouseDown:this.turnOnComments},k.div({className:"show-button-sprite"},P({group:"web",name:this.state.icon,alt:N("Show comments")})))):k.div({id:this.props.feedbackId,className:"hidden"}):k.div({id:this.props.feedbackId,className:"hidden-comments",style:e},k.div({className:"show-button "+this.props.showButtonColor,onMouseDown:this.show},k.div({className:"show-button-sprite"},P({group:"web",name:"s_show_comments_grey",alt:N("Show comments")})))):k.div({id:this.props.feedbackId,className:"hidden"})}}),{FileCommentsPaneClass:C}})}.call(this),function(){define("modules/clean/react/file_comments/logger",["modules/clean/ajax","modules/clean/activity/activity","modules/clean/activity/like","modules/clean/annotations/annotation","modules/clean/viewer","modules/core/exception"],function(t,e,n,o,i,s){var r,a,l;return r=o.Annotation,a=function(){function e(){}return e.prototype.log_event=function(e,n,o,i,r,a,l,c,u){return null==l&&(l=null),null==c&&(c=null),null==u&&(u=null),s.assert(e,"event_type not provided"),s.assert(n,"file_activity_key not provided"),t.SilentBackgroundRequest({url:"/file_activity/client_log",type:"POST",data:{event_type:e,file_activity_key:n,comment_activity_key:o,client_origin_type:i,activity_context:a,annotation_type:l,annotation_subtype:c,annotation_page:u},subject_user:r})},e.prototype.log_annotation_event=function(t,e,n,o,i,s){var a,l,c,u;return null==s&&(s=null),null!=s&&(a=r.createAnnotationFromDict(s),u=a.type,c=a.subtype,l=a.getFirstPdfPage()),this.log_event(t,e,n,null,o,i,u,c,l)},e}(),l=new a})}.call(this),function(){var t=[].slice;define("modules/clean/react/file_comments/onboarding",["external/react","modules/core/i18n","modules/clean/gandalf_util","modules/clean/react/image","modules/clean/react/onboarding_modal","modules/clean/static_urls"],function(e,n,o,i,s,r){var a,l,c,u,d,p,h,m,f,_;return h=n._,_=r.static_url,f=e.DOM,m=e.addons.classSet,u=[{src:_("/static/images/commenting/onboarding_step1-vflB01-Fx.png"),srcHiRes:_("/static/images/commenting/onboarding_step1@2x-vflyooTgN.png")},{src:_("/static/images/commenting/onboarding_step2-vflQHsmaO.png"),srcHiRes:_("/static/images/commenting/onboarding_step2@2x-vflEm4vmD.png")},{src:_("/static/images/commenting/onboarding_step3-vflvKl_oO.png"),srcHiRes:_("/static/images/commenting/onboarding_step3@2x-vfljsqrRb.png")}],c=e.createFactory(s),l=e.createFactory(i),p=e.createClass({displayName:"Slide",mixins:[e.addons.PureRenderMixin],statics:{slideImages:u},propTypes:{heading:e.PropTypes.string.isRequired,subheading:e.PropTypes.string.isRequired,image:e.PropTypes.shape({src:e.PropTypes.string.isRequired,srcHiRes:e.PropTypes.string.isRequired}).isRequired,className:e.PropTypes.string},render:function(){return f.div({className:m("comment-onboarding-slide",this.props.className)},l({src:this.props.image.src,srcHiRes:this.props.image.srcHiRes,className:"comment-onboarding-illustration"}),f.h1({className:"comment-onboarding-heading"},this.props.heading),f.h2({className:"comment-onboarding-subheading"},this.props.subheading))}}),d=e.createFactory(p),a=e.createClass({displayName:"CommentingOnboardingModal",mixins:[e.addons.PureRenderMixin],PropTypes:{onOpen:e.PropTypes.func,onClose:e.PropTypes.func},componentDidMount:function(){var t;return"function"==typeof(t=this.props).onOpen?t.onOpen():void 0},getSlides:function(){return o.getGandalfRule("comments_inline_ea")?[d({className:"comment-slide-1",heading:h("Annotate your files"),subheading:h("Give clear, focused feedback that’s faster than email."),image:u[0]}),d({className:"comment-slide-2",heading:h("Point to what you’re talking about"),subheading:h("Just click anywhere inside the doc, or drag around a specific area."),image:u[1]}),d({className:"comment-slide-3",heading:h("Never lose track of feedback"),subheading:h("Conversations stay with the file, and you can view on any device."),image:u[2]})]:[d({className:"comment-slide-1",heading:h("Comment on your files"),subheading:h("Give clear, focused feedback that’s faster than email."),image:u[0]}),d({className:"comment-slide-2",heading:h("Never lose track of feedback"),subheading:h("Conversations stay with the file, and you can view on any device."),image:u[2]})]},render:function(){return c.apply(null,[{className:"comment-onboarding-modal",slideWidth:600,onClose:this.props.onClose}].concat(t.call(this.getSlides())))}})})}.call(this),function(){var t=function(t,e){return function(){return t.apply(e,arguments)}};define("modules/clean/react/file_comments/shared_link_signup_modals",["jquery","modules/clean/ajax","modules/clean/dbmodal","modules/clean/react/file_comments/logger","modules/constants/legacy","modules/core/browser","modules/core/i18n","modules/core/notify"],function(e,n,o,i,s,r,a,l){var c,u,d;return u=o.DBModal,d=a._,c=function(){function e(){this._toggle_form=t(this._toggle_form,this),this._prepare_form=t(this._prepare_form,this),this._reload=t(this._reload,this),this.before_modal=t(this.before_modal,this),this.show_sign_in_modal=t(this.show_sign_in_modal,this),this.show_sign_up_modal=t(this.show_sign_up_modal,this),this.hide_modal=t(this.hide_modal,this),this.init_modals=t(this.init_modals,this),this.show_register=!1,this.init_modals()}return e.POST_COMMENT_VARIANT="post_comment_variant",e.LIKE_COMMENT_VARIANT="like_comment_variant",e.SUBSCRIBE_VARIANT="subscribe_variant",e.prototype.init_modals=function(){return this.default_signup_modal=new u({element_id:"shared-link-default-comments-signup-modal"}),this.default_signup_modal.before_show=this.before_modal},e.prototype.hide_modal=function(){return this.default_signup_modal.hide()},e.prototype.show_sign_up_modal=function(t){return this.show_register=!0,this.variant=t,this.default_signup_modal.show()},e.prototype.show_sign_in_modal=function(t){return this.show_register=!1,this.variant=t,this.default_signup_modal.show()},e.prototype.set_activity_key=function(t){return this.activity_key=t},e.prototype.before_modal=function(t){var e,n;return this._prepare_form(t),t.find(".toggle-form-link").click(function(e){return function(){return e._toggle_form(t)}}(this)),n=t.find(".register-form"),n.length&&n.on("db:register:success",function(t){return function(e,n){return t.user=n,l.success(d("Successfully signed up for Dropbox")),i.log_event(s.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_UP_SUCCESS,t.activity_key,null,null,t.user.id),t._reload()}}(this)),e=t.find(".login-form"),e.length?(n.length&&n.on("db:register:user_exists",function(n){return function(o){var i,s,r,a,l;for(n._toggle_form(t),a=o.prefill,l=i=0,r=a.length;r>i;l=++i)s=a[l],e.find(s).val(l);return e.find(o.focus).focus()}}(this)),e.on("db:login:success",function(t){return function(e,n){return t.user=n,l.success(d("Successfully signed in to Dropbox")),i.log_event(s.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_IN_SUCCESS,t.activity_key,null,null,t.user.id),t._reload()}}(this))):void 0},e.prototype._reload=function(){return r.reload()},e.prototype._prepare_form=function(t){switch(t.find(".form-component").hide(),t.find(".text-variant").hide(),this.show_register?t.find(".register-form-component").show():t.find(".login-form-component").show(),this.variant){case e.POST_COMMENT_VARIANT:return t.find(".text-variant.post-comment-variant").show();case e.LIKE_COMMENT_VARIANT:return t.find(".text-variant.like-comment-variant").show();case e.SUBSCRIBE_VARIANT:return t.find(".text-variant.subscribe-variant").show();default:return t.find(".text-variant.default-variant").show()}},e.prototype._toggle_form=function(t){var e,n,o;return o=t.find(".register-form-component"),n=t.find(".login-form-component"),o.is(":visible")?(e=s.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_IN_MODAL,o.fadeOut({complete:function(){return n.show()}})):(e=s.FILE_ACTIVITY_LOG_EVENT_TYPE.CLIENT_SIGN_UP_MODAL,n.fadeOut({complete:function(){return o.show()}})),i.log_event(e,this.activity_key,null,s.FILE_ACTIVITY_LOG_CLIENT_ORIGIN_TYPE.MODAL_TOGGLE_BUTTON)},e}()})}.call(this),function(){define("modules/clean/react/file_comments/stickers",["jquery","external/react","external/immutable","external/underscore","modules/clean/sticker_util"],function(t,e,n,o,i){var s,r,a,l;return l=e.DOM,s=e.createFactory(e.createClass({displayName:"StickerSet",propTypes:{onStickerClick:e.PropTypes.func,isSelected:e.PropTypes.bool,data:e.PropTypes.object},_onStickerClick:function(t){var e;return t.preventDefault(),e=parseInt(t.currentTarget.getAttribute("data-sticker-id")),this.props.onStickerClick(e)},render:function(){var t,n,o,s;return n=e.addons.classSet,t=n({"sticker-set":!0,"is-selected":this.props.isSelected}),l.div({className:t},function(){var t,e,n,r;for(n=this.props.data.stickers,r=[],t=0,e=n.length;e>t;t++)o=n[t],s=i.getStickerImageUrl(o.id),r.push(l.a({onClick:this._onStickerClick,"data-sticker-id":o.id},l.img({src:s})));return r}.call(this))}})),r=e.createFactory(e.createClass({displayName:"StickerTab",propTypes:{data:e.PropTypes.object,onChangeSelection:e.PropTypes.func,isSelected:e.PropTypes.bool},_onStickerTabClick:function(t){return t.preventDefault(),this.props.onChangeSelection(this.props.data.name)},render:function(){var t,n;return n=e.addons.classSet,t=n({"sticker-nav-item":!0,"is-selected":this.props.isSelected}),l.a({className:t,onClick:this._onStickerTabClick},l.img({src:i.getStickerSetImageUrl(this.props.data.id)}))}})),a=e.createFactory(e.createClass({displayName:"Stickers",SCROLL_DISTANCE:200,propTypes:{onStickerSelected:e.PropTypes.func,isPopupAbove:e.PropTypes.bool},getInitialState:function(){return{selected:"CatBlobs",scrollOffset:0}},_onChangeSelection:function(t){return this.setState({selected:t})},_onStickerSelected:function(t){return this.props.onStickerSelected(t)},_getMaxScroll:function(){var e,n,o,i,s,r;for(r=0,s=this.getDOMNode().getElementsByClassName("sticker-nav-item"),o=0,i=s.length;i>o;o++)e=s[o],r+=t(e).outerWidth(!0);return n=60,this.refs.tabs.getDOMNode().offsetWidth-r-n},_onLeftArrowPress:function(t){return t.preventDefault(),this.setState({scrollOffset:Math.min(0,this.state.scrollOffset+this.SCROLL_DISTANCE)})},_onRightArrowPress:function(t){return t.preventDefault(),this.setState({scrollOffset:Math.max(this._getMaxScroll(),this.state.scrollOffset-this.SCROLL_DISTANCE)})},_renderTabs:function(t){var n,o;return o=e.addons.classSet,n=o({"sticker-nav":!0,"show-left":this.state.scrollOffset<0,"show-right":!this.isMounted()||this.state.scrollOffset!==this._getMaxScroll(),"on-top":this.props.isPopupAbove,"on-bottom":!this.props.isPopupAbove}),l.div({className:n,ref:"tabs"},l.a({href:"#left",onClick:this._onLeftArrowPress,className:"arrow left"}),l.div({className:"sticker-nav-inner",ref:"tabScroller",style:{marginLeft:this.state.scrollOffset}},t),l.a({href:"#right",onClick:this._onRightArrowPress,className:"arrow right"}))},render:function(){var t,e,n,o,a,c;for(c=[],a=[],o=i.getStickers(),t=0,n=o.length;n>t;t++)e=o[t],c.push(new r({data:e,isSelected:e.name===this.state.selected,onChangeSelection:this._onChangeSelection})),a.push(new s({data:e,count:e.stickers.length,isSelected:e.name===this.state.selected,onStickerClick:this._onStickerSelected}));return l.div({className:"sticker-container",refs:"stickerContainer"},l.div({className:"sticker-menu-wrapper"},l.div({className:"sticker-menu"},this.props.isPopupAbove?this._renderTabs(c):void 0,l.div({className:"sticker-sets-wrapper"},a),this.props.isPopupAbove?void 0:this._renderTabs(c))))}})),{Stickers:a}})}.call(this),function(){define("modules/clean/react/file_comments/switch_revision_ui",["jquery","external/react","modules/clean/datetime","modules/clean/comments/action_creators"],function(t,e,n,o){var i,s;return s=e.DOM,i=e.createClass({displayName:"SwitchRevisionUI",mixins:[e.addons.PureRenderMixin],propTypes:{latestRevision:e.PropTypes.object,showSwitchRevisionUI:e.PropTypes.bool,revision:e.PropTypes.object},getInitialState:function(){return{}},getDefaultProps:function(){return{showSwitchRevisionUI:!1}},onSwitchToLatestRevision:function(){return o.switchRevision({revision:this.props.latestRevision})},render:function(){var t;return t=[],this.props.showSwitchRevisionUI&&(t=[s.div({className:"switch-revision-bar"},s.div({className:"switch-revision-bar__title"},s.span({},"Viewing old revision"),null==this.props.revision||null==this.props.revision.when||isNaN(new Date(null!=this.props.revision.when))?void 0:s.span({className:"switch-revision-bar__title__date"},""+n.ago(new Date(1e3*this.props.revision.when)))),s.div({className:"switch-revision-bar__actions"},s.a({className:"button-elm button-tertiary",onMouseUp:this.onSwitchToLatestRevision},"Switch back to latest revision")))]),s.div({className:"switch-revision-ui"},this.props.showSwitchRevisionUI?t:void 0)}})})}.call(this),function(){define("modules/clean/react/file_comments/threaded_comment_activity_ui",["jquery","external/react","external/underscore","modules/core/i18n","modules/clean/activity/activity","modules/clean/components/loading_indicator","modules/clean/datetime","modules/clean/gandalf_util","modules/clean/react/button","modules/clean/react/react_i18n","modules/clean/react/sprite","modules/clean/react/activity/comment_activity_ui","modules/clean/react/activity/comment_input","modules/clean/comments/action_creators","modules/constants/comments_panel"],function(t,e,n,o,i,s,r,a,l,c,u,d,p,h,m){var f,_,v,y,g;return g=o.ungettext,y=e.DOM,f=e.createFactory(d),_=e.createFactory(p),v=e.createClass({displayName:"ThreadedCommentActivityUI",mixins:[e.addons.PureRenderMixin],propTypes:{context:e.PropTypes.number,commentActivity:e.PropTypes.instanceOf(i.CommentActivity).isRequired,user:e.PropTypes.object.isRequired,shouldAnnotationButtonUseThumbnailUrls:e.PropTypes.bool,shouldAutoLinkify:e.PropTypes.bool,shouldUseSimpleModals:e.PropTypes.bool,shouldHidePhotoAvatars:e.PropTypes.bool,activity:e.PropTypes.instanceOf(i.FileActivity).isRequired,replyText:e.PropTypes.string,showResolvedComments:e.PropTypes.bool,contactSearchLogger:e.PropTypes.object,onReplyInputFocus:e.PropTypes.func,onReplyInputBlur:e.PropTypes.func,enableNoNotifyHint:e.PropTypes.bool,isCommentInputDisabled:e.PropTypes.bool,enableImport:e.PropTypes.bool,showNewComment:e.PropTypes.bool,shouldShowAnnotationUIOnImages:e.PropTypes.bool,isVisibleAtMentions:e.PropTypes.bool,allCommentsCollapsed:e.PropTypes.bool,checkScroll:e.PropTypes.func,onShowNewComment:e.PropTypes.func,onCommentExpanded:e.PropTypes.func,onCancelComment:e.PropTypes.func},getInitialState:function(){return{isExpanded:!1,isNewReplyLoading:!1,hover:!1}},getDefaultProps:function(){return{isVisibleAtMentions:!1,shouldAnnotationButtonUseThumbnailUrls:!1}},componentWillReceiveProps:function(t){return!this.props.allCommentsCollapsed&&t.allCommentsCollapsed?this.setState({isExpanded:!1}):void 0},componentDidUpdate:function(t,e){var n,o;return this.state.isExpanded&&!e.isExpanded&&null!=this.props.onCommentExpanded?(o=this.getDOMNode().offsetTop,n=this.getDOMNode().clientHeight,this.props.onCommentExpanded(o,n)):void 0},onAddCommentFromList:function(t,e){return null==e&&(e={}),h.addComment({targetActivityKey:this.props.commentActivity.activity_key,text:t,metadata:e}),h.updateAnnotationReplyText({activityKey:this.props.commentActivity.activity_key,text:null})},onAddSticker:function(t){return h.addStickerComment({targetActivityKey:this.props.commentActivity.activity_key,stickerId:t})},resizeCallback:function(t){var e,n;return null==t&&(t=!1),this.forceUpdate(),t&&null!=this.props.onCommentExpanded?(n=this.getDOMNode().offsetTop,e=this.getDOMNode().clientHeight,this.props.onCommentExpanded(n,e)):void 0},onToggleExpanded:function(t){if(this.state.isExpanded){if(this._shouldClickCollapseThread(t))return this.setState({isExpanded:!1})}else if(this._shouldClickExpandThread(t))return this.setState({isExpanded:!0})},_onMouseMove:function(t){return this.setState(this._shouldClickExpandThread(t)?{hover:!0}:{hover:!1})},_onMouseLeave:function(){return this.setState({hover:!1})},_shouldClickExpandThread:function(e){var n;return n=t(e.target),0===n.parents(".threaded-comment-header").length&&0===n.parents(".resolve-wrapper").length},_shouldClickCollapseThread:function(e){var n;return n=t(e.target),0!==n.closest(".threaded-comment-header").length&&0===n.closest(".resolve-wrapper").length&&0===n.closest(".annotation-thumbnail-page").length&&0===n.closest(".annotation-thumbnail-label").length},hasReplies:function(){return this.repliesCount()>0},repliesCount:function(){return this.props.commentActivity.comment_activities.length},renderCommentActivityUI:function(t,e,n,o){return null==n&&(n=!1),null==o&&(o=!1),f({key:"comment_"+e.activity_key,parentActivity:t,fileActivity:this.props.activity,comment_activity:e,user:this.props.user,shouldUseSimpleModals:this.props.shouldUseSimpleModals,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,shouldShowReplyButton:o,isVisibleAtMentions:this.props.isVisibleAtMentions,shouldAnnotationButtonUseThumbnailUrls:this.props.shouldAnnotationButtonUseThumbnailUrls,shouldShowAnnotationUIOnImages:this.props.shouldShowAnnotationUIOnImages,shouldAutoLinkify:this.props.shouldAutoLinkify,isReply:n,isInThread:!0,isExpanded:this.state.isExpanded,truncateLength:100,threadHover:this.state.hover})},onReplyInputFocus:function(){var t;return"function"==typeof(t=this.props).onReplyInputFocus?t.onReplyInputFocus():void 0},render:function(){var t,n,o,i,r,a,l,c;if(l=e.createElement(s,{style:s.LoadingIndicatorStyle.BLUE_SPINNER}),n=[],this.hasReplies())for(c=this.props.commentActivity.comment_activities,i=o=0,a=c.length;a>o;i=++o)t=c[i],t.comment.resolved&&!this.props.showResolvedComments||t.isDeleted||(r=i===this.repliesCount()-1,n.push(this.renderCommentActivityUI(this.props.commentActivity,t,!0,r)));return y.div({className:"threaded-comment-list","data-comment-activity-key":this.props.commentActivity.activity_key,onMouseUp:this.onToggleExpanded,onMouseMove:this._onMouseMove,onMouseLeave:this._onMouseLeave},y.div({},this.renderCommentActivityUI(this.props.activity,this.props.commentActivity,!1,!(this.hasReplies()||this.props.commentActivity.isPending))),this.hasReplies()?y.div({},this.repliesCount()>1&&!this.state.isExpanded?y.div({},y.a({className:"replies-count-button"},g("%(num)s more reply","%(num)s more replies",this.repliesCount()-1).format({num:this.repliesCount()-1})),y.div({},n[n.length-1])):n):void 0,this.state.isNewReplyLoading?y.div({className:"comments-loading"},l):void 0,this.state.isExpanded&&!this.props.commentActivity.isPending?_({ref:"commentInput",activity:this.props.activity,user:this.props.user,usersToNotify:this.props.commentActivity.users_to_notify,onAddComment:this.onAddCommentFromList,onCancelComment:this.props.onCancelComment,contactSearchLogger:this.props.contactSearchLogger,onAddSticker:this.onAddSticker,resizeCallback:this.resizeCallback,popupsShouldDropdown:this.state.popupsShouldDropdown,onFocus:this.onReplyInputFocus,onBlur:this.props.onReplyInputBlur,onShowNewComment:this.props.onShowNewComment,showNewComment:this.props.showNewComment,initialText:this.props.replyText,enableNotifyText:!0,enableNoNotifyHint:this.props.enableNoNotifyHint,commentMetadataAllowed:m.ALLOW_STICKERS,shouldEnableStickers:m.ALLOW_STICKERS,shouldInitiallyFocusInput:!0,isCommentInputDisabled:this.props.isCommentInputDisabled,enableImport:this.props.enableImport,shouldHidePhotoAvatars:this.props.shouldHidePhotoAvatars,isReplyInput:!0,shouldShowAvatar:!0}):void 0)}})})}.call(this),function(){define("modules/clean/react/file_comments/threaded_comment_header",["external/react","external/underscore","jquery","modules/clean/datetime","modules/clean/annotations/annotation","modules/clean/react/activity/resolve_button","modules/clean/react/activity/annotation_button","modules/core/i18n"],function(t,e,n,o,i,s,r,a){var l,c,u,d,p,h,m,f,_;return l=i.Annotation,p=i.AnnotationTypes,c=i.AnnotationSubtypes,d=r.AnnotationThumbnailClass,f=a._,h=t.createFactory(s),u=t.createFactory(d),_=t.DOM,m=t.createClass({displayName:"ThreadedCommentHeader",mixins:[t.addons.PureRenderMixin],propTypes:{annotation:t.PropTypes.object,revision:t.PropTypes.object,isOldRevision:t.PropTypes.bool,onAnnotationButtonMouseUp:t.PropTypes.func,thumbnailUrl:t.PropTypes.string,shouldShowAnnotationUIOnImages:t.PropTypes.bool,isHeader:t.PropTypes.bool,onUpdateResolve:t.PropTypes.func,isOffline:t.PropTypes.bool,shouldShowResolveButton:t.PropTypes.bool,resolved:t.PropTypes.bool},_getPrimaryText:function(){return this.props.annotation.isPdfAnnotation()?f("View on Page %(page_number)s").format({page_number:this.props.annotation.getFirstPdfPage()}):this.props.annotation.isImageAnnotation()?f("View annotation"):void 0},onThreadedCommentHeaderMouseUp:function(t){return 0===n(t.target).parents(".resolve-wrapper").length?this.props.onAnnotationButtonMouseUp(t):void 0},render:function(){var e;return e=t.addons.classSet({"annotation-thumbnail-label":!0,"is-on-old-revision":this.props.isOldRevision}),_.div({className:"threaded-comment-header comment-annotation",onMouseUp:this.onThreadedCommentHeaderMouseUp},_.div({className:"comment-annotation-button"},_.div({className:"annotation-page-label"},u({annotation:this.props.annotation,thumbnailUrl:this.props.thumbnailUrl,shouldShowAnnotationUIOnImages:this.props.shouldShowAnnotationUIOnImages}),_.div({className:e},_.a({className:"label"},this._getPrimaryText(this.props.annotation)),this.props.isOldRevision?_.div({className:"older-revision"},f("(on older revision)")):void 0)),this.props.shouldShowResolveButton?h({resolved:this.props.resolved,onUpdateResolve:this.props.onUpdateResolve,isOffline:this.props.isOffline}):void 0))}})})}.call(this),function(){define("modules/clean/react/onboarding_modal",["external/react","modules/core/i18n","modules/core/exception","modules/clean/react/button","modules/clean/react/modal","modules/clean/react/slider"],function(t,e,n,o,i,s){var r,a,l,c,u,d,p,h,m,f,_,v,y,g,b,w,T,C,S,A;return T=e._,C=n.assert,a=o.button,p=i.Modal,u=s.IndicatorGroup,w=s.Slides,g=s.Slider,m=s.NavButtonGroup,A=t.DOM,S=t.addons.classSet,d=t.createFactory(p),r=t.createFactory(a),y=t.createFactory(g),b=t.createFactory(w),c=t.createFactory(u),h=t.createFactory(m),l=640,v=t.createClass({displayName:"OnboardingSlider",mixins:[t.addons.PureRenderMixin],propTypes:{width:t.PropTypes.number.isRequired,height:t.PropTypes.number,className:t.PropTypes.string,onSlideChange:t.PropTypes.func,onSlideEnd:t.PropTypes.func,initialSlideIndex:t.PropTypes.number,children:function(e,n,o){var i;return i=t.Children.count(e[n]),C(i>0,o+" has no slide to show")}},getDefaultProps:function(){return{initialSlideIndex:0}},getInitialState:function(){return{currentSlideIndex:this.props.initialSlideIndex}},isAtLastSlide:function(){return this.state.currentSlideIndex+1===this.getSlideCount()},getSlideCount:function(){return t.Children.count(this.props.children)},gotoSlide:function(t){return t!==this.state.currentSlideIndex?(C(t>=0&&t<this.getSlideCount(),"Invalid slide index: "+t),this.setState({currentSlideIndex:t},function(e){return function(){var n;return"function"==typeof(n=e.props).onSlideChange?n.onSlideChange(t):void 0}}(this))):void 0},prevSlide:function(){return this.gotoSlide(this.state.currentSlideIndex-1)},nextSlide:function(){return this.gotoSlide(this.state.currentSlideIndex+1)},render:function(){return y({className:this.props.className},b({width:this.props.width,height:this.props.height,currentSlideIndex:this.state.currentSlideIndex},this.props.children),c({slideCount:this.getSlideCount(),currentSlideIndex:this.state.currentSlideIndex,onIndicatorClick:this.gotoSlide}),h(null,this.isAtLastSlide()?r({className:"is-done",onClick:this.props.onSlideEnd},T("Got it")):r({className:"is-next",onClick:this.nextSlide},T("Next"))))}}),_=t.createFactory(v),f=t.createClass({displayName:"OnboardingModal",mixins:[t.addons.PureRenderMixin],propTypes:{className:t.PropTypes.string,onClose:t.PropTypes.func,slideWidth:t.PropTypes.number,slideHeight:t.PropTypes.number,initialSlideIndex:t.PropTypes.number},getDefaultProps:function(){return{slideWidth:l}},closeModal:function(){var t;return p.close(),"function"==typeof(t=this.props).onClose?t.onClose():void 0},render:function(){return d({acceptButtonText:null,onDismiss:this.props.onClose,style:"clean",className:this.props.className,clickOutToClose:!1},_({initialSlideIndex:this.props.initialSlideIndex,width:this.props.slideWidth,height:this.props.slideHeight,onSlideEnd:this.closeModal},this.props.children))}})})}.call(this),function(){define("modules/clean/react/slider",["external/react","modules/clean/css"],function(t,e){var n,o,i,s,r,a,l;return l=e.require_css,a=t.DOM,r=t.addons.classSet,n=t.createClass({displayName:"IndicatorGroup",mixins:[t.addons.PureRenderMixin],propTypes:{className:t.PropTypes.string,currentSlideIndex:t.PropTypes.number.isRequired,slideCount:t.PropTypes.number.isRequired,onIndicatorClick:t.PropTypes.func},render:function(){var t;return a.ul({className:r("c-slider__indicator-group",this.props.className)},function(){t=[];for(var e=0,n=this.props.slideCount;n>=0?n>e:e>n;n>=0?e++:e--)t.push(e);return t}.apply(this).map(function(t){return function(e){return a.li({key:"indicator-"+e,className:r({"c-slider__indicator":!0,"is-active":e===t.props.currentSlideIndex}),onClick:function(){var n;return"function"==typeof(n=t.props).onIndicatorClick?n.onIndicatorClick(e):void 0}})}}(this)))}}),o=t.createClass({displayName:"NavButtonGroup",mixins:[t.addons.PureRenderMixin],propTypes:{className:t.PropTypes.string},render:function(){return a.div({className:r("c-slider__nav-button-group",this.props.className)},this.props.children)}}),s=t.createClass({displayName:"Slides",mixins:[t.addons.PureRenderMixin],propTypes:{currentSlideIndex:t.PropTypes.number.isRequired,width:t.PropTypes.number.isRequired,height:t.PropTypes.number},getSlideCount:function(){return t.Children.count(this.props.children)},render:function(){var e;return a.div({className:"c-slider__window",style:{width:this.props.width+"px",height:null!=(e=this.props.height)?e:"auto"}},a.div({className:"c-slider__slides"},t.Children.map(this.props.children,function(t){return function(e,n){return a.div({className:r({"c-slider__slide":"c-slider__slide","is-active":t.props.currentSlideIndex===n}),style:{width:t.props.width+"px",transform:"translateX("+100*-t.props.currentSlideIndex+"%)"}},e)}}(this))))}}),i=t.createClass({displayName:"Slider",mixins:[t.addons.PureRenderMixin],propTypes:{className:t.PropTypes.string},componentWillMount:function(){return l("/static/css/components/slider-vflbeTc0k.css")},render:function(){return a.div({className:r("c-slider",this.props.className)},this.props.children)}}),{NavButtonGroup:o,Slider:i,IndicatorGroup:n,Slides:s}})}.call(this),function(){define("modules/clean/react/tabs/tab_bar",["jquery","external/classnames","external/underscore","external/react","modules/clean/css","modules/clean/keycode","modules/clean/react/tabs/tab_util"],function(t,e,n,o,i,s,r){var a;return a=o.PropTypes,o.createClass({displayName:"TabBar",propTypes:{tabs:a.arrayOf(a.oneOfType([a.string,a.number,a.shape({value:a.oneOfType([a.string,a.number]),label:a.string,rightAlign:a.bool})])).isRequired,selectedIndex:a.number,onChange:a.func,idPrefix:a.string},getDefaultProps:function(){return{selectedIndex:0,onChange:function(){}}},componentDidMount:function(){return this._fixTabWidth()},componentDidUpdate:function(){return this._fixTabWidth();

},_fixTabWidth:function(){return t("a",this.getDOMNode()).width(function(){return t(this).width()})},_normalizedTabs:function(){return this.props.tabs.map(function(t){return("string"==typeof t||"number"==typeof t)&&(t={value:t,label:t}),t})},_onKeydown:function(t){var e,n,o,i;return i=this._normalizedTabs(),e=null,(n=t.keyCode)===s.LEFT||n===s.UP?e=0===this.props.selectedIndex?i.length-1:this.props.selectedIndex-1:((o=t.keyCode)===s.RIGHT||o===s.DOWN)&&(e=this.props.selectedIndex===i.length-1?0:this.props.selectedIndex+1),null!=e?(t.preventDefault(),this._selectTab(e,{focusOnTab:!0})):void 0},_selectTab:function(t,e){var n;return null==e&&(e={}),n=this._normalizedTabs()[t],this.props.onChange(n.value,t),e.focusOnTab===!0?this.refs[t].getDOMNode().focus():void 0},_onClick:function(t,e){return e.preventDefault(),t!==this.props.selectedIndex?this._selectTab(t,{focusOnTab:!0}):void 0},_renderTab:function(t,n,i){var s,a,l,c,u;return a=e({"c-tabs__tab":!0,"c-tabs__tab--selected":n===this.props.selectedIndex,"c-tabs__tab--fr":t.rightAlign,"c-tabs__tab--rightmost":i}),c=n===this.props.selectedIndex,l=t.contentId?t.contentId:c?r.getTabContentId(this.props.idPrefix):"",u=c?"0":"-1",s=o.createElement("a",{href:"#",ref:n,id:r.getTabId(this.props.idPrefix,n),onClick:this._onClick.bind(this,n),onKeyDown:this._onKeydown,role:"tab","aria-selected":c,"aria-controls":l,tabIndex:u,className:"c-tabs__label"},t.label),o.createElement("li",{key:t.value,className:a,role:"presentation","data-value":t.value},s)},render:function(){var t,e,n,i;return i=this._normalizedTabs(),e=function(){var e,o,s;for(s=[],t=e=0,o=i.length;o>e;t=++e)n=i[t],s.push(this._renderTab(n,t,t===i.length-1));return s}.call(this),o.createElement("ul",{className:"c-tabs__bar",role:"tablist",ref:"tablist"},e)}})})}.call(this),function(){define("modules/clean/react/tabs/tab_nav",["jquery","external/underscore","external/react","modules/clean/react/tabs/tab_bar","modules/clean/react/tabs/tab_util","modules/clean/react/tabs/tabs"],function(t,e,n,o,i,s){var r,a,l,c,u;return a=s.TabContent,u=n.DOM,c=n.addons.classSet,r=n.PropTypes,l=n.createClass({displayName:"TabNav",propTypes:{tabs:r.arrayOf(r.oneOfType([r.string,r.number,r.shape({value:r.oneOfType([r.string,r.number]),label:r.string,rightAlign:r.bool})])),defaultSelectedIndex:r.number,onChange:r.func,idPrefix:r.string,variant:r.string},getDefaultProps:function(){return{defaultSelectedIndex:0,variant:i.variants.DEFAULT,onChange:function(){}}},getInitialState:function(){return{selectedIndex:this.props.defaultSelectedIndex}},componentWillReceiveProps:function(t){return this.props.defaultSelectedIndex!==t.defaultSelectedIndex?this.setState({selectedIndex:t.defaultSelectedIndex}):void 0},_onChange:function(t,e){return this.props.onChange(t,e),this.setState({selectedIndex:e})},render:function(){var t;return t=this.props.idPrefix?this.props.idPrefix:"tabset"+e.uniqueId(),u.div({className:this.props.variant},n.createElement(o,{tabs:this.props.tabs,onChange:this._onChange,idPrefix:t,selectedIndex:this.state.selectedIndex}),n.createElement(a,{isSelected:!0,id:i.getTabContentId(t),tabId:i.getTabId(t,this.state.selectedIndex)},this.props.children))}})})}.call(this),function(){define("modules/clean/react/tabs/tab_util",[],function(){var t;return t={variants:{DEFAULT:"c-tabs",CENTER:"c-tabs c-tabs--center",MINIMAL:"c-tabs c-tabs--minimal",UNDERLINE:"c-tabs--underline"},getTabId:function(t,e){return t+"_tab"+(null!=e?e:"")},getTabContentId:function(t,e){return t+"_tabcontent"+(null!=e?e:"")}}})}.call(this),function(){define("modules/clean/react/tabs/tabs",["jquery","external/underscore","external/react","modules/clean/react/tabs/tab_bar","modules/clean/react/tabs/tab_util","modules/core/browser"],function(t,e,n,o,i,s){var r,a,l,c,u,d;return d=n.DOM,u=n.addons.classSet,r=n.PropTypes,c=n.addons.cloneWithProps,l=n.createClass({displayName:"Tabs",propTypes:{idPrefix:r.string,variant:r.string},getDefaultProps:function(){return{variant:i.variants.DEFAULT,onChange:function(){}}},getInitialState:function(){var t;return t=this.props.idPrefix?this.props.idPrefix:"tabset"+e.uniqueId(),{selectedIndex:0,idPrefix:t}},componentWillMount:function(){var e,o,s;return s=[],o=this.state.selectedIndex,e=this.state.idPrefix,n.Children.forEach(this.props.children,function(t,n){var r;return r=i.getTabContentId(e,n),s.push({label:t.props.title,contentId:r,hashPrefix:t.props.hashPrefix,hashURL:t.props.hashURL,rightAlign:t.props.rightAlign}),t.props.isSelected?o=n:void 0}),this.setState({tabs:s,selectedIndex:o}),t(window).on("hashchange",this._selectTabFromHash)},componentWillUnmount:function(){return t(window).off("hashchange",this._selectTabFromHash)},componentDidMount:function(){return this._selectTabFromHash()},_onChange:function(t,e){var n;return this.setState({selectedIndex:e}),n=this.state.tabs[e],n.hashURL?s.set_hash(n.hashURL):void 0},_selectTabFromHash:function(){var t,e,n,o,i,r,a,l,c;if(t=s.get_hash(),null!=t){for(c=this.state.tabs,a=[],o=i=0,r=c.length;r>i;o=++i){if(l=c[o],e=l.hashPrefix,n=l.hashURL,null!=e&&0===(null!=t?t.indexOf(e):void 0)||t===n){this.setState({selectedIndex:o});break}a.push(void 0)}return a}},render:function(){return d.div({className:this.props.variant},n.createElement(o,{tabs:this.state.tabs,onChange:this._onChange,idPrefix:this.state.idPrefix,selectedIndex:this.state.selectedIndex}),n.Children.map(this.props.children,function(t){return function(e,n){return c(e,{isSelected:n===t.state.selectedIndex,id:i.getTabContentId(t.state.idPrefix,n),tabId:i.getTabId(t.state.idPrefix,n)})}}(this)))}}),a=n.createClass({displayName:"TabContent",propTypes:{id:r.string,isSelected:r.bool,tabId:r.string,hashPrefix:r.string,hashURL:r.string},render:function(){var t;return t={"c-tabs__content":!0,"c-tabs__content--selected":this.props.isSelected},d.div({id:this.props.id,className:u(t),role:"tabpanel","aria-labelledby":this.props.tabId},this.props.children)}}),{Tabs:l,TabContent:a}})}.call(this),function(){define("modules/clean/react/tooltip",["external/react","external/underscore","jquery"],function(t,e,n){var o,i,s,r,a,l,c,u,d,p;return c={TOP:0,BOTTOM:1,LEFT:2,RIGHT:3},d=t.DOM,s="tooltip-holder",o=7,r=1e4,i="data-event-id",u=function(){var t,e;return t=s,e=n("#"+t),e.length||(e=n("<div />").attr({id:t,style:"z-index: "+r}).prependTo("body")),e[0]},l=t.createClass({displayName:"TooltipBubble",propTypes:{position:t.PropTypes.oneOf(function(){var t;t=[];for(p in c)t.push(c[p]);return t}()),tooltip_target_ref:t.PropTypes.object,contents:t.PropTypes.oneOfType([t.PropTypes.element,t.PropTypes.string]),className:t.PropTypes.string,mouse_move_cb:t.PropTypes.func,mouse_out_cb:t.PropTypes.func},_getDimensionsOfElement:function(t){var e,n,o;return n=t.offset(),o=t.outerWidth(),e=t.outerHeight(),{left_x:n.left,right_x:n.left+o,top_y:n.top,bottom_y:n.top+e,width:o,height:e}},render:function(){var t,e,i,s,r;return e=this._getDimensionsOfElement(n(this.props.tooltip_target_ref.getDOMNode())),i=n(window),r=n(window).scrollTop(),s=n(window).scrollLeft(),t=function(){switch(this.props.position){case c.TOP:return{bottom:i.height()-e.top_y+o+r};case c.BOTTOM:return{top:e.bottom_y+o-r};case c.LEFT:return{right:i.width()-e.left_x+o+s};case c.RIGHT:return{left:e.right_x+o-s}}}.call(this),d.div({className:"tooltip-bubble "+(this.props.className||""),ref:"tooltip",style:t,onMouseMove:this.props.mouse_move_cb?this.props.mouse_move_cb:void 0,onMouseLeave:this.props.mouse_out_cb?this.props.mouse_out_cb:void 0},d.div({className:"tooltip-inner"},this.props.contents))},componentDidMount:function(){return this._centerAndShow()},componentDidUpdate:function(){return this._centerAndShow()},_centerAndShow:function(){var t,e,o,i,s,r,a,l,u;return t=n(this.refs.tooltip.getDOMNode()),a=this._getDimensionsOfElement(n(this.props.tooltip_target_ref.getDOMNode())),l=this._getDimensionsOfElement(t),r=n(window).scrollTop(),s=n(window).scrollLeft(),(o=this.props.position)===c.TOP||o===c.BOTTOM?(e=a.left_x+a.width/2-l.width/2-s,t.css("left",e+"px")):((i=this.props.position)===c.LEFT||i===c.RIGHT)&&(u=a.top_y+a.height/2-l.height/2-r,t.css("top",u+"px")),t.show()}}),a=t.createClass({displayName:"Tooltip",propTypes:{position:t.PropTypes.oneOf(function(){var t;t=[];for(p in c)t.push(c[p]);return t}()),tooltip_contents:t.PropTypes.element,tooltip_classname:t.PropTypes.string,hide_delay:t.PropTypes.number,interaction_enabled:t.PropTypes.bool},render:function(){return d.div({className:"tooltip-target",onMouseMove:function(t){return function(e){return t._show(e)}}(this),onMouseLeave:this._on_mouse_leave(),id:this.state.tooltip_id,ref:"tooltipTarget"},this.props.children)},componentDidMount:function(){return n(document).bind("scroll."+this.state.event_id,function(t){return function(e){return t._hide(e)}}(this))},componentDidUpdate:function(){return this.state.visible?this._render_tooltip():void 0},componentWillUnmount:function(){var e;return n(document).unbind("scroll."+this.state.event_id),e=u(),t.unmountComponentAtNode(e)},_on_mouse_leave:function(){return function(t){return function(e){return t.props.hide_delay>0?t._scheduleHide(t.props.hide_delay):t._hide(e)}}(this)},_render_tooltip:function(){var e,o;return o=u(),n("#"+s).css("position","fixed"),n("#"+s).css("left","0"),n("#"+s).css("right","0"),this.props.hide_delay>0&&n("#"+s).attr(i,this.state.event_id),this.props.position===c.TOP?(n("#"+s).css("top","auto"),n("#"+s).css("bottom","0")):(n("#"+s).css("top","0"),n("#"+s).css("bottom","auto")),e=l({position:this.props.position,contents:this.props.tooltip_contents,tooltip_target_ref:this.refs.tooltipTarget,className:this.props.tooltip_classname,mouse_move_cb:this.props.interaction_enabled?this._clear_timeout:void 0,mouse_out_cb:this.props.interaction_enabled?this._on_mouse_leave():void 0}),t.unmountComponentAtNode(o),t.render(e,o)},_show:function(){return!this.state.visible||this._last_timeout?(this._render_tooltip(),this.setState({visible:!0}),this._clear_timeout()):void 0},_hide:function(){var e,o;return this.state.visible?(o=u(),this._last_timeout?(e=n(o).attr(i),e===this.state.event_id&&(t.unmountComponentAtNode(o),null!=this._clear_timeout())):t.unmountComponentAtNode(o),this.setState({visible:!1})):void 0},_scheduleHide:function(t){return this.state.visible?this._last_timeout=setTimeout(this._hide,t):void 0},_clear_timeout:function(){return this._last_timeout?(clearTimeout(this._last_timeout),this._last_timeout=null):void 0},getInitialState:function(){return{visible:!1,event_id:e.uniqueId()}},getDefaultProps:function(){return{interaction_enabled:!1,hide_delay:0}}}),{Tooltip:a,TooltipPosition:c}})}.call(this),function(){define("modules/clean/sticker_util",["modules/constants/stickers"],function(t){var e;return new(e=function(){function e(){}return e.prototype.getStickerImageUrl=function(e){return t.sticker_img_url+"/"+e},e.prototype.getStickerSetImageUrl=function(e){return t.sticker_set_img_url+"/"+e},e.prototype.getStickers=function(){var e,n,o,i,s,r,a,l,c,u,d;if(!this.stickers){for(this.stickers=t.sets,a=this.stickers,e=0,i=a.length;i>e;e++)u=a[e],u.stickers=[];for(l=t.stickers,n=0,s=l.length;s>n;n++)for(d=l[n],c=this.stickers,o=0,r=c.length;r>o;o++)if(u=c[o],d.set_id===u.id){u.stickers.push(d);break}}return this.stickers},e}())})}.call(this),function(){define("modules/constants/comments_panel",[],function(){return window.CommentsPanelConstants})}.call(this),function(){define("modules/constants/stickers",[],function(){return window.StickerConstants})}.call(this),function(){"use strict";var t=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1};define("modules/core/type",["external/underscore"],function(e){var n,o,i,s,r,a,l,c;return r={},r.Type=n=function(){function t(t,n){if(!e.isString(t)&&!e.isFunction(t))throw new TypeError("First parameter needs to be a string identifying the type");if(!e.isFunction(n))throw new TypeError("Second parameter needs to be a predicate defining the type");this.getTypeString=e.isFunction(t)?t:function(){return t},this.predicate=n}return t}(),i=function(t){var o,s;if(c(t))return!0;if(t instanceof n)return!0;if(e.isFunction(t))return!0;if(e.isArray(t)){if(1!==t.length)return!1;if(!i(t[0]))return!1}else{if(!(e.isObject(t)&&null==t.prototype&&t.constructor===Object&&e.keys(t).length>0))return!1;for(o in t)if(s=t[o],!i(s))return!1}return!0},o=function(){var t,o,s,r,a,l,c;return c=new n("undefined",e.isUndefined),o=new n("null",e.isNull),t=new n("Boolean",e.isBoolean),s=new n("Number",e.isNumber),a=new n("String",e.isString),r=new n("Object",function(t){return e.isObject(t)&&!e.isFunction(t)&&!e.isArray(t)}),l=new n("Type",i),function(e){return"undefined"==typeof e?c:null===e?o:e===Boolean?t:e===Number?s:e===String?a:e===Object?r:e===n?l:void 0}}(),r.isBasicType=c=function(t){return null!=o(t)},r.firstFailingKeypath=a=function(i,s,r){var l,u,d,p,h,m,f,_,v,y;if(null==r&&(r=[]),c(i)){if(!o(i).predicate(s))return r}else if(i instanceof n){if(!i.predicate(s))return r}else if(e.isFunction(i)){if(!(s instanceof i))return r}else if(e.isArray(i)){if(a(Array,s,r))return r;for(u=d=0,m=s.length;m>d;u=++d){if(l=s[u],r.push(u),a(i[0],l,r))return r;r.pop()}}else{if(a(Object,s,r))return r;for(y=e.keys(i),_=e.keys(s),h=0,f=_.length;f>h;h++)if(p=_[h],t.call(y,p)<0)return r;for(p in i){if(v=i[p],r.push(p),a(v,s[p],r))return r;r.pop()}}},r.checkType=s=function(t,e){return null==a(t,e)},r.getTypeString=l=function(t){var i,s,r;if(c(t))return o(t).getTypeString();if(t instanceof n)return t.getTypeString();if(e.isFunction(t))return t.name;if(e.isArray(t))return"["+l(t[0])+"]";s=[];for(i in t)r=t[i],s.push(i+": "+l(r));return"{"+s.join(", ")+"}"},r})}.call(this),function(){"use strict";var t=function(t,n){function o(){this.constructor=t}for(var i in n)e.call(n,i)&&(t[i]=n[i]);return o.prototype=n.prototype,t.prototype=new o,t.__super__=n.prototype,t},e={}.hasOwnProperty,n=[].indexOf||function(t){for(var e=0,n=this.length;n>e;e++)if(e in this&&this[e]===t)return e;return-1},o=[].slice;define("modules/core/types",["external/underscore","modules/constants/env","modules/core/type"],function(e,i,s){var r,a,l,c,u,d,p,h,m,f,_,v,y,g,b,w,T,C,S,A;return _=s.Type,v=s.checkType,w=s.getTypeString,b=s.firstFailingKeypath,T=s.isBasicType,h=function(){try{return Boolean(localStorage.production_typechecking)}catch(t){return!1}}(),f=function(e){function n(t){n.__super__.constructor.call(this,w.bind(null,t),v.bind(null,t))}return t(n,e),n}(_),u=function(o){function i(t,n){null!=i.names?i.names.set(this,t):this.__name===t,null!=n&&e.extend(this,n)}t(i,o);try{i.names=new WeakMap}catch(t){i.names=null}return i.prototype.getTypeString=function(){return null!=i.names?i.names.get(this):this.__name},i.prototype.predicate=function(t){return n.call(e.values(this),t)>=0},i}(_),l=function(e){function n(t){this.valType=t}return t(n,e),n.prototype.getTypeString=function(){return"Dict[string -> "+w(this.valType)+"]"},n.prototype.predicate=function(t){var e,n;return function(){var o;o=[];for(e in t)n=t[e],o.push(v(this.valType,n));return o}.call(this).every(function(t){return t})},n}(_),y=function(t,n){var i,s,r,a,l,c,u,d;if(T(t));else if(t instanceof _)null!=t.parameter_types&&e.isFunction(n)&&!n.isTypeChecked&&(n=A.apply(null,o.call(t.parameter_types).concat([n])));else if(e.isFunction(t));else if(e.isArray(t))for(r=a=0,c=n.length;c>a;r=++a)i=n[r],s=y(t[0],i),s!==i&&(n=n.slice(),n[r]=s);else for(l in t)u=t[l],d=y(u,n[l]),d!==n[l]&&(n=e.clone(n),n[l]=d);return n},C=function(t,n,o,i){var s,r,a,l;for(s=0,l=n.length;l>s;s++)r=n[s],i=i[r],o=e.isArray(o)?o[0]:o[r];return n.length>0&&(a=", key "+n.join(".")),a=null!=a?a:"","Argument "+t+a+": Value "+JSON.stringify(i,null,"  ")+" doesn't match type "+w(o)},A=function(){var t,n,i,s;return s=2<=arguments.length?o.call(arguments,0,n=arguments.length-1):(n=0,[]),t=arguments[n++],i=function(){var n,i,r,a,l,c,u,d,p,h,m,_;if(i=1<=arguments.length?o.call(arguments,0):[],n=s,d=e.find(s,function(t){return t instanceof f}),null!=d&&(p=e.indexOf(n,d),h=Math.max(i.length-n.length+1,0),m=[p,1],e.times(h,function(){return m.push(d)}),n=n.slice(),n.splice.apply(n,m)),i.length>n.length)throw new Error("Too many arguments: Supplied "+i.length+" but expected up to "+n.length);for(a=l=0,c=n.length;c>l;a=++l){if(_=n[a],r=b(_,i[a]),null!=r)throw u=C(a,r,_,i[a]),new TypeError(u);i[a]=y(_,i[a])}return t.apply(this,i)},i.isTypeChecked=!0,i},S=function(t,e){var n;return n=function(){var n,i,s,r;if(n=1<=arguments.length?o.call(arguments,0):[],r=e.apply(this,n),i=b(t,r),null!=i)throw s=C(0,i,t,r),new TypeError(s);return r},e.isTypeChecked&&(n.isTypeChecked=!0),n},c=function(t,e){var n,o;return n=function(){return"("+w(t)+"|"+w(e)+")"},o=function(n){return v(t,n)||v(e,n)},new _(n,o)},p=function(t){var e,n,o;return t instanceof _&&t.isOptional||t instanceof f?t:(e=function(){return"?"+w(t)},n=function(e){return null==e||v(t,e)},o=new _(e,n),t instanceof _&&null!=t.parameter_types&&(o.parameter_types=t.parameter_types),o.isOptional=!0,o)},d=function(){var t,n,i,s;return s=1<=arguments.length?o.call(arguments,0):[],t=function(){return"function("+s.map(w).join(", ")+")"},n=e.isFunction,i=new _(t,n),i.parameter_types=s,i},m=function(t){return new f(t)},a=function(t){return new l(t)},g={},g.takes=S(Function,A(m(_),Function,A)),g.returns=S(Function,A(_,Function,S)),g.Type=_,g.Enum=u,g.Dict=S(_,A(_,a)),g.Either=S(_,A(_,_,c)),g.Maybe=S(_,A(_,p)),g.Splat=S(_,A(_,m)),g.Any=r=new _("Any",function(){return!0}),g.Func=S(_,A(m(_),d)),g.inject=S(Object,A(Object,function(t){return e.extend(t,e.omit(g,"inject"))})),i.IS_PROD&&!h&&(g.takes=function(){var t,e,n;return t=2<=arguments.length?o.call(arguments,0,n=arguments.length-1):(n=0,[]),e=arguments[n++]},g.returns=function(){var t,e,n;return t=2<=arguments.length?o.call(arguments,0,n=arguments.length-1):(n=0,[]),e=arguments[n++]}),g})}.call(this),function(){var t=[].slice;define("modules/dirty/react/file_comments/file_viewer_feedback_ui",["jquery","external/react","modules/constants/python","modules/clean/activity/activity","modules/clean/previews/preview_actions_helper","modules/clean/viewer","modules/core/notify","modules/clean/comments/components/file_comments_pane_container","modules/clean/comments/events"],function(e,n,o,i,s,r,a,l,c){var u,d,p,h,m;return u=i.ActivityContext,p=s.LegacyFileViewerActions,h=n.DOM,m=r.get_viewer(),d=n.createClass({displayName:"FileViewerFeedbackUI",propTypes:{shouldShowOnboarding:n.PropTypes.bool},getDefaultProps:function(){return{shouldShowOnboarding:!1}},getInitialState:function(){return this.setCommentsVisibility(!0),{shouldShowOnboarding:this.props.shouldShowOnboarding}},componentDidMount:function(){var t;return c.on("show-comments-pane",this.setShown),c.on("hide-comments-pane",this.setHidden),c.on("switch-revision",this.fluxSwitchRevision),e("#file-viewer").on("db:filepreview:open db:filepreview:fileinfo",function(t){return function(n,o,i,s,r,a,l,c){return e("#file-viewer").addClass("comments"),clearTimeout(t.feedbackLoadTimer),t.feedbackLoadTimer=setTimeout(function(){return t._setFile(o,i,s,!1,c,r,l)},10)}}(this)),e("#file-viewer").trigger("db:commenting:init"),e("#file-viewer").on("db:filepreview:prev db:filepreview:next",function(t){return function(e,n,o,i,s){return clearTimeout(t.feedbackLoadTimer),t.feedbackLoadTimer=setTimeout(function(){return t._setFile(n,o,i,!1,s)},250)}}(this)),e("#file-viewer").on("db:filepreview:close",function(t){return function(){return t.setState({activityContext:null,activityContextData:null})}}(this)),t=function(t){return function(){return e("#file-viewer").addClass("comments"),t.autoResize()}}(this),e("#file-viewer").on("preview_failed",t),e(window).resize(this.autoResize)},componentDidUpdate:function(t,e){return e.isHidden!==this.state.isHidden?this.autoResize():void 0},componentWillUnmount:function(){return c.off("show-comments-pane",this.setShown),c.off("hide-comments-pane",this.setHidden),c.off("switch-revision",this.fluxSwitchRevision)},fluxSwitchRevision:function(t){var e,n;return n=t.revision,e=t.commentActivity,this._switchPreview(n.revision_id,!0,function(){},n.preview_link,e)},setShown:function(){return this.setState({isHidden:!1})},setHidden:function(){return this.setState({isHidden:!0})},_getContextAndContextDataFromFile:function(t,e){var n,i;return e===o.FileViewTargetType.SHARED_LINK?(n=u.SHARED_LINK_VIEW,i=t.href):e===o.FileViewTargetType.SHARED_CONTENT_LINK?(n=u.SHARED_CONTENT_LINK_VIEW,i=t.href):(n=u.BROWSE_FILE_VIEWER,i=t.fq_path),[n,i]},_setFile:function(t,e,n,i,s,r,a){var l,c,d,p;return null==i&&(i=!1),null==s&&(s=[]),null==r&&(r=!1),null==a&&(a=o.OREF_CONSTANTS.BROWSE_UNKNOWN),p=this._getContextAndContextDataFromFile(t,e),l=p[0],c=p[1],l===u.SHARED_LINK_VIEW&&(n=m.work_user||m.personal_user?(m.work_user||m.personal_user).id:void 0),d={activityContext:l,activityContextData:c,file:t,key:t.ns_id+"_"+t.sjid,viewingUserId:n,shouldInitiallyFocusInput:r,oref:a},this.setState(d,this.autoResize)},_switchPreview:function(){var e;return e=1<=arguments.length?t.call(arguments,0):[],require(["dropbox"],function(t){var n;return n=t.FileViewer,n.switch_preview.apply(n,e)},function(){return a.error(a.DEFAULT_ERROR)})},getFileCommentsPaneElement:function(){var t;return null!=(t=this.refs.fluxContainer)?t.refs.fileCommentsPane:void 0},render:function(){return h.div({},n.createElement(l,{ref:"fluxContainer",actorId:this.state.viewingUserId,context:this.state.activityContext,contextData:this.state.activityContextData,currentFile:this.state.file,oref:this.state.oref,previewSelector:"#file-viewer-container .preview .preview-content-container",shouldInitiallyFocusInput:this.state.shouldInitiallyFocusInput,shouldTrackCollapsedState:!0,visible:!0}))},setCommentsVisibility:function(t){return this._commentsVisible=t},autoResize:function(){return this.autoResizeWidth(),this.autoResizeHeight()},autoResizeWidth:function(){var t;return this.setPreviewWidth(e(null!=(t=this.getFileCommentsPaneElement())?t.getDOMNode():void 0).width())},autoResizeHeight:function(){var t,n;return t=e("#file-viewer").hasClass("no-preview")?e(window).height():e("#file-viewer-container").height()-e("#file-viewer-container .title-bar").height(),null!=(n=this.getFileCommentsPaneElement())?n.fitToHeight(t):void 0},setPreviewWidth:function(t){var n,o,i,s,r,a;return n=e("#file-viewer"),o=n.find("#file-viewer-container"),s=o.find(".preview"),0!==s.length?(n.hasClass("no-preview")?(a=o.width()-t,r=t?(e(window).width()-t)/2+"px":e(window).width()/2+"px"):n.hasClass("doc-preview")||n.hasClass("html-preview")||n.hasClass("htmlified-preview")||n.hasClass("adobecs-preview")||n.hasClass("linkfile-preview")||n.hasClass("photo-preview")||n.hasClass("video-preview")?(a=p.isFullscreen()?window.innerWidth:o.width()-t,r="0"):(a=o.width()-t,r="50%"),s.width()!==a&&(s.width(a),i=o.find(".loading"),null!=i&&i.width(a)),s.css("left")!==r?o.css("left",r):void 0):void 0}}),{FileViewerFeedbackUI:d}})}.call(this),function(){define("modules/dirty/react/file_comments/shared_link_feedback_ui",["jquery","external/react","dropbox","modules/clean/comments/components/file_comments_pane_container","modules/clean/comments/events","modules/clean/comments/utils","modules/core/browser"],function(t,e,n,o,i,s,r){var a,l,c;return a=n.FilePreview,c=e.DOM,l=e.createClass({displayName:"SharedLinkFeedbackUI",getInitialState:function(){return{isHidden:!1}},componentDidMount:function(){return i.on("switch-revision",this.fluxSwitchRevision),i.on("show-comments-pane",this.setShown),i.on("hide-comments-pane",this.setHidden),"photo"===this.props["preview-type"]&&(t("#preview-img").on("photo-zoom",this.autoResize),t("#full-img").on("photo-unzoom",this.autoResize)),t(window).resize(this.autoResize),this.autoResize()},componentWillUnmount:function(){return i.off("switch-revision",this.fluxSwitchRevision),i.off("show-comments-pane",this.setShown),i.off("hide-comments-pane",this.setHidden)},componentDidUpdate:function(t,e){return e.isHidden!==this.state.isHidden?this.autoResize():void 0},getFileCommentsPaneElement:function(){var t;return null!=(t=this.refs.fluxContainer)?t.refs.fileCommentsPane:void 0},setShown:function(){return this.setState({isHidden:!1})},setHidden:function(){return this.setState({isHidden:!0})},fluxSwitchRevision:function(t){var e,n;return n=t.revision,e=t.commentActivity,a.switch_preview(n.revision_id,!0,function(){},n.preview_link,e)},render:function(){return c.div({className:"shmodel-comments"},e.createElement(o,{ref:"fluxContainer",actorId:s.getActivityUser().id,context:this.props["activity-context"],contextData:r.get_href(),currentFile:{preview_type:this.props["preview-type"]},previewSelector:this.previewSelector(),shouldInitiallyFocusInput:!1,visible:!0,initialCommentsCount:this.props["comments-count"],shouldTrackCollapsedState:!0}))},autoResize:function(){return this.autoResizeWidth(),this.autoResizeHeight()},autoResizeWidth:function(){var e,n,o;return e=t(null!=(o=this.getFileCommentsPaneElement())?o.getDOMNode():void 0),n=e.visible()?e.outerWidth():0,this.setPreviewWidth(n)},autoResizeHeight:function(){var e,n,o;return n=parseInt(t("#file-comments").css("top")),o=t(window).height(),e=o-n},setPreviewWidth:function(e){var n,o,i;return null!=this.previewSelector()&&(n=t(this.previewSelector()),0!==n.length)?(n.data("rams-fullscreen")?o=t(window).width():(i=n.outerWidth()-n.width(),o=t(window).width()-e-i),n.width()!==o?n.width(o):void 0):void 0},previewSelector:function(){return null==this.props["preview-type"]?"#shmodel-content-area #default-content":{doc:"#shmodel-content-area .preview-box #pdf-embed-container",photo:"#shmodel-content-area .preview-box",video:"#shmodel-content-area .preview-box",text:"#shmodel-content-area #htmlified-wrapper",html:"#shmodel-content-area",download:"#shmodel-content-area",excel:"#shmodel-content-area #html-container",adobecs:"#shmodel-content-area .preview-box #pdf-embed-container",linkfile:"#shmodel-content-area .preview-box",audio:"#shmodel-content-area .preview-box"}[this.props["preview-type"]]}}),{SharedLinkFeedbackUI:l}})}.call(this);