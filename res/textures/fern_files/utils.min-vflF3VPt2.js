(function(){var e=[].indexOf||function(e){for(var n=0,t=this.length;t>n;n++)if(n in this&&this[n]===e)return n;return-1};define(["external/underscore","modules/clean/ajax","modules/clean/react/pass/event_bus_queue","modules/core/exception","modules/clean/viewer"],function(n,t,u,s,r){var i,a;return i={PRESENCE_STATES:{OFFLINE:"offline",VIEWER:"viewer",MODIFIER:"modifier",IDLE:"idle"},_eventBusQueue:null,_queueInfo:null,_isOnline:function(t){return s.assert(e.call(n.values(this.PRESENCE_STATES),t)>=0,"Status "+t+" is invalid."),t===this.PRESENCE_STATES.VIEWER||t===this.PRESENCE_STATES.MODIFIER||t===this.PRESENCE_STATES.IDLE},_parsePresenceData:function(n){var t,u,s,i,a,l;for(i=[],s=[],t=0,u=n.length;u>t;t++)a=n[t],l=a.user_id,e.call(r.get_viewer().get_user_ids(),l)<0&&(this._isOnline(a.status)&&e.call(i,l)<0?i.push(l):!this._isOnline(a.status)&&e.call(s,l)<0&&s.push(l));return{onlineUsers:i,offlineUsers:s}},shutdownPresence:function(){return null!=this._eventBusQueue?(this._eventBusQueue.end(),delete this._eventBusQueue,delete this._queueInfo):void 0},updatePresence:function(e,n,s,r,i,a){return t.AuthenticatedRequest({url:"/update_presence/update_web_presence",dataType:"json",data:{ns_id:e,ns_path:n,status:r,queue_id:null!=this._queueInfo?this._queueInfo.queue_id:null},success:function(t){return function(l){var _;return(null==t._queueInfo||t._queueInfo.queue_id===!l.bolt_data.queue_id)&&(t.shutdownPresence(),t._eventBusQueue=new u(l.bolt_data),t._eventBusQueue.start(),t._eventBusQueue.on("events",function(u){var s;return s=t._parsePresenceData(u),"function"==typeof i?i(e,n,s.onlineUsers,s.offlineUsers):void 0}),t._eventBusQueue.on("error",function(u){return 403===u?(t.shutdownPresence(),t.updatePresence(e,n,s,r,i,a)):void 0}),t._queueInfo=l.bolt_data),t._isOnline(r)?(_=t._parsePresenceData(l.presence_data),"function"==typeof i?i(e,n,_.onlineUsers,_.offlineUsers):void 0):void 0}}(this),subject_user:s,async:a})}},a={filterSeenStates:function(n,t){var u,s,r,i,a,l,_;for(u=[],a={},s=0,r=n.length;r>s;s++)_=n[s],l=_.seen_activity_user,null==_.when_last_seen||(i=l.id,e.call(t.get_user_ids(),i)>=0)||l.paired_user_id in a||(u.push(_),a[l.id]=!0);return u},orderSeenStates:function(n,t){return n.sort(function(n,u){var s,r;if(null!=t){if(s=n.seen_activity_user.id,e.call(t,s)>=0)return-1;if(r=u.seen_activity_user.id,e.call(t,r)>=0)return 1}return n.when_last_seen>u.when_last_seen?-1:1}),n}},{PresenceHelpers:i,SeenStateHelpers:a}})}).call(this);