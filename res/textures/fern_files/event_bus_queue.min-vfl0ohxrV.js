(function(){var t=function(t,e){return function(){return t.apply(e,arguments)}},e=function(t,e){function s(){this.constructor=t}for(var n in e)o.call(e,n)&&(t[n]=e[n]);return s.prototype=e.prototype,t.prototype=new s,t.__super__=e.prototype,t},o={}.hasOwnProperty;define(["jquery","external/underscore","modules/clean/event_emitter","modules/constants/env","modules/core/uri"],function(o,s,n,r,i){var l,h;return l=function(){function e(e,o){this.getDelay=t(this.getDelay,this),this.fail=t(this.fail,this),this.reset=t(this.reset,this),this.numberOfRetries=0,this.slotTime=e,this.maxExponent=Math.floor(Math.log(o/this.slotTime)/Math.log(2))}return e.prototype.reset=function(){return this.numberOfRetries=0},e.prototype.fail=function(){return this.numberOfRetries+=1},e.prototype.getDelay=function(){var t,e;return e=Math.min(Math.floor(this.numberOfRetries*Math.sqrt(this.numberOfRetries)),this.maxExponent),t=Math.floor(Math.random()*Math.pow(2,e))*this.slotTime},e}(),h=function(n){function h(e){this._handlePollError=t(this._handlePollError,this),this._handlePollSuccess=t(this._handlePollSuccess,this),this._longPoll=t(this._longPoll,this),h.__super__.constructor.call(this),this.queueInfo=e,this.host=r.BOLT_SERVER,this.backoff=new l(100,3e5),this.lastEventId="-1"}return e(h,n),h.prototype.start=function(){return this._started?void 0:(this._started=!0,this._longPoll())},h.prototype.end=function(){return this._started=!1,null!=this._longPollXhr?this._longPollXhr.abort():s.defer(function(t){return function(){return t.emit("close")}}(this))},h.prototype._longPoll=function(){var t,e,s,n;if(this._started)return s=this.queueInfo.queue_id,n=this.queueInfo.queue_token,e=window.btoa(s+":"+n),t=i({scheme:"https",authority:this.host,path:"/api/v1/events"}),this._longPollXhr=o.ajax({contentType:"application/json",url:t.toString(),type:"POST",processData:!1,noDropboxDefaults:!0,data:JSON.stringify({last_event_id:this.lastEventId}),timeout:6e4,beforeSend:function(t){return t.setRequestHeader("HTTP-X-EVENTQUEUE-AUTHORIZATION","Basic "+e)},success:this._handlePollSuccess,error:this._handlePollError})},h.prototype._handlePollSuccess=function(t){return t=JSON.parse(t),this._longPollXhr=null,"success"===t.result&&null!=t.events&&t.events.length>0?(this.emit("poll"),this.backoff.reset(),s.defer(this._longPoll),this.lastEventId=t.events[t.events.length-1].id,"heartbeat"!==t.events[0].type?this.emit("events",t.events):void 0):(console.warn("EventBusQueue: longpoll error:",t),this.backoff.fail(),window.setTimeout(this._longPoll,this.backoff.getDelay()))},h.prototype._handlePollError=function(t,e){return this._longPollXhr=null,this._started?t.status>=400&&t.status<500?(this.emit("error",t.status),this.emit("close",!0)):(console.warn("EventBusQueue: longpoll error:",e,t.status),this.backoff.fail(),window.setTimeout(this._longPoll,this.backoff.getDelay())):this.emit("close",!1)},h}(n)})}).call(this);